<html>
	<head>
		<!--script type="text/javascript" src="sce.js"></script-->
		<script type 	= "text/javascript" src="../../glge-compiled.js"></script> <!--Incluindo o motor GLGE-->
	
		<script>
(function(GLGE){
	GLGE.AudioSources 		= [];
	GLGE.AudioContext 		= new webkitAudioContext();
	GLGE.AudioListener 		= null;
	
	GLGE.AudioIR 			= [];
	GLGE.AudioLoading 		= []; //waiting load audio files IR
	
	GLGE.AudioIR_HALL 		= 0;
	GLGE.AudioIR_TELEPHONE 	= 1;
	GLGE.AudioIR_ECHO 		= 2;
	
	
	GLGE.Audio3D=function(uid){
		this.source;	
		this.panner;
		this.convolver;
		this.convolverGain;
		this.plainGain;
		this.x						= 0;
		this.y						= 0;
		this.z						= 0;
		this.bufferList				= [];
		this.fileList				= [];
		
		this.stoped					= false;
		this.currentIndexSource		= 0;
		this.currentIndexEffect		= -1;
		
		
		GLGE.Group.call(this);
		GLGE.Assets.registerAsset(this,uid);
	}

	GLGE.Audio3D.prototype.setLocX = function (a){this.x =a;}
	GLGE.Audio3D.prototype.setLocY = function (a){this.y =a;}
	GLGE.Audio3D.prototype.setLocZ = function (a){this.z =a;}

	GLGE.Audio3D.prototype.setAudioSource = function(i) 
	{		
		this.currentIndexSource = i;
		
		if (!this.bufferList[i])
		{
			var url = this.fileList[i];

			var request = new XMLHttpRequest();
			request.open("GET", url, true);
			request.responseType = "arraybuffer";
			var som = this;
			request.onload = function() { 
				
				var buffer = GLGE.AudioContext.createBuffer(request.response, true);
				som.bufferList[i] = buffer; 
			};
		
			request.send("");
		}
	}
	GLGE.Audio3D.setAudiosourceIR = function(url) 
	{
		var request = new XMLHttpRequest();
		request.open("GET", url, true);
		request.responseType = "arraybuffer";
		
		request.onload = function() { 
			var buffer = GLGE.AudioContext.createBuffer(request.response, true);
			GLGE.AudioIR.push(buffer);
		};
		request.send("");
	
	}
	GLGE.Audio3D.loadIR = function()
	{
		var path = ["ir/big_hall.ogg","ir/filter-telephone.wav","ir/cosmic-ping-longdrive.wav"];
		
		for(var i =0;i<2;i++)
			GLGE.Audio3D.setAudiosourceIR(path[i]);
		
	}
	GLGE.Audio3D.prototype.setFiles = function(paths)
	{
		for(var i in paths)
			this.fileList.push(paths[i]);
	} 
	GLGE.Audio3D.prototype.setEffect = function(id)
	{
		this.currentIndexEffect	= id;
		if(id >= 0)
		{
			if(GLGE.AudioIR[id] != null)
				this.convolver.buffer = GLGE.AudioIR[id];
			else
			{
				GLGE.AudioLoading.push({obj:this,id:id});
			}
		}else
			this.convolver.buffer = null;
		
	} 
	GLGE.Audio3D.prototype.createSound = function()
	{
		// Initialize audio
		this.source 	= GLGE.AudioContext.createBufferSource();
		this.panner 	= GLGE.AudioContext.createPanner();
		this.convolver	= GLGE.AudioContext.createConvolver();
		
		this.plainGain = GLGE.AudioContext.createGainNode();
		this.convolverGain = GLGE.AudioContext.createGainNode();
		
		this.plainGain.gain.value = 0;
    	this.convolverGain.gain.value = 2.0;
    	
    	this.source.connect(this.plainGain);
    	this.plainGain.connect(this.panner);
    	this.panner.connect(GLGE.AudioContext.destination);
    
    	this.source.connect(this.convolver);
    	this.convolver.connect(this.convolverGain);
    	this.convolverGain.connect(this.panner);
    	this.panner.connect(GLGE.AudioContext.destination);
    	
    	
	}
	GLGE.Audio3D.prototype.initSource = function(obj) 
	{

		this.createSound(); //init sound

		this.bufferList = new Array(this.fileList.length);
		for (var i = 0; i < this.bufferList.lenght; i++) {
			bufferList[i] = 0;
		}
		
		this.setAudioSource(0); //default : load the first sound in the list
		
		GLGE.AudioSources.push({obj:obj,Source:this});
	 }
	 
	 GLGE.Audio3D.prototype.play = function(loop)
	 {
	 	if(loop)
	 		this.source.loop = true;
	 	else
	 		this.source.loop = false;
	 		
	 	if(this.stoped)
	 	{
	 		this.createSound();
	 		this.setEffect(this.currentIndexEffect);	
	 	}
	 	this.source.buffer = this.bufferList[this.currentIndexSource];	
	 	this.source.noteOn(0);
	 }
	 GLGE.Audio3D.prototype.stop = function()
	 {
	 	this.stoped = true;
	 	this.source.noteOff(0);
	 }
	 
	 GLGE.Audio3D.initListener = function(obj) {

		GLGE.AudioContext.listener.coneOuterGain = 0;
		GLGE.AudioContext.listener.coneOuterAngle = 90;
		GLGE.AudioContext.listener.coneInnerAngle = 10;
		GLGE.AudioListener = obj;
	 }
	 GLGE.Audio3D.RefreshPositions = function()
	 {
		for(var i in GLGE.AudioSources)
		{
			var obj = GLGE.AudioSources[i].obj;
			GLGE.AudioSources[i].Source.panner.setPosition(obj.getLocX(),obj.getLocY(),obj.getLocZ());
		}
		var obj = GLGE.AudioListener.getPosition();
		GLGE.AudioContext.listener.setPosition(obj.x,obj.y,obj.z);
		obj = GLGE.AudioListener.getRotation();
		var x = (((obj.x%6.28)*360)/6.28);
		var y = (((obj.y%6.28)*360)/6.28);
		var z = (((obj.z%6.28)*360)/6.28);
		
		/*if(x >360)
			x =x%360;
		if(y >360)
			y =y%360 - 360;
		if(z >360)
			z =z%360 - 360;	
		if(x < -360)
			x =x%360 + 360;
		if(y < -360)
			y =y%360 + 360;
		if(z < -360)
			z =z%360 + 360;		
		*/
		obj = GLGE.AudioListener.getUpAxis();
		//GLGE.AudioContext.listener.setOrientation(x,y,z,obj[0],obj[1],obj[2]);
		//document.getElementById("debug").innerHTML=y;
	 }
	 GLGE.Audio3D.Loading =setInterval(function() 
	 {
		for(var i in GLGE.AudioLoading)
		{
			if(GLGE.AudioIR[GLGE.AudioLoading[i].id] != null)
			{
				GLGE.AudioLoading[i].obj.convolver.buffer = GLGE.AudioIR[GLGE.AudioLoading[i].id];
				GLGE.AudioLoading.splice(i,1);
			}
		}
	 },100);
	 
	 GLGE.Audio3D.prototype.setVolumeMain = function(a)
	 {
	 	this.plainGain.gain.value = a;
	 }
	 GLGE.Audio3D.prototype.setVolumeEffect = function(a)
	 {
	 	this.convolverGain.gain.value = a;
	 }
	
})(GLGE);


		
			var doc 		= new GLGE.Document();
			var mundo;
			var box;
			var car;
			var som = new GLGE.Audio3D("som");
			function debug(a)
			{
				document.getElementById("debug").innerHTML = a;
			}
			
			doc.onLoad = function()
			{
			//create the renderer
				var gameRenderer=new GLGE.Renderer(document.getElementById('canvas'));
				gameScene=new GLGE.Scene();
				gameScene=doc.getElement("mainscene");
				gameRenderer.setScene(gameScene);
	

				var mouse=new GLGE.MouseInput(document.getElementById('canvas'));
				var keys=new GLGE.KeyInput();
				var mouseovercanvas;
				var hoverobj;
				
				var camera 	= doc.getElement("MCamera");
				var duckSource = doc.getElement("duck");
				
				var lookAt=function(origin,point,up){
					if(!up) up=[0,1,0];
					var coord=[origin[0]-point[0],origin[1]-point[1],origin[2]-point[2]];
					var zvec=GLGE.toUnitVec3(coord);
					var xvec=GLGE.toUnitVec3(GLGE.crossVec3(up,zvec));
					var yvec=GLGE.toUnitVec3(GLGE.crossVec3(zvec,xvec));		
					return [xvec[0], yvec[0], zvec[0], 0,
									xvec[1], yvec[1], zvec[1], 0,
									xvec[2], yvec[2], zvec[2], 0,
									0, 0, 0, 1];
				}
				
				
				
				function InitSound()
				{
					GLGE.Audio3D.loadIR(); // Load Impulse Response(IR) files
					GLGE.Audio3D.initListener(camera);

					som.setFiles(["holdin_back.ogg"]);//set audio files
					
					som.initSource(duckSource);
					som.setEffect(0);
					
					
				}
				InitSound();
				
				function mouselook(){
					if(mouseovercanvas){
						var mousepos=mouse.getMousePosition();
						mousepos.x=mousepos.x-document.getElementById("container").offsetLeft;
						mousepos.y=mousepos.y-document.getElementById("container").offsetTop;
						var camera=gameScene.camera;
						camerarot=camera.getRotation();
						inc=(mousepos.y-(document.getElementById('canvas').offsetHeight/2))/500;
				//		var trans=camera.getRotMatrix().x([0,0,-1,1]);
						var trans=GLGE.mulMat4Vec4(camera.getRotMatrix(),[0,0,-1,1]);
						var mag=Math.pow(Math.pow(trans[0],2)+Math.pow(trans[1],2),0.5);
						trans[0]=trans[0]/mag;
						trans[1]=trans[1]/mag;
						camera.setRotX(1.56-trans[1]*inc);
						camera.setRotZ(-trans[0]*inc);
						var width=document.getElementById('canvas').offsetWidth;
						if(mousepos.x<width*0.3){
							var turn=Math.pow((mousepos.x-width*0.3)/(width*0.3),2)*0.005*(now-lasttime);
							camera.setRotY(camerarot.y+turn);
						}
						if(mousepos.x>width*0.7){
							var turn=Math.pow((mousepos.x-width*0.7)/(width*0.3),2)*0.005*(now-lasttime);
							camera.setRotY(camerarot.y-turn);
						}
					}
				}

				function checkkeys(){
					var camera=gameScene.camera;
					camerapos=camera.getPosition();
					camerarot=camera.getRotation();
					var mat=camera.getRotMatrix();
				//	var trans=mat.x([0,0,-1]);
					var trans=GLGE.mulMat4Vec4(mat,[0,0,-1,1]);
					var mag=Math.pow(Math.pow(trans[0],2)+Math.pow(trans[1],2),0.5);
					trans[0]=trans[0]/mag;
					trans[1]=trans[1]/mag;
					var yinc=0;
					var xinc=0;
					if(keys.isKeyPressed(GLGE.KI_M)) {addduck();}
					if(keys.isKeyPressed(GLGE.KI_W)) {yinc=yinc+parseFloat(trans[1]);xinc=xinc+parseFloat(trans[0]);}
					if(keys.isKeyPressed(GLGE.KI_S)) {yinc=yinc-parseFloat(trans[1]);xinc=xinc-parseFloat(trans[0]);}
					if(keys.isKeyPressed(GLGE.KI_A)) {yinc=yinc+parseFloat(trans[0]);xinc=xinc-parseFloat(trans[1]);}
					if(keys.isKeyPressed(GLGE.KI_D)) {yinc=yinc-parseFloat(trans[0]);xinc=xinc+parseFloat(trans[1]);}
					if(keys.isKeyPressed(GLGE.KI_LEFT_ARROW)) {camera.setRotZ(0.5);}
					if(levelmap.getHeightAt(camerapos.x+xinc,camerapos.y)>30) xinc=0;
					if(levelmap.getHeightAt(camerapos.x,camerapos.y+yinc)>30) yinc=0;
					if(levelmap.getHeightAt(camerapos.x+xinc,camerapos.y+yinc)>30){yinc=0;xinc=0;}
						else{
						camera.setLocZ(levelmap.getHeightAt(camerapos.x+xinc,camerapos.y+yinc)+8);
						}
					if(xinc!=0 || yinc!=0){
						camera.setLocY(camerapos.y+yinc*0.05*(now-lasttime));camera.setLocX(camerapos.x+xinc*0.05*(now-lasttime));
					}
				}

				levelmap=new GLGE.HeightMap("images/map.png",120,120,-50,50,-50,50,0,50);


				var lasttime=0;
				var frameratebuffer=60;
				start=parseInt(new Date().getTime());
				var now;
				function Render(){
					now=parseInt(new Date().getTime());
						frameratebuffer=Math.round(((frameratebuffer*9)+1000/(now-lasttime))/10);
						
				   mouselook();
				   checkkeys();
				   gameRenderer.render();
				   lasttime=now;

				   requestAnimationFrame(Render);
				}
				Render();
				var inc=0.2;
				document.getElementById("canvas").onmouseover=function(e){mouseovercanvas=true;}
				document.getElementById("canvas").onmouseout=function(e){mouseovercanvas=false;}
			}
			setInterval(GLGE.Audio3D.RefreshPositions,100);
			doc.load("cena.xml");
			
			var select=function(a){
				som.setEffect(a.options[a.selectedIndex].value);
			}
			
		</script>
	
	</head>
	<body>
		<div id="dump"></div>

<div>
	<div style="width:900px;margin:auto;position:relative" id="container">
		<canvas id="canvas" width="900" height="500"></canvas>
		<img src="images/glgelogo.png" alt="GLGElogo" style="position:absolute;top: 450px; left: 750px;" />
		<div id="debug" style="padding: 5px"></div>
		<a href="http://freeplaymusic.com/search/category_search.php?t=f&i=10">Music(freeplaymusic.com)</a>
		<p>WebAudio: work chrome and safari</p>
		<select id="select" onchange="select(this);">
		  <option value="0" >Hall</option>
		  <option value="1">Telephone</option>
		  <option value="2">Echo</option>
		   <option value="-1">NONE</option>
		</select>
		<a onclick="som.stop()">Stop</a>
		<a onclick="som.play()">Play</a>
	</div>

</div>
	</body>
</html>
