typeof GLGE=="undefined"&&(GLGE={}),function(a){function b(){var b=a.Vec([1,2,3,4]),c=a.Vec4(a.getVec4(b,3),a.get1basedVec4(b,3),a.getVec4(b,1),a.getVec4(b,0)),d=a.identMatrix(),e=a.mulMat4Vec4(d,c);if(a.getVec4(e,0)!=4||a.getVec4(e,1)!=3||a.getVec4(e,2)!=2||a.getVec4(e,3)!=1)throw"Unit Test 1 failed MatVecMul "+e;var f=a.Mat4([3,4,5,0,.5,.75,0,0,.75,.5,0,0,.25,.25,1,1]),g=a.Mat4([2,1,8,2,1,4,3,2,1,.5,6.5,2,8,3,1,.25]),h=a.mulMat4(f,g),i=a.Mat4([15,21.5,68.5,24,1.75,3.5,6.25,2.5,2,2.75,7.5,2.5,9.75,4.75,10.25,3.25]);for(var j=0;j<4;++j)for(var k=0;k<4;++k){var l=a.getMat4(h,j,k)-a.getMat4(i,j,k);if(l>=1e-6||l<=-1e-6)throw"Unit Test 1 failed Multiplication "+a.getMat4(h,j,k)+" != "+a.getMat4(i,j,k)}var m=a.inverseMat4(f),n=a.mulMat4(f,m),o=a.mulMat4(m,f);for(var j=0;j<4;++j)for(var k=0;k<4;++k){var l=a.getMat4(n,j,k)-a.getMat4(d,j,k);if(l>=1e-4||l<=-1e-4)throw"Unit Test 1 failed Inverse "+a.getMat4(n,j,k)+" != "+a.getMat4(d,j,k)}}a.Vec=function(a){return a.slice(0)},a.Vec3=function(a,b,c){return[a,b,c]},a.Vec4=function(a,b,c,d){return[a,b,c,d]},a.get1basedVec4=function(a,b){return a[b-1]},a.get1basedVec3=function(a,b){return a[b-1]},a.getVec4=function(a,b){return a[b]},a.getVec3=function(a,b){return a[b]},a.addVec4=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]},a.addVec3=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},a.subVec4=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]},a.subVec3=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},a.dotVec3=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},a.dotVec4=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},a.scaleVec4=function(a,b){return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]},a.scaleVec3=function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},a.crossVec3=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},a.toUnitVec3=function(a){var b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2],c=1;b>0&&(c=Math.pow(b,.5));return[a[0]/c,a[1]/c,a[2]/c]},a.toUnitVec4=function(a){var b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3],c=1;b>0&&(c=Math.pow(b,.5));return[a[0]/c,a[1]/c,a[2]/c,a[3]/c]},a.lengthVec3=function(a){return Math.pow(a[0]*a[0]+a[1]*a[1]+a[2]*a[2],.5)},a.distanceVec3=function(b,c){return a.lengthVec3(a.subVec3(b,c))},a.lengthVec4=function(a,b){return Math.pow(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3],.5)},a.distanceVec4=function(b,c){return a.lengthVec4(a.subVec4(b,c))},a.angleVec3=function(b,c){b=a.toUnitVec3(b),c=a.toUnitVec3(c),d=a.dotVec3(b,c),d<-1&&(d=-1),d>1&&(d=1);return Math.acos(d)},a.angleVec4=function(b,c){b=a.toUnitVec4(b),c=a.toUnitVec4(c),d=a.dotVec4(b,c),d<-1&&(d=-1),d>1&&(d=1);return Math.acos(d)},GLGE_math_use_webgl_float=!1,a.Mat3=GLGE_math_use_webgl_float?function(a){if(a.length==9)return new Float32Array(a);if(a.length==16)return new Float32Array([a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]);throw"invalid matrix length"}:function(a){var b;if(a.length==9)b=a.slice(0);else if(a.length==16)b=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];else throw"invalid matrix length";b.get=function(a){return this[a]};return b},a.Mat=GLGE_math_use_webgl_float?function(a){return new Float32Array(a)}:function(a){var b=a.slice(0);b.get=function(a){return this[a]};return b},a.Mat4=function(a){var b;if(a.length==9)b=[a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1];else if(a.length==16)b=a.slice(0);else throw"invalid matrix length";b.get=function(a){return this[a]};return b},a.determinantMat4=function(a){return a[12]*a[9]*a[6]*a[3]-a[8]*a[13]*a[6]*a[3]-a[12]*a[5]*a[10]*a[3]+a[4]*a[13]*a[10]*a[3]+a[8]*a[5]*a[14]*a[3]-a[4]*a[9]*a[14]*a[3]-a[12]*a[9]*a[2]*a[7]+a[8]*a[13]*a[2]*a[7]+a[12]*a[1]*a[10]*a[7]-a[0]*a[13]*a[10]*a[7]-a[8]*a[1]*a[14]*a[7]+a[0]*a[9]*a[14]*a[7]+a[12]*a[5]*a[2]*a[11]-a[4]*a[13]*a[2]*a[11]-a[12]*a[1]*a[6]*a[11]+a[0]*a[13]*a[6]*a[11]+a[4]*a[1]*a[14]*a[11]-a[0]*a[5]*a[14]*a[11]-a[8]*a[5]*a[2]*a[15]+a[4]*a[9]*a[2]*a[15]+a[8]*a[1]*a[6]*a[15]-a[0]*a[9]*a[6]*a[15]-a[4]*a[1]*a[10]*a[15]+a[0]*a[5]*a[10]*a[15]},a.inverseMat4=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q;return[(k*p*i-o*l*i+o*h*m-g*p*m-k*h*q+g*l*q)/r,(o*l*e-k*p*e-o*d*m+c*p*m+k*d*q-c*l*q)/r,(g*p*e-o*h*e+o*d*i-c*p*i-g*d*q+c*h*q)/r,(k*h*e-g*l*e-k*d*i+c*l*i+g*d*m-c*h*m)/r,(n*l*i-j*p*i-n*h*m+f*p*m+j*h*q-f*l*q)/r,(j*p*e-n*l*e+n*d*m-b*p*m-j*d*q+b*l*q)/r,(n*h*e-f*p*e-n*d*i+b*p*i+f*d*q-b*h*q)/r,(f*l*e-j*h*e+j*d*i-b*l*i-f*d*m+b*h*m)/r,(j*o*i-n*k*i+n*g*m-f*o*m-j*g*q+f*k*q)/r,(n*k*e-j*o*e-n*c*m+b*o*m+j*c*q-b*k*q)/r,(f*o*e-n*g*e+n*c*i-b*o*i-f*c*q+b*g*q)/r,(j*g*e-f*k*e-j*c*i+b*k*i+f*c*m-b*g*m)/r,(n*k*h-j*o*h-n*g*l+f*o*l+j*g*p-f*k*p)/r,(j*o*d-n*k*d+n*c*l-b*o*l-j*c*p+b*k*p)/r,(n*g*d-f*o*d-n*c*h+b*o*h+f*c*p-b*g*p)/r,(f*k*d-j*g*d+j*c*h-b*k*h-f*c*l+b*g*l)/r]},a.mulMat4Vec4=function(b,c){return a.Vec4(b[0]*c[0]+b[1]*c[1]+b[2]*c[2]+b[3]*c[3],b[4]*c[0]+b[5]*c[1]+b[6]*c[2]+b[7]*c[3],b[8]*c[0]+b[9]*c[1]+b[10]*c[2]+b[11]*c[3],b[12]*c[0]+b[13]*c[1]+b[14]*c[2]+b[15]*c[3])},a.scaleMat4=function(b,c){return a.Mat([b[0]*c,b[1]*c,b[2]*c,b[3]*c,b[4]*c,b[5]*c,b[6]*c,b[7]*c,b[8]*c,b[9]*c,b[10]*c,b[11]*c,b[12]*c,b[13]*c,b[14]*c,b[15]*c])},a.scaleInPlaceMat4=function(a,b){a.set(0,a[0]*b),a.set(1,a[1]*b),a.set(2,a[2]*b),a.set(3,a[3]*b),a.set(4,a[4]*b),a.set(5,a[5]*b),a.set(6,a[6]*b),a.set(7,a[7]*b),a.set(8,a[8]*b),a.set(9,a[9]*b),a.set(10,a[10]*b),a.set(11,a[11]*b),a.set(12,a[12]*b),a.set(13,a[13]*b),a.set(14,a[14]*b),a.set(15,a[15]*b);return a},a.addInPlaceMat4=function(a,b){a.set(0,a[0]+b[0]),a.set(1,a[1]+b[1]),a.set(2,a[2]+b[2]),a.set(3,a[3]+b[3]),a.set(4,a[4]+b[4]),a.set(5,a[5]+b[5]),a.set(6,a[6]+b[6]),a.set(7,a[7]+b[7]),a.set(8,a[8]+b[8]),a.set(9,a[9]+b[9]),a.set(10,a[10]+b[10]),a.set(11,a[11]+b[11]),a.set(12,a[12]+b[12]),a.set(13,a[13]+b[13]),a.set(14,a[14]+b[14]),a.set(15,a[15]+b[15]);return a},a.addMat4=function(b,c){return a.Mat([b[0]+c[0],b[1]+c[1],b[2]+c[2],b[3]+c[3],b[4]+c[4],b[5]+c[5],b[6]+c[6],b[7]+c[7],b[8]+c[8],b[9]+c[9],b[10]+c[10],b[11]+c[11],b[12]+c[12],b[13]+c[13],b[14]+c[14],b[15]+c[15]])},a.subInPlaceMat4=function(a,b){a.set(0,a[0]-b[0]),a.set(1,a[1]-b[1]),a.set(2,a[2]-b[2]),a.set(3,a[3]-b[3]),a.set(4,a[4]-b[4]),a.set(5,a[5]-b[5]),a.set(6,a[6]-b[6]),a.set(7,a[7]-b[7]),a.set(8,a[8]-b[8]),a.set(9,a[9]-b[9]),a.set(10,a[10]-b[10]),a.set(11,a[11]-b[11]),a.set(12,a[12]-b[12]),a.set(13,a[13]-b[13]),a.set(14,a[14]-b[14]),a.set(15,a[15]-b[15]);return a},a.subMat4=function(b,c){return a.Mat([b[0]-c[0],b[1]-c[1],b[2]-c[2],b[3]-c[3],b[4]-c[4],b[5]-c[5],b[6]-c[6],b[7]-c[7],b[8]-c[8],b[9]-c[9],b[10]-c[10],b[11]-c[11],b[12]-c[12],b[13]-c[13],b[14]-c[14],b[15]-c[15]])},a.mulMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=a[0],t=a[1],u=a[2],v=a[3],w=a[4],x=a[5],y=a[6],z=a[7],A=a[8],B=a[9],C=a[10],D=a[11],E=a[12],F=a[13],G=a[14],H=a[15];return[s*c+t*g+u*k+v*o,s*d+t*h+u*l+v*p,s*e+t*i+u*m+v*q,s*f+t*j+u*n+v*r,w*c+x*g+y*k+z*o,w*d+x*h+y*l+z*p,w*e+x*i+y*m+z*q,w*f+x*j+y*n+z*r,A*c+B*g+C*k+D*o,A*d+B*h+C*l+D*p,A*e+B*i+C*m+D*q,A*f+B*j+C*n+D*r,E*c+F*g+G*k+H*o,E*d+F*h+G*l+H*p,E*e+F*i+G*m+H*q,E*f+F*j+G*n+H*r]},a.transposeInPlaceMat4=function(a){var b=a[1];a.set(1,a[4]),a.set(4,b),b=a[8],a.set(8,a[2]),a.set(2,b),b=a[3],a.set(3,a[12]),a.set(12,b),b=a[9],a.set(9,a[6]),a.set(6,b),b=a[13],a.set(13,a[7]),a.set(7,b),b=a[14],a.set(14,a[11]),a.set(11,b)},a.transposeMat4=function(b){return a.Mat4([b[0],b[4],b[8],b[12],b[1],b[5],b[9],b[13],b[2],b[6],b[10],b[14],b[3],b[7],b[11],b[15]])},a.mat4gl=function(a,b){b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]},a.set1basedMat4=function(a,b,c,d){a[(b-1)*4+(c-1)]=d,a.glData!==undefined&&delete a.glData},a.setMat4=function(a,b,c,d){a[b*4+c]=d,a.glData!==undefined&&delete a.glData},a.get1basedMat4=function(a,b,c){return a.get((b-1)*4+(c-1))},a.getMat4=function(a,b,c){return a[b*4+c]},a.glDataMat4=function(a){a.glArray=new Float32Array(a);return a.glArray},a.identMatrix=function(){return a.Mat([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},a.translateMatrix=function(b){var c,d,e;arguments.length==3?(c=arguments[0],d=arguments[1],e=arguments[2]):b.data?(c=b.data[0],d=b.data[1],e=b.data[2]):b instanceof Array&&(c=b[0],d=b[1],e=b[2]);return a.Mat([1,0,0,c,0,1,0,d,0,0,1,e,0,0,0,1])},a.scaleMatrix=function(b){var c,d,e;arguments.length==3?(c=arguments[0],d=arguments[1],e=arguments[2]):b.data?(c=b.data[0],d=b.data[1],e=b.data[2]):b instanceof Array&&(c=b[0],d=b[1],e=b[2]);return a.Mat([c,0,0,0,0,d,0,0,0,0,e,0,0,0,0,1])},a.ROT_XYZ=1,a.ROT_XZY=2,a.ROT_YXZ=3,a.ROT_YZX=4,a.ROT_ZXY=5,a.ROT_ZYX=6,a.rotateMatrix=function(b,c){var d,e,f;arguments.length>2?(d=arguments[0],e=arguments[1],f=arguments[2],c=arguments[3]):b.data?(d=b.data[0],e=b.data[1],f=b.data[2]):b instanceof Array&&(d=b[0],e=b[1],f=b[2]),c||(c=a.ROT_XYZ);var g=Math.cos(d),h=Math.sin(d),i=Math.cos(e),j=Math.sin(e),k=Math.cos(f),l=Math.sin(f),m=a.Mat([1,0,0,0,0,g,-h,0,0,h,g,0,0,0,0,1]),n=a.Mat([i,0,j,0,0,1,0,0,-j,0,i,0,0,0,0,1]),o=a.Mat([k,-l,0,0,l,k,0,0,0,0,1,0,0,0,0,1]);switch(c){case a.ROT_XYZ:return a.mulMat4(m,a.mulMat4(n,o));case a.ROT_XZY:return a.mulMat4(m,a.mulMat4(o,n));case a.ROT_YXZ:return a.mulMat4(n,a.mulMat4(m,o));case a.ROT_YZX:return a.mulMat4(n,a.mulMat4(o,m));case a.ROT_ZXY:return a.mulMat4(o,a.mulMat4(m,n));case a.ROT_ZYX:return a.mulMat4(o,a.mulMat4(n,m))}},a.angleAxis=function(b,c){var d,e,f,g,h,i,j,k,l;c=[c[0],c[1],c[2],0];var m=c[0],n=c[1],o=c[2],p=Math.cos(b),q=1-p,r=Math.sin(b);j=m*r,k=n*r,l=o*r,d=m*m,e=n*n,f=o*o,g=m*n,h=n*o,i=o*m;var s=[q*d+p,q*g-l,q*i+k,0,q*g+l,q*e+p,q*h-j,0,q*i-k,q*h+j,q*f+p,0,0,0,0,1];return a.Mat(s)},a.quatRotation=function(b,c,d,e){return a.Mat([1-2*c*c-2*d*d,2*b*c-2*d*e,2*b*d+2*c*e,0,2*b*c+2*d*e,1-2*b*b-2*d*d,2*c*d-2*b*e,0,2*b*d-2*c*e,2*c*d+2*b*e,1-2*b*b-2*c*c,0,0,0,0,1])},a.makeOrtho=function(b,c,d,e,f,g){var h=-(c+b)/(c-b),i=-(e+d)/(e-d),j=-(g+f)/(g-f);return a.Mat([2/(c-b),0,0,h,0,2/(e-d),0,i,0,0,-2/(g-f),j,0,0,0,1])},a.makeFrustum=function(b,c,d,e,f,g){var h=2*f/(c-b),i=2*f/(e-d),j=(c+b)/(c-b),k=(e+d)/(e-d),l=-(g+f)/(g-f),m=-2*g*f/(g-f);return a.Mat([h,0,j,0,0,i,k,0,0,0,l,m,0,0,-1,0])},a.makePerspective=function(b,c,d,e){var f=d*Math.tan(b*.00872664625972),g=-f,h=g*c,i=f*c;return a.makeFrustum(h,i,g,f,d,e)},a.matrix2Scale=function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=Math.sqrt(b*b+c*c+d*d),l=Math.sqrt(e*e+f*f+g*g),m=Math.sqrt(h*h+i*i+j*j);return[k,l,m]},a.rotationMatrix2Quat=function(a){var b=a[0]+a[5]+a[10]+1,c,d,e,f,g;b>0?(c=.5/Math.sqrt(b),g=.25/c,d=(a[9]-a[6])*c,e=(a[2]-a[8])*c,f=(a[4]-a[1])*c):a[0]>a[5]&&a[0]>a[10]?(c=Math.sqrt(1+a[0]-a[5]-a[10])*2,g=(a[9]-a[6])/c,d=.25/c,e=(a[1]+a[4])/c,f=(a[2]+a[8])/c):a[5]>a[10]?(c=Math.sqrt(1+a[5]-a[0]-a[10])*2,g=(a[2]-a[8])/c,d=(a[1]+a[4])/c,e=.25/c,f=(a[6]+a[9])/c):(c=Math.sqrt(1+a[10]-a[0]-a[5])*2,g=(a[4]-a[1])/c,d=(a[2]+a[8])/c,e=(a[6]+a[9])/c,f=.25/c);var h=Math.sqrt(d*d+e*e+f*f+g*g);return[d/h,e/h,f/h,g/h]},a.rayToPlane=function(b,c){var d=a.toUnitVec3(c);return[d[0],d[1],d[2],a.dotVec3(b,d)]},a.rayIntersectPlane=function(b,c,d){var e=[d[0],d[1],d[2]],f=d[3],g=a.dotVec3(e,c);if(g<=0)return!1;var h=-(a.dotVec3(e,b)+f),i=h/g;if(i<=0)return!1;return a.addVec3(b,a.scaleVec3(c,i))},a.screenToDirection=function(b,c,d,e,f){xcoord=-(2*b/d-1)/f[0],ycoord=(2*c/e-1)/f[5],zcoord=1;return a.toUnitVec3([xcoord,ycoord,zcoord])},a.BoundingVolume=function(a,b,c,d,e,f){this.limits=[a,b,c,d,e,f],this.calcProps()},a.BoundingVolume.prototype.getCornerPoints=function(){return this.points},a.BoundingVolume.prototype.getSphereRadius=function(){return this.radius},a.BoundingVolume.prototype.getCenter=function(){return this.center},a.BoundingVolume.prototype.addBoundingVolume=function(a){this.limits[0]=Math.min(a.limits[0],this.limits[0]),this.limits[2]=Math.min(a.limits[2],this.limits[2]),this.limits[4]=Math.min(a.limits[4],this.limits[4]),this.limits[1]=Math.max(a.limits[1],this.limits[1]),this.limits[3]=Math.max(a.limits[3],this.limits[3]),this.limits[5]=Math.max(a.limits[5],this.limits[5]),this.calcProps()},a.BoundingVolume.prototype.applyMatrix=function(b){var c=a.mulMat4Vec4(b,[this.limits[0],this.limits[2],this.limits[4],1]),d=a.mulMat4Vec4(b,[this.limits[1],this.limits[2],this.limits[4],1]),e=a.mulMat4Vec4(b,[this.limits[0],this.limits[3],this.limits[4],1]),f=a.mulMat4Vec4(b,[this.limits[1],this.limits[6],this.limits[4],1]),g=a.mulMat4Vec4(b,[this.limits[0],this.limits[2],this.limits[5],1]),h=a.mulMat4Vec4(b,[this.limits[1],this.limits[2],this.limits[5],1]),i=a.mulMat4Vec4(b,[this.limits[0],this.limits[3],this.limits[5],1]),j=a.mulMat4Vec4(b,[this.limits[1],this.limits[6],this.limits[5],1]);this.limits[0]=Math.min(c[0],d[0],e[0],f[0],g[0],h[0],i[0],j[0]),this.limits[1]=Math.max(c[0],d[0],e[0],f[0],g[0],h[0],i[0],j[0]),this.limits[2]=Math.min(c[1],d[1],e[1],f[1],g[1],h[1],i[1],j[1]),this.limits[3]=Math.max(c[1],d[1],e[1],f[1],g[1],h[1],i[1],j[1]),this.limits[4]=Math.min(c[2],d[2],e[2],f[2],g[2],h[2],i[2],j[2]),this.limits[5]=Math.max(c[2],d[2],e[2],f[2],g[2],h[2],i[2],j[2]),this.calcProps()},a.BoundingVolume.prototype.calcProps=function(){var a=this.limits[0],b=this.limits[1],c=this.limits[2],d=this.limits[3],e=this.limits[4],f=this.limits[5];this.points=[[a,c,e],[b,c,e],[a,d,e],[b,d,e],[a,c,f],[b,c,f],[a,d,f],[b,d,f]],this.center=[(this.limits[1]-this.limits[0])/2+this.limits[0],(this.limits[3]-this.limits[2])/2+this.limits[2],(this.limits[5]-this.limits[4])/2+this.limits[4]];var g=this.limits[0]-this.center[0],h=this.limits[2]-this.center[1],i=this.limits[4]-this.center[2];this.radius=Math.sqrt(g*g+h*h+i*i)},a.BoundingVolume.prototype.clone=function(){return new a.BoundingVolume(this.limits[0],this.limits[1],this.limits[2],this.limits[3],this.limits[4],this.limits[5])},a.BoundingVolume.prototype.toString=function(){return this.limits.toString()},a.cameraViewProjectionToPlanes=function(b){var c=a.inverseMat4(b),d=a.mulMat4Vec4,e=a.subVec3,f=a.crossVec3,g=a.toUnitVec3,h=a.dotVec3,i=d(c,[-1,-1,-1,1]),j=d(c,[1,-1,-1,1]),k=d(c,[-1,-1,1,1]),l=d(c,[1,1,-1,1]),m=d(c,[1,1,1,1]),n=d(c,[-1,1,1,1]);i=[i[0]/i[3],i[1]/i[3],i[2]/i[3]],j=[j[0]/j[3],j[1]/j[3],j[2]/j[3]],k=[k[0]/k[3],k[1]/k[3],k[2]/k[3]],l=[l[0]/l[3],l[1]/l[3],l[2]/l[3]],m=[m[0]/m[3],m[1]/m[3],m[2]/m[3]],n=[n[0]/n[3],n[1]/n[3],n[2]/n[3]];var o=g(f(e(l,j),e(i,j))),p=g(f(e(n,k),e(m,k))),q=g(f(e(i,k),e(n,k))),r=g(f(e(m,l),e(l,j))),s=g(f(e(n,l),e(l,m))),t=g(f(e(i,j),e(k,i)));o.push(h(o,i)),p.push(h(p,k)),q.push(h(q,i)),r.push(h(r,j)),s.push(h(s,m)),t.push(h(t,i));return[o,p,q,r,s,t]},a.sphereInFrustumPlanes=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3],k=b[4],l=b[5];return c*g[0]+d*g[1]+e*g[2]-g[3]-f>0||c*h[0]+d*h[1]+e*h[2]-h[3]-f>0||c*i[0]+d*i[1]+e*i[2]-i[3]-f>0||c*j[0]+d*j[1]+e*j[2]-j[3]-f>0||c*k[0]+d*k[1]+e*k[2]-k[3]-f>0||c*l[0]+d*l[1]+e*l[2]-l[3]-f>0?!1:!0},a.pointsInFrustumPlanes=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i,j,k;for(var l=0;l<a.length;l++){i=a[l][0],j=a[l][1],k=a[l][2];if(i*c[0]+j*c[1]+k*c[2]-c[3]>0&&i*d[0]+j*d[1]+k*d[2]-d[3]>0&&i*e[0]+j*e[1]+k*e[2]-f[3]>0&&i*f[0]+j*f[1]+k*f[2]-g[3]>0&&i*g[0]+j*g[1]+k*g[2]-g[3]>0&&i*h[0]+j*h[1]+k*h[2]-h[3]>0)return!1}return!0},b()}(GLGE),typeof GLGE=="undefined"&&(GLGE={}),function(e){var f=function(a){return typeof a!="number"?parseFloat(a):a};e.augment=function(a,b){for(proto in a.prototype)b.prototype[proto]=a.prototype[proto]},e.makeGlobal=function(){for(var a in e)window[a]=e[a]},e.New=function(a){return e[a].prototype.className!=""?new e[a]:!1},e.TRUE=1,e.FALSE=0,e.DRAW_TRIS=1,e.DRAW_LINES=2,e.DRAW_LINELOOPS=3,e.DRAW_LINESTRIPS=4,e.DRAW_POINTS=5,e.RENDER_DEFAULT=0,e.RENDER_SHADOW=1,e.RENDER_PICK=2,e.RENDER_NORMAL=3,e.RENDER_NULL=4,e.TEXT_BOXPICK=1,e.TEXT_TEXTPICK=1,e.P_EULER=1,e.P_QUAT=2,e.P_MATRIX=3,e.NONE=0,e.XAXIS=1,e.YAXIS=2,e.ZAXIS=3,e.POS_XAXIS=1,e.NEG_XAXIS=2,e.POS_YAXIS=3,e.NEG_YAXIS=4,e.POS_ZAXIS=5,e.NEG_ZAXIS=6,e.LINEAR_BLEND=function(a){return a},e.QUAD_BLEND=function(a){return a*a},e.SPECIAL_BLEND=function(a){a=a*(2-a);return a*a},e.error=function(a){console&&console.log&&console.log("GLGE error: "+a)},e.Assets={},e.Assets.assets={},e.Assets.createUUID=function(){var a=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],b=["8","9","A","B"];uuid="";for(var c=0;c<38;c++)switch(c){case 8:uuid=uuid+"-";break;case 13:uuid=uuid+"-";break;case 18:uuid=uuid+"-";break;case 14:uuid=uuid+"4";break;case 19:uuid=uuid+b[Math.round(Math.random()*3)];break;default:uuid=uuid+a[Math.round(Math.random()*15)]}return uuid},e.Assets.registerAsset=function(a,b){b||(b=e.Assets.createUUID()),a.uid=b,e.Assets.assets[b]=a},e.Assets.unregisterAsset=function(a){delete e.Assets.assets[a]},e.Assets.get=function(a){var b=e.Assets.assets[a];return b?b:!1},e.fastHash=function(a){var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=a.length;a+="000000";while(n<o)h=a.charCodeAt(n++),i=a.charCodeAt(n++),j=a.charCodeAt(n++),k=a.charCodeAt(n++),l=a.charCodeAt(n++),m=a.charCodeAt(n++),b=(f+h+i)%255,c=(g+i+j)%255,d=(b+j+k)%255,e=(c+k+l)%255,f=(d+l+m)%255,g=(e+m+h)%255;var p=[String.fromCharCode(b),String.fromCharCode(c),String.fromCharCode(d),String.fromCharCode(e),String.fromCharCode(f),String.fromCharCode(g)];return p.join("")},e.getGLShader=function(a,b,c){var d=e.fastHash(c);a.shaderCache||(a.shaderCache={});if(!a.shaderCache[d]){var f=a.createShader(b);a.shaderSource(f,c),a.compileShader(f);if(!a.getShaderParameter(f,a.COMPILE_STATUS))try{e.error(a.getShaderInfoLog(f));return}catch(g){}a.shaderCache[d]=f}return a.shaderCache[d]};var g=0;e.getGLProgram=function(a,b,c){a.programCache||(a.programCache=[]);var d=a.programCache;for(var f=0;f<d.length;f++)if(d[f].fShader==c&&d[f].vShader==b)return d[f].program;var h=a.createProgram();h.progIdx=g++,a.attachShader(h,b),a.attachShader(h,c),a.linkProgram(h),d.push({vShader:b,fShader:c,program:h});if(!h.uniformDetails){h.uniformDetails={};var i=a.getProgramParameter(h,a.ACTIVE_UNIFORMS);for(var f=0;f<i;++f){var j=a.getActiveUniform(h,f);h.uniformDetails[j.name]={loc:e.getUniformLocation(a,h,j.name),info:j}}}return h},e.getUniformLocation=function(a,b,c){b.uniformCache||(b.uniformCache={}),b.uniformChecked||(b.uniformChecked={}),b.uniformChecked[c]||(b.uniformCache[c]=a.getUniformLocation(b,c),b.uniformChecked[c]=!0);return b.uniformCache[c]},e.setUniform=function(a,b,c,d){typeof d=="string"&&(d=+d),c!=null&&a["uniform"+b](c,d)},e.setUniform3=function(a,b,c,d,e,f){typeof d=="string"&&(d=+d),typeof e=="string"&&(e=+e),typeof f=="string"&&(f=+f),c!=null&&a["uniform"+b](c,d,e,f)},e.setUniform4=function(a,b,c,d,e,f,g){c!=null&&a["uniform"+b](c,d,e,f,g)},e.setUniformMatrix=function(a,b,c,d,e){c!=null&&a["uniform"+b](c,d,e)},e.getAttribLocation=function(a,b,c){b.attribCache||(b.attribCache={}),b.attribCache[c]==undefined&&(b.attribCache[c]=a.getAttribLocation(b,c));return b.attribCache[c]},e.QuickNotation=function(){},e.QuickNotation.prototype._=function(){var a;for(var b=0;b<arguments.length;b++){a=arguments[b];if(typeof a=="object")if(a.className&&this["add"+a.className])this["add"+a.className](a);else for(var c in a)this["set"+c]&&this["set"+c](a[c])}return this},e.Message={},e.Message.parseMessage=function(a){switch(a.command){case"create":var b=new e[a.type](a.uid);this.setAttributes(b,a.attributes),a.children&&e.Message.addChildren(b,a.children);return b;case"update":var b=e.Assets.get(a.uid);this.setAttributes(b,a.attributes),a.add&&e.Message.addChildren(b,a.add),a.remove&&e.Message.removeChildren(b,a.remove);return b}return null},e.Message.setAttributes=function(a,b){if(b)for(var c in b)a["set"+c]&&(b[c].command&&(b[c]=e.Message.parseMessage(b[c])),a["set"+c](b[c]));return this},e.Message.addChildren=function(a,b){b instanceof Array||(b=[b]);for(var c=0;c<b.length;c++){if(b[c].command)var d=e.Message.parseMessage(b[c]);else var d=e.Assets.get(b[c]);a["add"+d.className](d)}},e.Message.removeChildren=function(a,b){b instanceof Array||(b=[b]);for(var c=0;c<b.length;c++){var d=e.Assets.get(b[c]);a["add"+d.className](d)}},e.Message.toLoad=[],e.Message.messageLoader=function(a,b,c){e.Message.toLoad.push([a,b,c]),e.Message.toLoad.length==1&&e.Message.loadMessages()},e.Message.loadMessages=function(){var a=e.Message.toLoad.pop(),b=new XMLHttpRequest;b.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?a[1](this.responseText):e.error("Error loading Document: "+a[0]+" status "+this.status))},b.open("GET",a[0],!0),b.send(""),e.Message.toLoad.length>0&&e.Message.loadMessages()},e.colorParse=function(a){var b,c,d,e,f={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};f[a]&&(a="#"+f[a]);if(a.substr&&a.substr(0,1)=="#")a=a.substr(1),a.length==8?(b=parseInt("0x"+a.substr(0,2))/255,c=parseInt("0x"+a.substr(2,2))/255,d=parseInt("0x"+a.substr(4,2))/255,e=parseInt("0x"+a.substr(6,2))/255):a.length==4?(b=parseInt("0x"+a.substr(0,1))/15,c=parseInt("0x"+a.substr(1,1))/15,d=parseInt("0x"+a.substr(2,1))/15,e=parseInt("0x"+a.substr(3,1))/15):a.length==6?(b=parseInt("0x"+a.substr(0,2))/255,c=parseInt("0x"+a.substr(2,2))/255,d=parseInt("0x"+a.substr(4,2))/255,e=1):a.length==3&&(b=parseInt("0x"+a.substr(0,1))/15,c=parseInt("0x"+a.substr(1,1))/15,d=parseInt("0x"+a.substr(2,1))/15,e=1);else if(a.substr&&a.substr(0,4)=="rgb("){var g=a.substr(4).split(",");b=parseInt(g[0])/255,c=parseInt(g[1])/255,d=parseInt(g[2])/255,e=1}else if(a.substr&&a.substr(0,5)=="rgba("){var g=a.substr(4).split(",");b=parseInt(g[0])/255,c=parseInt(g[1])/255,d=parseInt(g[2])/255,e=parseInt(g[3])/255}else b=0,c=0,d=0,e=0;return{r:b,g:c,b:d,a:e}},e.JSONLoader=function(){},e.JSONLoader.prototype.downloadPriority=0,e.JSONLoader.prototype.setJSONSrc=function(a){var b=this;e.Message.messageLoader(a,function(a){b.setJSONString(a)},this.downloadPriority)},e.JSONLoader.prototype.setJSONString=function(a){var b=JSON.parse(a);b.type==this.className&&(b.uid=this.uid,b.command="update",e.Message.parseMessage(b))},e.JSONLoader.prototype.setDownloadPriority=function(a){this.downloadPriority=a},e.JSONLoader.prototype.getDownloadPriority=function(){return this.downloadPriority},e.Events=function(){},e.Events.prototype.fireEvent=function(a,b){if(this.events&&this.events[a]){var c=this.events[a];for(var d=0;d<c.length;d++)c[d].call(this,b)}},e.Events.prototype.addEventListener=function(a,b){this.events||(this.events={}),this.events[a]||(this.events[a]=[]),this.events[a].push(b)},e.Events.prototype.removeEventListener=function(a,b){var c=this.events[a].indexOf(b);c!=-1&&this.events[a].splice(c,1)},e.Document=function(){this.listeners=[],this.documents=[]},e.Document.prototype.listeners=null,e.Document.prototype.documents=null,e.Document.prototype.rootURL=null,e.Document.prototype.loadCount=0,e.Document.prototype.version=0,e.Document.prototype.getElementById=function(a){var b=this.getElementsByTagName("*");for(var c=0;c<b.length;c++)if(b[c].getAttribute("id")==a)return b[c];return null},e.Document.prototype.getAbsolutePath=function(a,b){if(a.substr(0,7)=="http://"||a.substr(0,7)=="file://"||a.substr(0,8)=="https://")return a;b||(b=window.location.href);var c=b.split("/"),d=c[2],e=c[0],f=[];for(var g=3;g<c.length-1;g++)f.push(c[g]);a.substr(0,1)=="/"&&(f=[]);var h=a.split("/");for(g=0;g<h.length;g++)h[g]==".."?f.pop():h[g]!=""&&f.push(h[g]);return e+"//"+d+"/"+f.join("/")},e.Document.prototype.load=function(a){this.documents=[],this.rootURL=a,this.loadDocument(a,null)},e.Document.prototype.loadDocument=function(a,b){this.loadCount++,a=this.getAbsolutePath(a,b);var c=new XMLHttpRequest;c&&(c.docurl=a,c.docObj=this,c.overrideMimeType("text/xml"),c.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?(this.responseXML.getElementById=this.docObj.getElementById,this.docObj.loaded(this.docurl,this.responseXML)):e.error("Error loading Document: "+this.docurl+" status "+this.status))},c.open("GET",a,!0),c.send(""))},e.Document.prototype.loaded=function(a,b){this.loadCount--,this.documents[a]={xml:b};var c=b.getElementsByTagName("glge");c[0]&&c[0].hasAttribute("version")&&(this.version=parseFloat(c[0].getAttribute("version")));var d=b.getElementsByTagName("import");for(var e=0;e<d.length;e++)this.documents[this.getAbsolutePath(d[e].getAttribute("url"),a)]||(this.documents[this.getAbsolutePath(d[e].getAttribute("url"),a)]={},this.loadDocument(d[e].getAttribute("url"),a));this.loadCount==0&&this.finishedLoading()},e.Document.prototype.finishedLoading=function(){for(var a=0;a<this.listeners.length;a++)this.listeners[a](this.listeners.rootURL);this.onLoad()},e.Document.prototype.onLoad=function(){},e.Document.prototype.classString=function(a){if(!a)return!1;var b=a.split("_"),c="";for(var d=0;d<b.length;d++)c=c+b[d][0].toUpperCase()+b[d].substr(1);return c},e.Document.prototype.setProperties=function(a){var b,c,d;for(var f=0;f<a.attributes.length;f++)d=!1,b="set"+this.classString(a.attributes[f].nodeName),a.attributes[f].value[0]=="#"&&(d=this.getElement(a.attributes[f].value.substr(1),!0)),d||(typeof e[a.attributes[f].value]!="undefined"?d=e[a.attributes[f].value]:d=a.attributes[f].value),a.object[b]&&a.object[b](d),a.attributes[f].nodeName=="uid"&&(e.Assets.unregisterAsset(a.object.uid),a.object.uid=a.attributes[f].value,e.Assets.registerAsset(a.object,a.attributes[f].value))},e.Document.prototype.addChildren=function(a){var b,c=a.firstChild;while(c)b="add"+this.classString(c.tagName),a.object[b]&&a.object[b](this.getElement(c)),c=c.nextSibling},e.Document.prototype.getElement=function(a,b){var c,d;if(typeof a=="string")for(d in this.documents)if(this.documents[d].xml){c=this.documents[d].xml.getElementById(a);if(c){a=c;break}}if(typeof a=="string"){b||e.error("Element "+a+" not found in document");return!1}return this["get"+this.classString(a.tagName)]?this["get"+this.classString(a.tagName)](a):this.getDefault(a)},e.Document.prototype.getData=function(a){if(!a.object){a.object=this.parseArray(a);if(a.hasAttribute("type")){var b=a.getAttribute("type");switch(b){case"matrix":for(var c=0;c<a.object.length;c++)a.object[c]=e.Mat4(a.object[c].split(" "));break;case"links":for(var c=0;c<a.object.length;c++)a.object[c]=this.getElement(a.object[c].substr(1))}}}return a.object},e.Document.prototype.getDefault=function(a){a.object||(e[this.classString(a.tagName)]?(a.object=new(e[this.classString(a.tagName)]),this.setProperties(a),this.addChildren(a)):e.error("XML Parse Error: GLGE Object not found"));return a.object},e.Document.prototype.getTexture=function(a){if(!a.object){var b=this.getAbsolutePath(this.rootURL,null);a.object=new(e[this.classString(a.tagName)]),a.object.setSrc(this.getAbsolutePath(a.getAttribute("src"),b)),a.removeAttribute("src"),this.setProperties(a)}return a.object},e.Document.prototype.getTextureVideo=e.Document.prototype.getTexture,e.Document.prototype.parseArray=function(a){var b=a.firstChild,c="",d=[],e,f;while(b){e=(c+b.nodeValue).split(","),b=b.nextSibling,e[0]==""&&e.unshift(),b&&(c=e.pop());for(f=0;f<e.length;f++)d.push(e[f])}return d},e.Document.prototype.getMesh=function(a){if(this.version>0)return this.getDefault(a);if(!a.object){a.object=new e.Mesh,this.setProperties(a);var b=a.firstChild;while(b){switch(b.tagName){case"positions":a.object.setPositions(this.parseArray(b));break;case"normals":a.object.setNormals(this.parseArray(b));break;case"uv1":a.object.setUV(this.parseArray(b));break;case"uv2":a.object.setUV2(this.parseArray(b));break;case"faces":a.object.setFaces(this.parseArray(b));break;case"joint_names":var c=this.parseArray(b),d=[];for(var f=0;f<c.length;f++)c[f].substr(0,1)=="#"?d.push(this.getElement(c[f].substr(1))):d.push(c[f]);a.object.setJoints(d);break;case"bind_matrix":var g=this.parseArray(b),h=[];for(var f=0;f<g.length;f++)h.push(e.Mat4(g[f].split(" ")));a.object.setInvBindMatrix(h);break;case"joints":a.object.setVertexJoints(this.parseArray(b),b.getAttribute("count"));break;case"weights":a.object.setVertexWeights(this.parseArray(b),b.getAttribute("count"))}b=b.nextSibling}}return a.object},e.Document.prototype.addLoadListener=function(a){this.listeners.push(a)},e.Document.prototype.removeLoadListener=function(a){for(var b=0;b<this.listeners.length;b++)this.listeners[b]===a&&this.listeners.splice(b,1)},e.Document.prototype.parseScript=function(a){this.rootURL=window.location.toString();var b=document.getElementById(a);if(!b)return null;var c="",d=b.firstChild;while(d)d.nodeType==3&&(c+=d.textContent),d=d.nextSibling;var e=new DOMParser,f=e.parseFromString(c,"text/xml");f.getElementById=this.getElementById,this.documents["#"+a]={xml:f};var g=f.getElementsByTagName("import");for(var h=0;h<g.length;h++)this.documents[this.getAbsolutePath(g[h].getAttribute("url"),url)]||(this.documents[this.getAbsolutePath(g[h].getAttribute("url"),url)]={},this.loadDocument(g[h].getAttribute("url")));this.loadCount==0&&this.finishedLoading()},e.Placeable=function(){},e.Placeable.prototype.locX=0,e.Placeable.prototype.locY=0,e.Placeable.prototype.locZ=0,e.Placeable.prototype.dLocX=0,e.Placeable.prototype.dLocY=0,e.Placeable.prototype.dLocZ=0,e.Placeable.prototype.quatX=0,e.Placeable.prototype.quatY=0,e.Placeable.prototype.quatZ=0,e.Placeable.prototype.quatW=0,e.Placeable.prototype.rotX=0,e.Placeable.prototype.rotY=0,e.Placeable.prototype.rotZ=0,e.Placeable.prototype.dRotX=0,e.Placeable.prototype.dRotY=0,e.Placeable.prototype.dRotZ=0,e.Placeable.prototype.scaleX=1,e.Placeable.prototype.scaleY=1,e.Placeable.prototype.scaleZ=1,e.Placeable.prototype.dScaleX=0,e.Placeable.prototype.dScaleY=0,e.Placeable.prototype.dScaleZ=0,e.Placeable.prototype.matrix=null,e.Placeable.prototype.rotOrder=e.ROT_XYZ,e.Placeable.prototype.lookAt=null,e.Placeable.prototype.mode=e.P_EULER,e.Placeable.prototype.getRoot=function(){if(this.type==e.G_ROOT)return this;if(this.parent){var a=this.parent.getRoot();return a?a:this}return this},e.Placeable.prototype.getRef=function(){return this.id?this.id:this.parent?this.parent.getRef():null},e.Placeable.prototype.setId=function(a){this.id=a;return this},e.Placeable.prototype.getId=function(){return this.id},e.Placeable.prototype.getLookat=function(){return this.lookAt},e.Placeable.prototype.setLookat=function(a){this.lookAt=a;return this},e.Placeable.prototype.Lookat=function(a){var b,c=this.getPosition();a.getPosition?b=a.getPosition():b={x:a[0],y:a[1],z:a[2]};var d=[c.x-b.x,c.y-b.y,c.z-b.z],f=e.toUnitVec3(d),g=e.toUnitVec3(e.crossVec3([0,0,1],f)),h=e.toUnitVec3(e.crossVec3(f,g));this.setRotMatrix(e.Mat4([g[0],h[0],f[0],0,g[1],h[1],f[1],0,g[2],h[2],f[2],0,0,0,0,1]))},e.Placeable.prototype.getRotOrder=function(){return this.rotOrder},e.Placeable.prototype.setRotOrder=function(a){this.rotOrder=a,this.matrix=null,this.rotmatrix=null;return this},e.Placeable.prototype.getRotMatrix=function(){if(!this.rotmatrix){var a=this.getRotation();this.mode==e.P_EULER&&(this.rotmatrix=e.rotateMatrix(a.x,a.y,a.z,this.rotOrder)),this.mode==e.P_QUAT&&(this.rotmatrix=e.quatRotation(a.x,a.y,a.z,a.w))}return this.rotmatrix},e.Placeable.prototype.setRotMatrix=function(a){this.mode=e.P_MATRIX,this.rotmatrix=a,this.updateMatrix();return this},e.Placeable.prototype.setLocX=function(a){this.locX=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setLocY=function(a){this.locY=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setLocZ=function(a){this.locZ=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setLoc=function(a,b,c){this.locX=a,this.locY=b,this.locZ=c,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDLocX=function(a){this.dLocX=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDLocY=function(a){this.dLocY=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDLocZ=function(a){this.dLocZ=a,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDLoc=function(a,b,c){this.dLocX=a,this.dLocY=b,this.dLocZ=c,this.translateMatrix=null,this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setQuatX=function(a){this.mode=e.P_QUAT,this.quatX=parseFloat(a),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setQuatY=function(a){this.mode=e.P_QUAT,this.quatY=parseFloat(a),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setQuatZ=function(a){this.mode=e.P_QUAT,this.quatZ=parseFloat(a),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setQuatW=function(a){this.mode=e.P_QUAT,this.quatW=parseFloat(a),this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setQuat=function(a,b,c,d){this.mode=e.P_QUAT,this.quatX=a,this.quatY=b,this.quatZ=c,this.quatW=d,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setRotX=function(a){this.mode=e.P_EULER,this.rotX=a,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setRotY=function(a){this.mode=e.P_EULER,this.rotY=a,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setRotZ=function(a){this.mode=e.P_EULER,this.rotZ=a,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setRot=function(a,b,c){this.mode=e.P_EULER,this.rotX=a,this.rotY=b,this.rotZ=c,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDRotX=function(a){this.mode=e.P_EULER,this.dRotX=a,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDRotY=function(a){this.mode=e.P_EULER,this.dRotY=a,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDRotZ=function(a){this.mode=e.P_EULER,this.dRotZ=a,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDRot=function(a,b,c){this.mode=e.P_EULER,this.dRotX=a,this.dRotY=b,this.dRotZ=c,this.staticMatrix=null,this.rotmatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setScaleX=function(a){if(this.ScaleX==a)return this;this.scaleX=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setScaleY=function(a){if(this.ScaleY==a)return this;this.scaleY=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setScaleZ=function(a){if(this.ScaleZ==a)return this;this.scaleZ=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setScale=function(a,b,c){b||(b=a,c=a),this.scaleX=a,this.scaleY=b,this.scaleZ=c,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDScaleX=function(a){if(this.dScaleX==a)return this;this.dScaleX=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDScaleY=function(a){if(this.dScaleY==a)return this;this.dScaleY=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDScaleZ=function(a){if(this.dScaleZ==a)return this;this.dScaleZ=a,this.staticMatrix=null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.setDScale=function(a,b,c){this.dScaleX=a,this.dScaleY=b,this.dScaleZ=c,this.staticMatrix==null,this.scaleMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.getLocX=function(){return this.locX},e.Placeable.prototype.getLocY=function(){return this.locY},e.Placeable.prototype.getLocZ=function(){return this.locZ},e.Placeable.prototype.getDLocX=function(){return this.dLocX},e.Placeable.prototype.getDLocY=function(){return this.dLocY},e.Placeable.prototype.getDLocZ=function(){return this.dLocZ},e.Placeable.prototype.getQuatX=function(){return this.quatX},e.Placeable.prototype.getQuatY=function(){return this.quatY},e.Placeable.prototype.getQuatZ=function(){return this.quatZ},e.Placeable.prototype.getQuatW=function(){return this.quatW},e.Placeable.prototype.getRotX=function(){return this.rotX},e.Placeable.prototype.getRotY=function(){return this.rotY},e.Placeable.prototype.getRotZ=function(){return this.rotZ},e.Placeable.prototype.getDRotX=function(){return this.dRotX},e.Placeable.prototype.getDRotY=function(){return this.dRotY},e.Placeable.prototype.getDRotZ=function(){return this.dRotZ},e.Placeable.prototype.getScaleX=function(){return this.scaleX},e.Placeable.prototype.getScaleY=function(){return this.scaleY},e.Placeable.prototype.getScaleZ=function(){return this.scaleZ},e.Placeable.prototype.getDScaleX=function(){return this.dScaleX},e.Placeable.prototype.getDScaleY=function(){return this.dScaleY},e.Placeable.prototype.getDScaleZ=function(){return this.dScaleZ},e.Placeable.prototype.getPosition=function(){var a={};a.x=parseFloat(this.locX)+parseFloat(this.dLocX),a.y=parseFloat(this.locY)+parseFloat(this.dLocY),a.z=parseFloat(this.locZ)+parseFloat(this.dLocZ);return a},e.Placeable.prototype.getRotation=function(){var a={};this.mode==e.P_EULER&&(a.x=parseFloat(this.rotX)+parseFloat(this.dRotX),a.y=parseFloat(this.rotY)+parseFloat(this.dRotY),a.z=parseFloat(this.rotZ)+parseFloat(this.dRotZ)),this.mode==e.P_QUAT&&(a.x=parseFloat(this.quatX),a.y=parseFloat(this.quatY),a.z=parseFloat(this.quatZ),a.w=parseFloat(this.quatW));return a},e.Placeable.prototype.getScale=function(){var a={};a.x=parseFloat(this.scaleX)+parseFloat(this.dScaleX),a.y=parseFloat(this.scaleY)+parseFloat(this.dScaleY),a.z=parseFloat(this.scaleZ)+parseFloat(this.dScaleZ);return a},e.Placeable.prototype.getScaleMatrix=function(){this.scaleMatrix||(this.scaleMatrix=e.scaleMatrix(parseFloat(this.scaleX)+parseFloat(this.dScaleX),parseFloat(this.scaleY)+parseFloat(this.dScaleY),parseFloat(this.scaleZ)+parseFloat(this.dScaleZ)));return this.scaleMatrix},e.Placeable.prototype.getTranslateMatrix=function(){this.translateMatrix||(this.translateMatrix=e.translateMatrix(parseFloat(this.locX)+parseFloat(this.dLocX),parseFloat(this.locY)+parseFloat(this.dLocY),parseFloat(this.locZ)+parseFloat(this.dLocZ)));return this.translateMatrix},e.Placeable.prototype.getLocalMatrix=function(){this.getModelMatrix();return this.localMatrix},e.Placeable.prototype.setStaticMatrix=function(a){this.staticMatrix=a,this.updateMatrix();return this},e.Placeable.prototype.clearStaticMatrix=function(){this.staticMatrix=null,this.updateMatrix();return this},e.Placeable.prototype.updateMatrix=function(){this.matrix=null;if(this.children)for(var a=0;a<this.children.length;a++)this.children[a].updateMatrix()},e.Placeable.prototype.getModelMatrix=function(){if(!this.matrix){this.invmatrix=null,this.transmatrix=null,this.transinvmatrix=null;if(this.staticMatrix){var a=this.staticMatrix;this.localMatrix=this.staticMatrix,this.parent&&(a=e.mulMat4(this.parent.getModelMatrix(),a)),this.matrix=a}else{var b=this.getTranslateMatrix(),c=this.getScaleMatrix(),a=e.mulMat4(b,e.mulMat4(this.getRotMatrix(),c));this.localMatrix=a,this.parent&&(a=e.mulMat4(this.parent.getModelMatrix(),a)),this.matrix=a}}return this.matrix},e.Placeable.prototype.getInverseModelMatrix=function(){this.matrix||this.getModelMatrix(),this.invmatrix||(this.invmatrix=e.transposeMat4(this.matrix));return this.invmatrix},e.Placeable.prototype.getTransposeModelMatrix=function(){this.matrix||this.getModelMatrix(),this.transmatrix||(this.transmatrix=e.transposeMat4(this.matrix));return this.transmatrix},e.Placeable.prototype.getTransposeInverseModelMatrix=function(){this.matrix||this.getModelMatrix(),this.transinvmatrix||(this.invtransmatrix=e.transposeMat4(this.getInverseModelMatrix()));return this.transinvmatrix},e.Animatable=function(){},e.augment(e.Events,e.Animatable),e.Animatable.prototype.animationStart=null,e.Animatable.prototype.animation=null,e.Animatable.prototype.blendStart=0,e.Animatable.prototype.blendTime=0,e.Animatable.prototype.lastFrame=null,e.Animatable.prototype.frameRate=30,e.Animatable.prototype.loop=e.TRUE,e.Animatable.prototype.paused=e.FALSE,e.Animatable.prototype.pausedTime=null,e.Animatable.prototype.blendFunction=e.LINEAR_BLEND,e.Animatable.prototype.blendTo=function(a,b,c){c||(c=e.LINEAR_BLEND);var d=new e.AnimationVector,f,g;for(prop in a)f=new e.AnimationCurve,f.setChannel(prop),g=new e.LinearPoint,g.setX(1),g.setY(a[prop]),f.addPoint(g),d.addAnimationCurve(f);this.setBlendFunction(c),this.setAnimation(d,b);return this},e.Animatable.prototype.setBlendFunction=function(a){this.blendFunction=a;return this},e.Animatable.prototype.getBlendFunction=function(){return this.blendFunction},e.Animatable.prototype.setName=function(a){this.name=a;return this},e.Animatable.prototype.getName=function(){return this.name},e.Animatable.prototype.getFrameNumber=function(a){this.startFrame||(this.startFrame=this.animation.startFrame),this.animFrames||(this.animFrames=this.animation.frames);var b;a||(a=parseInt((new Date).getTime())),this.animFrames>1?this.loop?b=(parseFloat(a)-parseFloat(this.animationStart))/1e3*this.frameRate%(this.animFrames-1)+1+this.startFrame:(b=(parseFloat(a)-parseFloat(this.animationStart))/1e3*this.frameRate+1+this.startFrame,b>=this.animFrames&&(b=this.animFrames)):b=1;return Math.round(b)},e.Animatable.prototype.setStartFrame=function(a,b,c){this.loop=c;var d=parseInt((new Date).getTime());b||(b=0),b>0&&(this.animation&&(this.blendInitValues=this.getInitialValues(this.animation,d),this.blendTime=b)),this.animationStart=d,this.lastFrame=null,this.animFinished=!1,this.startFrame=a;if(this.children)for(var e=0;e<this.children.length;e++)this.children[e].setStartFrame&&this.children[e].setStartFrame(a,b,c);return this},e.Animatable.prototype.setFrames=function(a){this.animFrames=a;if(this.children)for(var b=0;b<this.children.length;b++)this.children[b].setFrames&&this.children[b].setFrames(a);return this},e.Animatable.prototype.getInitialValues=function(a,b){var c={};this.animation&&(this.lastFrame=null,this.animate(b,!0));for(var d in a.curves)this["get"+d]&&(c[d]=this["get"+d]());return c},e.Animatable.prototype.animate=function(a,b){if(!this.paused&&this.animation){a||(a=parseInt((new Date).getTime()));var c=this.getFrameNumber(a);this.animation.animationCache||(this.animation.animationCache={});if(c!=this.lastFrame||this.blendTime!=0){this.lastFrame=c;if(this.blendTime==0)if(!this.animation.animationCache[c]||b){this.animation.animationCache[c]=[];if(this.animation.curves.LocX&&this.animation.curves.LocY&&this.animation.curves.LocZ&&this.animation.curves.ScaleX&&this.animation.curves.ScaleY&&this.animation.curves.ScaleZ&&this.animation.curves.QuatX&&this.animation.curves.QuatY&&this.animation.curves.QuatZ&&this.animation.curves.QuatW){for(property in this.animation.curves)if(this["set"+property]){var d=this.animation.curves[property].getValue(parseFloat(c));switch(property){case"QuatX":case"QuatY":case"QuatZ":case"QuatW":case"LocX":case"LocY":case"LocZ":case"ScaleX":case"ScaleY":case"ScaleZ":break;default:this.animation.animationCache[c].push({property:property,value:d})}this["set"+property](d)}this.animation.animationCache[c].push({property:"StaticMatrix",value:this.getLocalMatrix()})}else{for(property in this.animation.curves)if(this["set"+property]){var d=this.animation.curves[property].getValue(parseFloat(c));switch(property){case"QuatX":case"QuatY":case"QuatZ":case"QuatW":case"RotX":case"RotY":case"RotZ":var e=!0;break;default:this.animation.animationCache[c].push({property:property,value:d})}this["set"+property](d)}e&&(d=this.getRotMatrix(),this.animation.animationCache[c].push({property:"RotMatrix",value:d}))}}else{var f=this.animation.animationCache[c];for(var g=0;g<f.length;g++)this["set"+f[g].property]&&this["set"+f[g].property](f[g].value)}else{var h=a-this.animationStart;if(h<this.blendTime){var i=h/this.blendTime;i=this.blendFunction(i);for(property in this.animation.curves)if(this["set"+property]){var d=this.animation.curves[property].getValue(parseFloat(c));d=d*i+this.blendInitValues[property]*(1-i),this["set"+property](d)}}else this.blendTime=0}}}if(this.children)for(var g=0;g<this.children.length;g++)this.children[g].animate&&this.children[g].animate(a,b);this.animation&&!this.animFinished&&this.blendTime==0&&this.animation.frames==c&&!b&&(this.animFinished=!0,this.fireEvent("animFinished",{}))},e.Animatable.prototype.setAnimation=function(a,b,c){c==null&&(c=parseInt((new Date).getTime())),b||(b=0),b>0&&(this.blendInitValues=this.getInitialValues(a,c),this.blendTime=b),this.animFrames=null,this.startFrame=null,this.animationStart=c,this.lastFrame=null,this.animation=a,this.animFinished=!1;return this},e.Animatable.prototype.getAnimation=function(){return this.animation},e.Animatable.prototype.setFrameRate=function(a){this.frameRate=a;return this},e.Animatable.prototype.getFrameRate=function(){return this.frameRate},e.Animatable.prototype.setLoop=function(a){this.loop=a;return this},e.Animatable.prototype.getLoop=function(){return this.loop},e.Animatable.prototype.isLooping=e.Animatable.prototype.getLoop,e.Animatable.prototype.setPaused=function(a){a?this.pauseTime=parseInt((new Date).getTime()):this.animationStart=this.animationStart+(parseInt((new Date).getTime())-this.pauseTime),this.paused=a;return this},e.Animatable.prototype.getPaused=function(){return this.paused},e.Animatable.prototype.togglePaused=function(){this.setPaused(!this.getPaused());return this.paused},e.BezTriple=function(a){e.Assets.registerAsset(this,a)},e.augment(e.QuickNotation,e.BezTriple),e.augment(e.JSONLoader,e.BezTriple),e.BezTriple.prototype.className="BezTriple",e.BezTriple.prototype.setX1=function(a){this.x1=parseFloat(a);return this},e.BezTriple.prototype.setY1=function(a){this.y1=parseFloat(a);return this},e.BezTriple.prototype.setX2=function(a){this.x=parseFloat(a);return this},e.BezTriple.prototype.setY2=function(a){this.y=parseFloat(a);return this},e.BezTriple.prototype.setX3=function(a){this.x3=parseFloat(a);return this},e.BezTriple.prototype.setY3=function(a){this.y3=parseFloat(a);return this},e.LinearPoint=function(a){},e.augment(e.QuickNotation,e.LinearPoint),e.augment(e.JSONLoader,e.LinearPoint),e.LinearPoint.prototype.className="LinearPoint",e.LinearPoint.prototype.x=0,e.LinearPoint.prototype.y=0,e.LinearPoint.prototype.setX=function(a){this.x=parseFloat(a);return this},e.LinearPoint.prototype.setY=function(a){this.y=parseFloat(a);return this},e.StepPoint=function(a,b){this.x=parseFloat(a),this.y=b},e.AnimationCurve=function(a){e.Assets.registerAsset(this,a),this.keyFrames=[],this.solutions={},this.caches={}},e.augment(e.QuickNotation,e.AnimationCurve),e.augment(e.JSONLoader,e.AnimationCurve),e.AnimationCurve.prototype.className="AnimationCurve",e.AnimationCurve.prototype.keyFrames=null,e.AnimationCurve.prototype.addPoint=function(a){this.keyFrames.push(a);return this.keyFrames.length-1},e.AnimationCurve.prototype.addStepPoint=e.AnimationCurve.prototype.addPoint,e.AnimationCurve.prototype.addLinearPoint=e.AnimationCurve.prototype.addPoint,e.AnimationCurve.prototype.addBezTriple=e.AnimationCurve.prototype.addPoint,e.AnimationCurve.prototype.coord=function(a,b){return{x:a,y:b}},e.AnimationCurve.prototype.setChannel=function(a){this.channel=a},e.AnimationCurve.prototype.getValue=function(a){if(this.keyFrames.length==0)return 0;if(this.caches[a])return this.caches[a];var b,c,d,f;if(a<this.keyFrames[0].x)return this.keyFrames[0].y;for(var g=0;g<this.keyFrames.length;g++){if(this.keyFrames[g].x==a)return this.keyFrames[g].y;this.keyFrames[g].x>a||b!=undefined&&this.keyFrames[g].x<=this.keyFrames[b].x?this.keyFrames[g].x<=a&&(d==undefined||this.keyFrames[g].x>this.keyFrames[d].x)&&(d=g):(d=b,b=g),this.keyFrames[g].x<=a||c!=undefined&&this.keyFrames[g].x>this.keyFrames[c].x?this.keyFrames[g].x>a&&(f==undefined||this.keyFrames[g].x<=this.keyFrames[f].x)&&(f=g):(f=c,c=g)}b==undefined&&(b=c,c=f),c==undefined&&(c=b,b=d);if(this.keyFrames[b]instanceof e.BezTriple&&this.keyFrames[c]instanceof e.BezTriple){var h=this.coord(this.keyFrames[b].x,this.keyFrames[b].y),i=this.coord(this.keyFrames[b].x3,this.keyFrames[b].y3),j=this.coord(this.keyFrames[c].x1,this.keyFrames[c].y1),k=this.coord(this.keyFrames[c].x,this.keyFrames[c].y);return this.atX(a,h,i,j,k).y}if(this.keyFrames[b]instanceof e.LinearPoint&&this.keyFrames[c]instanceof e.BezTriple){var h=this.coord(this.keyFrames[b].x,this.keyFrames[b].y),i=this.coord(this.keyFrames[c].x1,this.keyFrames[c].y1),j=this.coord(this.keyFrames[c].x1,this.keyFrames[c].y1),k=this.coord(this.keyFrames[c].x,this.keyFrames[c].y);return this.atX(a,h,i,j,k).y}if(this.keyFrames[b]instanceof e.BezTriple&&this.keyFrames[c]instanceof e.LinearPoint){var h=this.coord(this.keyFrames[b].x,this.keyFrames[b].y),i=this.coord(this.keyFrames[b].x3,this.keyFrames[b].y3),j=this.coord(this.keyFrames[b].x3,this.keyFrames[b].y3),k=this.coord(this.keyFrames[c].x,this.keyFrames[c].y);return this.atX(a,h,i,j,k).y}if(this.keyFrames[b]instanceof e.LinearPoint&&this.keyFrames[c]instanceof e.LinearPoint){var l=(a-this.keyFrames[b].x)*(this.keyFrames[c].y-this.keyFrames[b].y)/(this.keyFrames[c].x-this.keyFrames[b].x)+this.keyFrames[b].y;return l}if(this.keyFrames[b]instanceof e.StepPoint)return this.keyFrames[b].y;this.keyFrames.preStartKey||(this.keyFrames.preStartKey=this.keyFrames[0].y),this.caches[a]=this.keyFrames.preStartKey;return this.caches[a]},e.AnimationCurve.prototype.B1=function(a){return a*a*a},e.AnimationCurve.prototype.B2=function(a){return 3*a*a*(1-a)},e.AnimationCurve.prototype.B3=function(a){return 3*a*(1-a)*(1-a)},e.AnimationCurve.prototype.B4=function(a){return(1-a)*(1-a)*(1-a)},e.AnimationCurve.prototype.getBezier=function(a,b,c,d,e){var f={};f.x=b.x*this.B1(a)+c.x*this.B2(a)+d.x*this.B3(a)+e.x*this.B4(a),f.y=b.y*this.B1(a)+c.y*this.B2(a)+d.y*this.B3(a)+e.y*this.B4(a);return f},e.AnimationCurve.prototype.Quad3Solve=function(a,b,c,d){ref=a+"-"+b+"--"+c+"-"+d;if(this.solutions[ref])return this.solutions[ref];b/=a,c/=a,d/=a;var e,f,g,h,i,j,k;e=(3*c-b*b)/9,f=-(27*d)+b*(9*c-2*(b*b)),f/=54,j=b/3,discrim=e*e*e+f*f,result=[],discrim>0?(h=f+Math.sqrt(discrim),h=h<0?-Math.pow(-h,1/3):Math.pow(h,1/3),i=f-Math.sqrt(discrim),i=i<0?-Math.pow(-i,1/3):Math.pow(i,1/3),result[0]=-j+h+i,j=j+(h+i)/2,result[1]=result[2]=-j,j=Math.sqrt(3)*(-i+h)/2):discrim==0?(k=f<0?-Math.pow(-f,1/3):Math.pow(f,1/3),result[1]=-j+2*k,result[1]=result[2]=-(k+j)):(e=-e,g=e*e*e,g=Math.acos(f/Math.sqrt(1)),k=2*Math.sqrt(e),result[0]=-j+k*Math.cos(g/3),result[1]=-j+k*Math.cos((g+2*Math.PI)/3),result[2]=-j+k*Math.cos((g+4*Math.PI)/3));var l=!1;result[0]>=0&&result[0]<=1&&(l=result[0]),!l&&result[1]>=0&&result[1]<=1&&(l=result[1]),!l&&result[2]>=0&&result[2]<=1&&(l=result[2]),this.solutions[ref]=l;return l},e.AnimationCurve.prototype.atX=function(e,f,g,h,i){a=f.x-g.x*3+h.x*3-i.x,b=g.x*3-h.x*6+i.x*3,c=h.x*3-i.x*3,d=i.x-e;return this.getBezier(this.Quad3Solve(a,b,c,d),f,g,h,i)},e.AnimationVector=function(a){e.Assets.registerAsset(this,a),this.curves=[]},e.augment(e.QuickNotation,e.AnimationVector),e.augment(e.JSONLoader,e.AnimationVector),e.AnimationVector.prototype.curves=[],e.AnimationVector.prototype.frames=250,e.AnimationVector.prototype.startFrame=0,e.AnimationVector.prototype.addAnimationCurve=function(a){this.curves[a.channel]=a;return this},e.AnimationVector.prototype.removeAnimationCurve=function(a){delete this.curves[a]},e.AnimationVector.prototype.setFrames=function(a){this.frames=a;return this},e.AnimationVector.prototype.getFrames=function(){return this.frames},e.AnimationVector.prototype.setStartFrame=function(a){this.startFrame=a;return this},e.AnimationVector.prototype.getStartFrame=function(){return this.startFrame},e.G_NODE=1,e.G_ROOT=2,e.Group=function(a){e.Assets.registerAsset(this,a),this.children=[]},e.augment(e.Placeable,e.Group),e.augment(e.Animatable,e.Group),e.augment(e.QuickNotation,e.Group),e.augment(e.JSONLoader,e.Group),e.Group.prototype.children=null,e.Group.prototype.className="Group",e.Group.prototype.type=e.G_NODE,e.Group.prototype.setAction=function(a,b,c){a.start(b,c,this.getNames());return this},e.Group.prototype.getNames=function(a){a||(a={});var b=this.getName();b!=""&&(a[b]=this);for(var c=0;c<this.children.length;c++)this.children[c].getNames&&this.children[c].getNames(a);return a},e.Group.prototype.getBoundingVolume=function(a){this.boundingVolume=null;for(var b=0;b<this.children.length;b++)this.children[b].getBoundingVolume&&(this.boundingVolume?this.boundingVolume.addBoundingVolume(this.children[b].getBoundingVolume(!0)):this.boundingVolume=this.children[b].getBoundingVolume(!0).clone());this.boundingVolume||(this.boundingVolume=new e.BoundingVolume(0,0,0,0,0,0)),a?this.boundingVolume.applyMatrix(this.getLocalMatrix()):this.boundingVolume.applyMatrix(this.getModelMatrix());return this.boundingVolume},e.Group.prototype.getObjects=function(a){this.lookAt&&this.Lookat(this.lookAt),this.animation&&this.animate(),a||(a=[]);for(var b=0;b<this.children.length;b++)this.children[b].className=="Object"||this.children[b].className=="Text"||this.children[b].toRender?this.children[b].renderFirst?a.unshift(this.children[b]):a.push(this.children[b]):this.children[b].getObjects&&this.children[b].getObjects(a);return a},e.Group.prototype.getLights=function(a){a||(a=[]);for(var b=0;b<this.children.length;b++)this.children[b].className=="Light"?a.push(this.children[b]):this.children[b].getLights&&this.children[b].getLights(a);return a},e.Group.prototype.addChild=function(a){a.parent&&a.parent.removeChild(a),a.matrix=null,a.parent=this,this.children.push(a);if(a.getLights&&a.getLights().length>0||a.className=="Light"){var b=a;while(b.parent)b=b.parent;var c=b.getObjects();for(var d=0;d<c.length;d++)c[d].updateProgram&&c[d].updateProgram()}return this},e.Group.prototype.addObject=e.Group.prototype.addChild,e.Group.prototype.addObjectInstance=e.Group.prototype.addChild,e.Group.prototype.addGroup=e.Group.prototype.addChild,e.Group.prototype.addLight=e.Group.prototype.addChild,e.Group.prototype.addText=e.Group.prototype.addChild,e.Group.prototype.addSkeleton=e.Group.prototype.addChild,e.Group.prototype.addCamera=e.Group.prototype.addChild,e.Group.prototype.addWavefront=e.Group.prototype.addChild,e.Group.prototype.removeChild=function(a){for(var b=0;b<this.children.length;b++)if(this.children[b]==a){this.children.splice(b,1),this.scene&&this.scene["remove"+a.className]&&this.scene["remove"+a.className](a);break}},e.Group.prototype.getChildren=function(){return this.children},e.Group.prototype.GLInit=function(a){this.gl=a;for(var b=0;b<this.children.length;b++)this.children[b].GLInit&&this.children[b].GLInit(a)},e.Group.prototype.getPickable=function(){return this.pickable},e.Group.prototype.setPickable=function(a){for(var b=0;b<this.children.length;b++)this.children[b].setPickable&&this.children[b].setPickable(a);this.pickable=a;return this},e.ActionChannel=function(a){e.Assets.registerAsset(this,a)},e.augment(e.QuickNotation,e.ActionChannel),e.augment(e.JSONLoader,e.ActionChannel),e.ActionChannel.prototype.setTarget=function(a){this.target=a},e.ActionChannel.prototype.setAnimation=function(a){this.animation=a},e.ActionChannel.prototype.getTarget=function(){return this.target},e.ActionChannel.prototype.getAnimation=function(){return this.animation},e.Action=function(a){e.Assets.registerAsset(this,a),this.channels=[]},e.augment(e.QuickNotation,e.Action),e.augment(e.JSONLoader,e.Action),e.augment(e.Events,e.Action),e.Action.prototype.start=function(a,b,c){b||(b=!1),a||(a=0);var d=this.channels,e=(new Date).getTime();this.animFinished=!1;for(var f=0;f<d.length;f++){var g=d[f].getAnimation(),h=this,i=d[f],j=i.getTarget();typeof j=="string"&&(c&&c[j]&&(j=c[j]));var k={};k.finishEvent=function(a){j.removeEventListener("animFinished",k.finishEvent),!h.animFinished&&j.animation==g&&(h.fireEvent("animFinished",{}),h.animFinished=!0)},j.addEventListener("animFinished",k.finishEvent),j.setAnimation(g,a,e),j.setLoop(b)}},e.Action.prototype.setStartFrame=function(a){for(var b=0;b<this.channels.length;b++)this.channels[b].getAnimation().setStartFrame(a);return this},e.Action.prototype.setFrames=function(a){for(var b=0;b<this.channels.length;b++)this.channels[b].getAnimation().setFrames(a);return this},e.Action.prototype.addActionChannel=function(a){this.channels.push(a);return this},e.Action.prototype.removeActionChannel=function(a){for(var b=0;b<this.channels.length;b++)if(this.channels[b]==channels){this.channels.splice(b,1);break}},e.Text=function(a){e.Assets.registerAsset(this,a),this.canvas=document.createElement("canvas"),this.color={r:1,g:1,b:1}},e.augment(e.Placeable,e.Text),e.augment(e.Animatable,e.Text),e.augment(e.QuickNotation,e.Text),e.augment(e.JSONLoader,e.Text),e.Text.prototype.className="Text",e.Text.prototype.zTrans=!0,e.Text.prototype.canvas=null,e.Text.prototype.aspect=1,e.Text.prototype.color=null,e.Text.prototype.text="",e.Text.prototype.font="Times",e.Text.prototype.size=100,e.Text.prototype.pickType=e.TEXT_TEXTPICK,e.Text.prototype.getPickType=function(){return this.pickType},e.Text.prototype.setPickType=function(a){this.pickType=a;return this},e.Text.prototype.getFont=function(){return this.size},e.Text.prototype.setFont=function(a){this.font=a,this.gl&&this.updateCanvas(this.gl);return this},e.Text.prototype.getSize=function(){return this.size},e.Text.prototype.setSize=function(a){this.size=a,this.gl&&this.updateCanvas(this.gl);return this},e.Text.prototype.getText=function(){return this.text},e.Text.prototype.setText=function(a){this.text=a,this.gl&&this.updateCanvas(this.gl);return this},e.Text.prototype.setColor=function(a){a=e.colorParse(a),this.color={r:a.r,g:a.g,b:a.b};return this},e.Text.prototype.setColorR=function(a){this.color.r=a;return this},e.Text.prototype.setColorG=function(a){this.color.g=a;return this},e.Text.prototype.setColorB=function(a){this.color.b=a;return this},e.Text.prototype.getColor=function(){return this.color},e.Text.prototype.setZtransparent=function(a){this.zTrans=a;return this},e.Text.prototype.isZtransparent=function(){return this.zTrans},e.Text.prototype.GLGenerateShader=function(a){this.GLShaderProgram&&a.deleteProgram(this.GLShaderProgram);var b="";b+="attribute vec3 position;\n",b+="attribute vec2 uvcoord;\n",b+="varying vec2 texcoord;\n",b+="uniform mat4 Matrix;\n",b+="uniform mat4 PMatrix;\n",b+="varying vec4 pos;\n",b+="void main(void){\n",b+="texcoord=uvcoord;\n",b+="pos = Matrix * vec4(position,1.0);\n",b+="gl_Position = PMatrix * pos;\n",b+="}\n";var c="#ifdef GL_ES\nprecision highp float;\n#endif\n";c=c+"uniform sampler2D TEXTURE;\n",c=c+"varying vec2 texcoord;\n",c=c+"varying vec4 pos;\n",c=c+"uniform float far;\n",c=c+"uniform int picktype;\n",c=c+"uniform vec3 pickcolor;\n",c=c+"uniform vec3 color;\n",c=c+"void main(void){\n",c=c+"float alpha=texture2D(TEXTURE,texcoord).a;\n",c=c+"if(picktype=="+e.TEXT_BOXPICK+"){gl_FragColor = vec4(pickcolor,1.0);}",c=c+"else if(picktype=="+e.TEXT_TEXTPICK+"){gl_FragColor = vec4(pickcolor,alpha);}",c=c+"else{gl_FragColor = vec4(color.rgb*alpha,alpha);};\n",c=c+"}\n",this.GLFragmentShader=a.createShader(a.FRAGMENT_SHADER),this.GLVertexShader=a.createShader(a.VERTEX_SHADER),a.shaderSource(this.GLFragmentShader,c),a.compileShader(this.GLFragmentShader);if(a.getShaderParameter(this.GLFragmentShader,a.COMPILE_STATUS)){a.shaderSource(this.GLVertexShader,b),a.compileShader(this.GLVertexShader);if(!a.getShaderParameter(this.GLVertexShader,a.COMPILE_STATUS)){e.error(a.getShaderInfoLog(this.GLVertexShader));return}this.GLShaderProgram=a.createProgram(),a.attachShader(this.GLShaderProgram,this.GLVertexShader),a.attachShader(this.GLShaderProgram,this.GLFragmentShader),a.linkProgram(this.GLShaderProgram)}else e.error(a.getShaderInfoLog(this.GLFragmentShader))},e.Text.prototype.GLInit=function(a){this.gl=a,this.createPlane(a),this.GLGenerateShader(a),this.glTexture=a.createTexture(),this.updateCanvas(a)},e.Text.prototype.updateCanvas=function(a){var b=this.canvas;b.width=1,b.height=this.size*1.2;var c=b.getContext("2d");c.font=this.size+"px "+this.font,b.width=c.measureText(this.text).width,b.height=this.size*1.2,c=b.getContext("2d"),c.textBaseline="top",c.font=this.size+"px "+this.font,this.aspect=b.width/b.height,c.fillText(this.text,0,0),a.bindTexture(a.TEXTURE_2D,this.glTexture);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b)}catch(d){a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b,null)}a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null)},e.Text.prototype.GLRender=function(a,b,c){this.gl||this.GLInit(a);if(b==e.RENDER_DEFAULT||b==e.RENDER_PICK){this.lookAt&&this.Lookat(this.lookAt),a.program!=this.GLShaderProgram&&(a.useProgram(this.GLShaderProgram),a.program=this.GLShaderProgram);var d;for(var f=0;f<8;f++)a.disableVertexAttribArray(f);d=e.getAttribLocation(a,this.GLShaderProgram,"position"),a.bindBuffer(a.ARRAY_BUFFER,this.posBuffer),a.enableVertexAttribArray(d),a.vertexAttribPointer(d,this.posBuffer.itemSize,a.FLOAT,!1,0,0),d=e.getAttribLocation(a,this.GLShaderProgram,"uvcoord"),a.bindBuffer(a.ARRAY_BUFFER,this.uvBuffer),a.enableVertexAttribArray(d),a.vertexAttribPointer(d,this.uvBuffer.itemSize,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.glTexture),e.setUniform(a,"1i",e.getUniformLocation(a,this.GLShaderProgram,"TEXTURE"),0),c||(c=0);var g=c>>16&255,h=c>>8&255,i=c&255;e.setUniform3(a,"3f",e.getUniformLocation(a,this.GLShaderProgram,"pickcolor"),i/255,h/255,g/255),b==e.RENDER_PICK?e.setUniform(a,"1i",e.getUniformLocation(a,this.GLShaderProgram,"picktype"),this.pickType):e.setUniform(a,"1i",e.getUniformLocation(a,this.GLShaderProgram,"picktype"),0),this.GLShaderProgram.glarrays||(this.GLShaderProgram.glarrays={});var j=this.size/100,k=e.mulMat4(a.scene.camera.getViewMatrix(),e.mulMat4(this.getModelMatrix(),e.scaleMatrix(this.aspect*j,j,j))),l=e.getUniformLocation(a,this.GLShaderProgram,"Matrix");this.GLShaderProgram.glarrays.mMatrix?e.mat4gl(k,this.GLShaderProgram.glarrays.mMatrix):this.GLShaderProgram.glarrays.mMatrix=new Float32Array(k),e.setUniformMatrix(a,"Matrix4fv",l,!0,this.GLShaderProgram.glarrays.mMatrix);var l=e.getUniformLocation(a,this.GLShaderProgram,"PMatrix");this.GLShaderProgram.glarrays.pMatrix?e.mat4gl(a.scene.camera.getProjectionMatrix(),this.GLShaderProgram.glarrays.pMatrix):this.GLShaderProgram.glarrays.pMatrix=new Float32Array(a.scene.camera.getProjectionMatrix()),e.setUniformMatrix(a,"Matrix4fv",l,!0,this.GLShaderProgram.glarrays.pMatrix);var m=e.getUniformLocation(a,this.GLShaderProgram,"far");e.setUniform(a,"1f",m,a.scene.camera.getFar()),e.setUniform3(a,"3f",e.getUniformLocation(a,this.GLShaderProgram,"color"),this.color.r,this.color.g,this.color.b),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.drawElements(a.TRIANGLES,this.GLfaces.numItems,a.UNSIGNED_SHORT,0),a.scene.lastMaterail=null}},e.Text.prototype.createPlane=function(a){this.posBuffer||(this.posBuffer=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.posBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),a.STATIC_DRAW),this.posBuffer.itemSize=3,this.posBuffer.numItems=4,this.uvBuffer||(this.uvBuffer=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.uvBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),a.STATIC_DRAW),this.uvBuffer.itemSize=2,this.uvBuffer.numItems=4,this.GLfaces||(this.GLfaces=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),a.STATIC_DRAW),this.GLfaces.itemSize=1,this.GLfaces.numItems=6},e.ObjectLod=function(a){e.Assets.registerAsset(this,a)},e.augment(e.QuickNotation,e.ObjectLod),e.augment(e.JSONLoader,e.ObjectLod),e.ObjectLod.prototype.mesh=null,e.ObjectLod.prototype.className="ObjectLod",e.ObjectLod.prototype.material=null,e.ObjectLod.prototype.program=null,e.ObjectLod.prototype.GLShaderProgramPick=null,e.ObjectLod.prototype.GLShaderProgramShadow=null,e.ObjectLod.prototype.GLShaderProgram=null,e.ObjectLod.prototype.pixelSize=0,e.ObjectLod.prototype.setMesh=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.mesh&&this.mesh.removeEventListener("shaderupdate",this.meshupdated);var b=this;this.meshupdated=function(a){b.GLShaderProgram=null},a.addEventListener("shaderupdate",this.meshupdated),this.GLShaderProgram=null,this.mesh=a;return this},e.ObjectLod.prototype.getMesh=function(){return this.mesh},e.ObjectLod.prototype.setMaterial=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.material&&this.material.removeEventListener("shaderupdate",this.materialupdated);var b=this;this.materialupdated=function(a){b.GLShaderProgram=null},a.addEventListener("shaderupdate",this.materialupdated),this.GLShaderProgram=null,this.material=a;return this},e.ObjectLod.prototype.getMaterial=function(){return this.material},e.ObjectLod.prototype.getPixelSize=function(){return this.pixelSize},e.ObjectLod.prototype.setPixelSize=function(a){this.pixelSize=parseFloat(a)},e.MultiMaterial=function(a){e.Assets.registerAsset(this,a),this.lods=[new e.ObjectLod]},e.augment(e.QuickNotation,e.MultiMaterial),e.augment(e.JSONLoader,e.MultiMaterial),e.MultiMaterial.prototype.className="MultiMaterial",e.MultiMaterial.prototype.setMesh=function(a){this.lods[0].setMesh(a);return this},e.MultiMaterial.prototype.getMesh=function(){return this.lods[0].getMesh()},e.MultiMaterial.prototype.setMaterial=function(a){this.lods[0].setMaterial(a);return this},e.MultiMaterial.prototype.getMaterial=function(){return this.lods[0].getMaterial()},e.MultiMaterial.prototype.getLOD=function(a){var b=0,c=this.lods[0];if(this.lods.length>1)for(var d=1;d<this.lods.length;d++){var e=this.lods[d].pixelSize;e>b&&e<a&&this.lods[d].mesh&&this.lods[d].mesh.loaded&&(b=e,c=this.lods[d])}return c},e.MultiMaterial.prototype.addObjectLod=function(a){this.lods.push(a);return this},e.MultiMaterial.prototype.updateProgram=function(){for(var a=0;a<this.lods.length;a++)this.lods[a].GLShaderProgram=null;return this},e.MultiMaterial.prototype.removeObjectLod=function(a){var b=this.lods.indexOf(a);b&&this.lods.splice(b,1);return this},e.ObjectInstance=function(a){e.Assets.registerAsset(this,a)},e.augment(e.Placeable,e.ObjectInstance),e.augment(e.Animatable,e.ObjectInstance),e.augment(e.QuickNotation,e.ObjectInstance),e.augment(e.JSONLoader,e.ObjectInstance),e.ObjectInstance.prototype.parentObject=null,e.ObjectInstance.prototype.className="ObjectInstance",e.ObjectInstance.prototype.setObject=function(a){this.parentObject&&this.parentObject.removeInstance(this),this.parentObject=a,a.addInstance(this);return this},e.ObjectInstance.prototype.getObject=function(){return this.parentObject},e.Object=function(a){e.Assets.registerAsset(this,a),this.multimaterials=[],this.instances=[],this.renderCaches=[]},e.augment(e.Placeable,e.Object),e.augment(e.Animatable,e.Object),e.augment(e.QuickNotation,e.Object),e.augment(e.JSONLoader,e.Object),e.Object.prototype.className="Object",e.Object.prototype.mesh=null,e.Object.prototype.skeleton=null,e.Object.prototype.scene=null,e.Object.prototype.transformMatrix=e.identMatrix(),e.Object.prototype.material=null,e.Object.prototype.gl=null,e.Object.prototype.multimaterials=null,e.Object.prototype.instances=null,e.Object.prototype.zTrans=!1,e.Object.prototype.renderCaches=null,e.Object.prototype.id="",e.Object.prototype.pickable=!0,e.Object.prototype.drawType=e.DRAW_TRIS,e.Object.prototype.pointSize=1,e.Object.prototype.cull=!1;var h=[];h.push("#ifdef GL_ES\nprecision highp float;\n#endif\n"),h.push("uniform float distance;\n"),h.push("varying vec3 eyevec;\n"),h.push("void main(void)\n"),h.push("{\n"),h.push("float depth=length(eyevec);\n"),h.push("vec4 rgba=fract(depth/distance * vec4(16777216.0, 65536.0, 256.0, 1.0));\n"),h.push("gl_FragColor=rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);\n"),h.push("}\n"),e.Object.prototype.shfragStr=h.join("");var j=[];j.push("#ifdef GL_ES\nprecision highp float;\n#endif\n"),j.push("varying vec3 n;\n"),j.push("void main(void)\n"),j.push("{\n"),j.push("gl_FragColor=vec4(n,1.0);\n"),j.push("}\n"),e.Object.prototype.nfragStr=j.join("");var k=[];k.push("#ifdef GL_ES\nprecision highp float;\n#endif\n"),k.push("uniform float far;\n"),k.push("uniform vec3 pickcolor;\n"),k.push("varying vec3 n;\n"),k.push("varying vec4 UVCoord;\n"),k.push("void main(void)\n"),k.push("{\n"),k.push("float Xcoord = gl_FragCoord.x+0.5;\n"),k.push("if(Xcoord>0.0) gl_FragColor = vec4(pickcolor,1.0);\n"),k.push("if(Xcoord>1.0) gl_FragColor = vec4(n,1.0);\n"),k.push("if(Xcoord>2.0){"),k.push("vec3 rgb=fract((gl_FragCoord.z/gl_FragCoord.w) * vec3(65536.0, 256.0, 1.0));\n"),k.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n"),k.push("}"),k.push("if(Xcoord>3.0){"),k.push("vec3 rgb=fract(UVCoord.x * vec3(65536.0, 256.0, 1.0));\n"),k.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n"),k.push("}"),k.push("if(Xcoord>4.0){"),k.push("vec3 rgb=fract(UVCoord.y * vec3(65536.0, 256.0, 1.0));\n"),k.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n"),k.push("}"),k.push("}\n"),e.Object.prototype.pkfragStr=k.join(""),e.Object.prototype.getPickable=function(){return this.pickable},e.Object.prototype.setPickable=function(a){this.pickable=a;return this},e.Object.prototype.getCull=function(){return this.cull},e.Object.prototype.setCull=function(a){this.cull=a;return this},e.Object.prototype.getDrawType=function(){return this.drawType},e.Object.prototype.setDrawType=function(a){this.drawType=a;return this},e.Object.prototype.getPointSize=function(){return this.pointSize},e.Object.prototype.setPointSize=function(a){this.pointSize=parseFloat(a);return this},e.Object.prototype.getSkeleton=function(){return this.skeleton},e.Object.prototype.setSkeleton=function(a){this.skeleton=a,this.bones=null;return this},e.Object.prototype.getBoundingVolume=function(a){a||(a=0),this.boundingVolume||(this.boundingVolume=[]),this.boundmatrix||(this.boundmatrix=[]);var b=this.getModelMatrix();if(b!=this.boundmatrix[a]||!this.boundingVolume[a]){var c=this.multimaterials,d;for(var f=0;f<c.length;f++)c[f].lods[0].mesh&&(d?d.addBoundingVolume(c[f].lods[0].mesh.getBoundingVolume()):d=c[f].lods[0].mesh.getBoundingVolume().clone());d||(d=new e.BoundingVolume(0,0,0,0,0,0)),a?d.applyMatrix(this.getLocalMatrix()):d.applyMatrix(this.getModelMatrix()),this.boundingVolume[a]=d}this.boundmatrix[a]=b;return this.boundingVolume[a]},e.Object.prototype.setZtransparent=function(a){this.zTrans=a;return this},e.Object.prototype.isZtransparent=function(){return this.zTrans},e.Object.prototype.addInstance=function(a){this.instances.push(a);return this},e.Object.prototype.removeInstance=function(a){for(var b=0;b<this.instances;b++)this.instance==a&&this.instances.splice(b)},e.Object.prototype.setMaterial=function(a,b){typeof a=="string"&&(a=e.Assets.get(a)),b||(b=0),this.multimaterials[b]||(this.multimaterials[b]=new e.MultiMaterial),this.multimaterials[b].getMaterial()!=a&&(this.multimaterials[b].setMaterial(a),this.updateProgram());return this},e.Object.prototype.getMaterial=function(a){a||(a=0);return this.multimaterials[a]?this.multimaterials[a].getMaterial():!1},e.Object.prototype.setMesh=function(a,b){typeof a=="string"&&(a=e.Assets.get(a)),b||(b=0),this.multimaterials[b]||this.multimaterials.push(new e.MultiMaterial),this.multimaterials[b].setMesh(a),this.boundingVolume=null;return this},e.Object.prototype.getMesh=function(a){a||(a=0);return this.multimaterials[a]?this.multimaterials[a].getMesh():!1},e.Object.prototype.GLInit=function(a){this.gl=a},e.Object.prototype.GLDestory=function(a){},e.Object.prototype.updateProgram=function(){for(var a=0;a<this.multimaterials.length;a++)this.multimaterials[a].updateProgram()},e.Object.prototype.addMultiMaterial=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.multimaterials.push(a),this.boundingVolume=null;return this},e.Object.prototype.getMultiMaterials=function(){return this.multimaterials},e.Object.prototype.GLGenerateShader=function(a){var b=joints1=joints2=!1,c=a.lights,d=[],f=!1;this.mesh.normals||this.mesh.calcNormals();for(var g=0;g<this.mesh.buffers.length;g++)this.mesh.buffers[g].name=="tangent"&&(f=!0),this.mesh.buffers[g].size>1?d.push("attribute vec"+this.mesh.buffers[g].size+" "+this.mesh.buffers[g].name+";\n"):d.push("attribute float "+this.mesh.buffers[g].name+";\n"),this.mesh.buffers[g].name=="UV"&&(b=!0),this.mesh.buffers[g].name=="joints1"&&(joints1=this.mesh.buffers[g]),this.mesh.buffers[g].name=="joints2"&&(joints2=this.mesh.buffers[g]);d.push("uniform mat4 worldView;\n"),d.push("uniform mat4 projection;\n"),d.push("uniform mat4 worldInverseTranspose;\n"),d.push("uniform mat4 envMat;\n");for(var g=0;g<c.length;g++)d.push("uniform vec3 lightpos"+g+";\n"),d.push("uniform vec3 lightdir"+g+";\n"),d.push("uniform mat4 lightmat"+g+";\n"),d.push("varying vec4 spotcoord"+g+";\n");d.push("varying vec3 eyevec;\n");for(var g=0;g<c.length;g++)d.push("varying vec3 lightvec"+g+";\n"),d.push("varying float lightdist"+g+";\n");this.mesh.joints&&this.mesh.joints.length>0&&d.push("uniform vec4 jointMat["+3*this.mesh.joints.length+"];\n"),this.material&&d.push(this.material.getVertexVarying(d)),d.push("varying vec3 n;\n"),d.push("varying vec3 t;\n"),d.push("varying vec4 UVCoord;\n"),d.push("varying vec3 OBJCoord;\n"),d.push("void main(void)\n"),d.push("{\n"),b?d.push("UVCoord=UV;\n"):d.push("UVCoord=vec4(0.0,0.0,0.0,0.0);\n"),d.push("OBJCoord = position;\n"),d.push("vec3 tang;\n"),d.push("vec4 pos = vec4(0.0, 0.0, 0.0, 1.0);\n"),d.push("vec4 norm = vec4(0.0, 0.0, 0.0, 1.0);\n"),d.push("vec4 tang4 = vec4(0.0, 0.0, 0.0, 1.0);\n");if(joints1){if(joints1.size==1)d.push("pos += vec4(dot(jointMat[int(3.0*joints1)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1+2.0)],vec4(position,1.0)),1.0)*weights1;\n"),d.push("norm += vec4(dot(jointMat[int(3.0*joints1)].xyz,normal),\n               dot(jointMat[int(3.0*joints1+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints1+2.0)].xyz,normal),1.0)*weights1;\n"),f&&d.push("tang4 += vec4(dot(jointMat[int(3.0*joints1)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1+2.0)].xyz,tangent),1.0)*weights1;\n");else for(var g=0;g<joints1.size;g++)d.push("pos += vec4(dot(jointMat[int(3.0*joints1["+g+"])],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1["+g+"]+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1["+g+"]+2.0)],vec4(position,1.0)),1.0)*weights1["+g+"];\n"),d.push("norm += vec4(dot(jointMat[int(3.0*joints1["+g+"])].xyz,normal),\n               dot(jointMat[int(3.0*joints1["+g+"]+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints1["+g+"]+2.0)].xyz,normal),1.0)*weights1["+g+"];\n"),f&&d.push("tang4 += vec4(dot(jointMat[int(3.0*joints1["+g+"])].xyz,tangent),\n               dot(jointMat[int(3.0*joints1["+g+"]+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1["+g+"]+2.0)].xyz,tangent),1.0)*weights1["+g+"];\n");if(joints2)if(joints2.size==1)d.push("pos += vec4(dot(jointMat[int(3.0*joints2)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2+2.0)],vec4(position,1.0)),1.0)*weights2;\n"),d.push("norm += vec4(dot(jointMat[int(3.0*joints2)].xyz,normal),\n               dot(jointMat[int(3.0*joints2+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints2+2.0)].xyz,normal),1.0)*weights2;\n"),f&&d.push("tang4 += vec4(dot(jointMat[int(3.0*joints2)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2+2.0)].xyz,tangent),1.0)*weights2;\n");else for(var g=0;g<joints2.size;g++)d.push("pos += vec4(dot(jointMat[int(3.0*joints2["+g+"])],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2["+g+"]+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2["+g+"]+2.0)],vec4(position,1.0)),1.0)*weights2["+g+"];\n"),d.push("norm += vec4(dot(jointMat[int(3.0*joints2["+g+"])].xyz,normal),\n               dot(jointMat[int(3.0*joints2["+g+"]+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints2["+g+"]+2.0)].xyz,normal),1.0)*weights2["+g+"];\n"),f&&d.push("tang4 += vec4(dot(jointMat[int(3.0*joints2["+g+"])].xyz,tangent),\n               dot(jointMat[int(3.0*joints2["+g+"]+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2["+g+"]+2.0)].xyz,tangent),1.0)*weights2["+g+"];\n");for(var g=0;g<c.length;g++)d.push("spotcoord"+g+"=lightmat"+g+"*vec4(pos.xyz,1.0);\n");d.push("pos = worldView * vec4(pos.xyz, 1.0);\n"),d.push("norm = worldInverseTranspose * vec4(norm.xyz, 1.0);\n"),f&&d.push("tang = (worldInverseTranspose*vec4(tang4.xyz,1.0)).xyz;\n")}else{for(var g=0;g<c.length;g++)d.push("spotcoord"+g+"=lightmat"+g+"*vec4(position,1.0);\n");d.push("pos = worldView * vec4(position, 1.0);\n"),d.push("norm = worldInverseTranspose * vec4(normal, 1.0);\n"),f&&d.push("tang = (worldInverseTranspose*vec4(tangent,1.0)).xyz;\n")}d.push("gl_Position = projection * pos;\n"),d.push("gl_PointSize="+this.pointSize.toFixed(5)+";\n"),d.push("eyevec = -pos.xyz;\n"),d.push("t = normalize(tang);"),d.push("n = normalize(norm.rgb);");for(var g=0;g<c.length;g++)c[g].getType()==e.L_DIR?d.push("lightvec"+g+" = -lightdir"+g+";\n"):d.push("lightvec"+g+" = -(lightpos"+g+"-pos.xyz);\n"),d.push("lightdist"+g+" = length(lightpos"+g+".xyz-pos.xyz);\n");this.material&&d.push(this.material.getLayerCoords(d)),d.push("}\n"),d=d.join("");if(this.material)h=this.material.getFragmentShader(c);else{var h=[];h.push("void main(void)\n"),h.push("{\n"),h.push("gl_FragColor = vec4(1.0,1.0,1.0,1.0);\n"),h.push("}\n"),h=h.join("")}this.GLFragmentShaderNormal=e.getGLShader(a,a.FRAGMENT_SHADER,this.nfragStr),this.GLFragmentShaderShadow=e.getGLShader(a,a.FRAGMENT_SHADER,this.shfragStr),this.GLFragmentShaderPick=e.getGLShader(a,a.FRAGMENT_SHADER,this.pkfragStr),this.GLFragmentShader=e.getGLShader(a,a.FRAGMENT_SHADER,h),this.GLVertexShader=e.getGLShader(a,a.VERTEX_SHADER,d),this.GLShaderProgramPick=e.getGLProgram(a,this.GLVertexShader,this.GLFragmentShaderPick),this.GLShaderProgramShadow=e.getGLProgram(a,this.GLVertexShader,this.GLFragmentShaderShadow),this.GLShaderProgramNormal=e.getGLProgram(a,this.GLVertexShader,this.GLFragmentShaderNormal),this.GLShaderProgram=e.getGLProgram(a,this.GLVertexShader,this.GLFragmentShader)},e.Object.prototype.createShaders=function(a){this.gl&&(this.mesh=a.mesh,this.material=a.material,this.GLGenerateShader(this.gl),a.GLShaderProgramPick=this.GLShaderProgramPick,a.GLShaderProgramShadow=this.GLShaderProgramShadow,a.GLShaderProgram=this.GLShaderProgram)},e.Object.prototype.GLUniforms=function(a,b,c){var d;switch(b){case e.RENDER_DEFAULT:d=this.GLShaderProgram;break;case e.RENDER_SHADOW:d=this.GLShaderProgramShadow;break;case e.RENDER_NORMAL:d=this.GLShaderProgramNormal;break;case e.RENDER_PICK:d=this.GLShaderProgramPick;var f=c>>16&255,g=c>>8&255,h=c&255;e.setUniform3(a,"3f",e.getUniformLocation(a,d,"pickcolor"),h/255,g/255,f/255)}d.caches||(d.caches={}),d.glarrays||(d.glarrays={});var i=d.caches,j=d.glarrays,k=a.scene,l=k.camera;i.far!=l.far&&(e.setUniform(a,"1i",e.getUniformLocation(a,d,"far"),l.far),i.far=l.far);if(b==e.RENDER_DEFAULT){if(i.ambientColor!=k.ambientColor){var m=k.ambientColor;e.setUniform3(a,"3f",e.getUniformLocation(a,d,"amb"),m.r,m.g,m.b),i.ambientColor=m}i.fogFar!=k.fogFar&&(e.setUniform(a,"1f",e.getUniformLocation(a,d,"fogfar"),k.fogFar),i.fogFar=k.fogFar),i.fogNear!=k.fogNear&&(e.setUniform(a,"1f",e.getUniformLocation(a,d,"fognear"),k.fogNear),i.fogNear=k.fogNear),i.fogType!=k.fogType&&(e.setUniform(a,"1i",e.getUniformLocation(a,d,"fogtype"),k.fogType),i.fogType=k.fogType),i.fogType!=k.fogcolor&&(e.setUniform3(a,"3f",e.getUniformLocation(a,d,"fogcolor"),k.fogColor.r,k.fogColor.g,k.fogColor.b),i.fogcolor=k.fogcolor)}var n=l.getViewMatrix(),o=this.getModelMatrix();i.mvMatrix||(i.mvMatrix={cameraMatrix:null,modelMatrix:null});var p=i.mvMatrix;if(p.camerMatrix!=n||p.modelMatrix!=o){this.caches.mvMatrix||(this.caches.mvMatrix=e.mulMat4(n,o)),mvMatrix=this.caches.mvMatrix,this.mesh.joints&&(mvMatrix=n);var q=e.getUniformLocation(a,d,"worldView");j.mvMatrix?e.mat4gl(e.transposeMat4(mvMatrix),j.mvMatrixT):j.mvMatrixT=new Float32Array(e.transposeMat4(mvMatrix)),j.mvMatrix=mvMatrix,e.setUniformMatrix(a,"Matrix4fv",q,!1,d.glarrays.mvMatrixT);var r=e.getUniformLocation(a,d,"envMat");if(r){if(!this.caches.envMat){var s=e.inverseMat4(mvMatrix);s[3]=0,s[7]=0,s[11]=0,this.caches.envMat=s}s=this.caches.envMat,d.glarrays.envMat?e.mat4gl(e.transposeMat4(s),j.envMatT):j.envMatT=new Float32Array(e.transposeMat4(s)),j.envMat=s,e.setUniformMatrix(a,"Matrix4fv",r,!1,j.envMatT)}if(!this.caches.normalMatrix){var t=e.inverseMat4(mvMatrix);this.caches.normalMatrix=t}t=this.caches.normalMatrix;var u=e.getUniformLocation(a,d,"worldInverseTranspose");j.normalMatrix?e.mat4gl(t,j.normalMatrix):j.normalMatrix=new Float32Array(t),e.setUniformMatrix(a,"Matrix4fv",u,!1,j.normalMatrix);var v=e.getUniformLocation(a,d,"view");j.cameraMatrix?e.mat4gl(e.transposeMat4(n),j.cameraMatrixT):j.cameraMatrixT=new Float32Array(e.transposeMat4(n)),j.cameraMatrix=n,e.setUniformMatrix(a,"Matrix4fv",v,!1,j.cameraMatrixT),p.camerMatrix=n,p.modelMatrix=o}var w=e.getUniformLocation(a,d,"projection");j.pMatrix?e.mat4gl(e.transposeMat4(l.getProjectionMatrix()),j.pMatrixT):j.pMatrixT=new Float32Array(e.transposeMat4(l.getProjectionMatrix())),j.pMatrix=l.getProjectionMatrix(),e.setUniformMatrix(a,"Matrix4fv",w,!1,j.pMatrixT);if(b==e.RENDER_DEFAULT||b==e.RENDER_SHADOW){var x,y,z=a.lights;i.lights||(i.lights=[]),j.lights||(j.lights=[]),this.caches.lights||(this.caches.lights=[]);var A=i.lights;for(var B=0;B<z.length;B++){A[B]||(A[B]={modelMatrix:null,cameraMatrix:null});if(A[B].modelMatrix!=o||A[B].cameraMatrix!=n){this.caches.lights[B]||(this.caches.lights[B]={}),this.caches.lights[B].pos||(this.caches.lights[B].pos=e.mulMat4Vec4(e.mulMat4(n,z[B].getModelMatrix()),[0,0,0,1])),x=this.caches.lights[B].pos,e.setUniform3(a,"3f",e.getUniformLocation(a,d,"lightpos"+B),x[0],x[1],x[2]),this.caches.lights[B].lpos||(this.caches.lights[B].lpos=e.mulMat4Vec4(e.mulMat4(n,z[B].getModelMatrix()),[0,0,1,1])),y=this.caches.lights[B].lpos,e.setUniform3(a,"3f",e.getUniformLocation(a,d,"lightdir"+B),y[0]-x[0],y[1]-x[1],y[2]-x[2]);if(z[B].s_cache){var C=e.mulMat4(z[B].s_cache.smatrix,o);j.lights[B]?e.mat4gl(C,j.lights[B]):j.lights[B]=new Float32Array(C),e.setUniformMatrix(a,"Matrix4fv",e.getUniformLocation(a,d,"lightmat"+B),!0,j.lights[B]),A[B].modelMatrix=o,A[B].cameraMatrix=n}else A[B].modelMatrix=o,A[B].cameraMatrix=n}}}if(this.mesh.joints){i.joints||(i.joints=[]),j.joints||(j.joints=[]),j.jointsT||(j.jointsT=[]),j.jointsinv||(j.jointsinv=[]);if(!j.jointsCombined||j.jointsCombined.length!=this.mesh.joints.length*12)j.jointsCombined=new Float32Array(this.mesh.joints.length*12);var D=i.joints,E=e.identMatrix();for(B=0;B<this.mesh.joints.length;B++){D[B]||(D[B]={modelMatrix:null,invBind:null});if(typeof this.mesh.joints[B]=="string"){this.bones||(this.bones=this.skeleton.getNames());if(this.bones)var o=this.bones[this.mesh.joints[B]].getModelMatrix()}else var o=this.mesh.joints[B].getModelMatrix();var F=this.mesh.invBind[B];if(D[B].modelMatrix!=o||D[B].invBind!=F){var G=e.mulMat4(o,F);j.joints[B]?e.mat4gl(e.transposeMat4(G),j.jointsT[B]):j.jointsT[B]=new Float32Array(e.transposeMat4(G)),j.joints[B]=G,j.jointsinv[B]?e.mat4gl(e.inverseMat4(G),j.jointsinv[B]):j.jointsinv[B]=new Float32Array(e.inverseMat4(G));var H=j.jointsT[B],I=j.jointsCombined;I[B*12]=H[0],I[B*12+1]=H[4],I[B*12+2]=H[8],I[B*12+3]=H[12],I[B*12+4]=H[1],I[B*12+5]=H[5],I[B*12+6]=H[9],I[B*12+7]=H[13],I[B*12+8]=H[2],I[B*12+9]=H[6],I[B*12+10]=H[10],I[B*12+11]=H[14],D[B].modelMatrix=o,D[B].invBind=F}}a.uniform4fv(e.getUniformLocation(a,d,"jointMat"),j.jointsCombined)}this.material&&b==e.RENDER_DEFAULT&&a.scene.lastMaterial!=this.material&&this.material.textureUniforms(a,d,z,this),a.scene.lastMaterial=this.material},e.Object.prototype.GLRender=function(a,b,c,d,f){if(a){this.gl||this.GLInit(a),this.lookAt&&this.Lookat(this.lookAt),b==e.RENDER_DEFAULT&&(this.animation&&this.animate()),this.renderCaches[b]||(this.renderCaches[b]={});var g=a.scene.camera.getViewMatrix(),h=this.getModelMatrix();if(this.renderCaches[b].camerMatrix!=g||this.renderCaches[b].modelMatrix!=h)this.renderCaches[b]={},this.renderCaches[b].camerMatrix=g,this.renderCaches[b].modelMatrix=h;this.caches=this.renderCaches[b];for(var i=0;i<this.instances.length;i++){var j=this.instances[i];j.renderCaches||(j.renderCaches=[]),j.renderCaches[b]||(j.renderCaches[b]={});var h=j.getModelMatrix();if(j.renderCaches[b].camerMatrix!=g||j.renderCaches[b].modelMatrix!=h)j.renderCaches[b]={},j.renderCaches[b].camerMatrix=g,j.renderCaches[b].modelMatrix=h}var k;if(d==undefined)var l=0,m=this.multimaterials.length;else var l=d,m=d+1;for(var n=l;n<m;n++){if(this.multimaterials[n].lods.length>1&&!k){var o=a.scene.camera.getPosition(),p=this.getPosition(),q=e.lengthVec3([o.x-p.x,o.y-p.y,o.z-p.z]);q=e.mulMat4Vec4(a.scene.camera.getProjectionMatrix(),[this.getBoundingVolume().getSphereRadius(),0,-q,1]),k=q[0]/q[3]*a.scene.renderer.canvas.width}var r=this.multimaterials[n].getLOD(k);if(r.mesh&&r.mesh.loaded){if(b==e.RENDER_NULL){r.material&&r.material.registerPasses(a,this);break}r.GLShaderProgram?(this.GLShaderProgramPick=r.GLShaderProgramPick,this.GLShaderProgramShadow=r.GLShaderProgramShadow,this.GLShaderProgram=r.GLShaderProgram):this.createShaders(r),this.mesh=r.mesh,this.material=r.material;var s;switch(this.drawType){case e.DRAW_LINES:s=a.LINES;break;case e.DRAW_POINTS:s=a.POINTS;break;case e.DRAW_LINELOOPS:s=a.LINE_LOOP;break;case e.DRAW_LINESTRIPS:s=a.LINE_STRIP;break;default:s=a.TRIANGLES}switch(b){case e.RENDER_DEFAULT:a.program!=this.GLShaderProgram&&(a.useProgram(this.GLShaderProgram),a.program=this.GLShaderProgram),this.mesh.GLAttributes(a,this.GLShaderProgram);break;case e.RENDER_SHADOW:a.program!=this.GLShaderProgramShadow&&(a.useProgram(this.GLShaderProgramShadow),a.program=this.GLShaderProgramShadow),e.setUniform(a,"1f",e.getUniformLocation(a,this.GLShaderProgramShadow,"distance"),f),this.mesh.GLAttributes(a,this.GLShaderProgramShadow);break;case e.RENDER_NORMAL:a.program!=this.GLShaderProgramNormal&&(a.useProgram(this.GLShaderProgramNormal),a.program=this.GLShaderProgramNormal),this.mesh.GLAttributes(a,this.GLShaderProgramNormal);break;case e.RENDER_PICK:a.program!=this.GLShaderProgramPick&&(a.useProgram(this.GLShaderProgramPick),a.program=this.GLShaderProgramPick),this.mesh.GLAttributes(a,this.GLShaderProgramPick),s=a.TRIANGLES}this.GLUniforms(a,b,c);switch(this.mesh.windingOrder){case e.Mesh.WINDING_ORDER_UNKNOWN:a.disable(a.CULL_FACE);break;case e.Mesh.WINDING_ORDER_COUNTER:a.cullFace(a.FRONT);default:}this.mesh.GLfaces?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.mesh.GLfaces),a.drawElements(s,this.mesh.GLfaces.numItems,a.UNSIGNED_SHORT,0)):a.drawArrays(s,0,this.mesh.positions.length/3);switch(this.mesh.windingOrder){case e.Mesh.WINDING_ORDER_UNKNOWN:a.scene.renderer.cullFaces&&a.enable(a.CULL_FACE);break;case e.Mesh.WINDING_ORDER_COUNTER:a.cullFace(a.BACK);default:}var t=this.matrix,u=this.caches;for(var i=0;i<this.instances.length;i++)this.matrix=this.instances[i].getModelMatrix(),this.skeleton&&this.skeleton.setStaticMatrix(this.matrix),this.caches=this.instances[i].caches,this.GLUniforms(a,b,c),this.mesh.GLfaces?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.mesh.GLfaces),a.drawElements(s,this.mesh.GLfaces.numItems,a.UNSIGNED_SHORT,0)):a.drawArrays(s,0,this.mesh.positions.length/3);this.matrix=t,this.caches=u}}}},e.Mesh=function(a,b){e.Assets.registerAsset(this,a),this.GLbuffers=[],this.buffers=[],this.UV=[],this.boneWeights=[],this.setBuffers=[],this.faces={},b!==undefined?this.windingOrder=b:this.windingOrder=e.Mesh.WINDING_ORDER_CLOCKWISE},e.Mesh.WINDING_ORDER_UNKNOWN=2,e.Mesh.WINDING_ORDER_CLOCKWISE=1,e.Mesh.WINDING_ORDER_COUNTER=0,e.augment(e.QuickNotation,e.Mesh),e.augment(e.JSONLoader,e.Mesh),e.augment(e.Events,e.Mesh),e.Mesh.prototype.gl=null,e.Mesh.prototype.className="Mesh",e.Mesh.prototype.GLbuffers=null,e.Mesh.prototype.buffers=null,e.Mesh.prototype.setBuffers=null,e.Mesh.prototype.GLfaces=null,e.Mesh.prototype.faces=null,e.Mesh.prototype.UV=null,e.Mesh.prototype.joints=null,e.Mesh.prototype.invBind=null,e.Mesh.prototype.loaded=!1,e.Mesh.prototype.getBoundingVolume=function(){if(!this.boundingVolume){var a,b,c,d,f,g;for(var h=0;h<this.buffers.length;h++)if(this.buffers[h].name=="position")var i=this.buffers[h].data;for(var h=0;h<i.length;h=h+3)h==0?(a=b=i[h],c=d=i[h+1],f=g=i[h+2]):(a=Math.min(a,i[h]),b=Math.max(b,i[h]),c=Math.min(c,i[h+1]),d=Math.max(d,i[h+1]),f=Math.min(f,i[h+2]),g=Math.max(g,i[h+2]));this.boundingVolume=new e.BoundingVolume(a,b,c,d,f,g)}return this.boundingVolume},e.Mesh.prototype.setJoints=function(a){this.joints=a,this.fireEvent("shaderupdate",{});return this},e.Mesh.prototype.setInvBindMatrix=function(a){this.invBind=a,this.fireEvent("shaderupdate",{});return this},e.Mesh.prototype.setVertexJoints=function(a,b){b||(b=a.length*3/this.positions.length);if(b<5)this.setBuffer("joints1",a,b);else{var c=[],d=[];for(var e=0;e<a.length;e++)e%b<4?c.push(a[e]):d.push(a[e]);this.setBuffer("joints1",c,4),this.setBuffer("joints2",d,b-4)}this.fireEvent("shaderupdate",{});return this},e.Mesh.prototype.setVertexWeights=function(a,b){b||(b=a.length*3/this.positions.length);for(var c=0;c<a.length;c=c+parseInt(b)){var d=0;for(var e=0;e<b;e++)d+=parseFloat(a[c+e]);for(var e=0;e<b;e++)a[c+e]=a[c+e]/d}if(b<4)this.setBuffer("weights1",a,b);else{var f=[],g=[];for(var c=0;c<a.length;c++)c%b<4?f.push(a[c]):g.push(a[c]);this.setBuffer("weights1",f,4),this.setBuffer("weights2",g,b-4)}this.fireEvent("shaderupdate",{});return this},e.Mesh.prototype.clearBuffers=function(){this.GLFaces=null,delete this.GLFaces;for(i in this.buffers)this.buffers[i]=null,delete this.buffers[i];this.buffers=[],this.loaded=!1},e.Mesh.prototype.setUV=function(a){var b=0;for(var c=0;c<a.length;c=c+2)this.UV[b]=a[c],this.UV[b+1]=a[c+1],this.UV[b+2]||(this.UV[b+2]=a[c]),this.UV[b+3]||(this.UV[b+3]=a[c+1]),b=b+4;this.setBuffer("UV",this.UV,4);return this},e.Mesh.prototype.setUV2=function(a){var b=0;for(var c=0;c<a.length;c=c+2)this.UV[b]||(this.UV[b]=a[c]),this.UV[b+1]||(this.UV[b+1]=a[c+1]),this.UV[b+2]=a[c],this.UV[b+3]=a[c+1],b=b+4;this.setBuffer("UV",this.UV,4);return this},e.Mesh.prototype.setPositions=function(a){this.loaded=!0,this.positions=a,this.setBuffer("position",a,3);return this},e.Mesh.prototype.setNormals=function(a){this.normals=a,this.setBuffer("normal",a,3);return this},e.Mesh.prototype.setBuffer=function(a,b,c){for(var d=0;d<b.length;d++)b[d]=parseFloat(b[d]);var e;for(var d=0;d<this.buffers.length;d++)this.buffers[d].name==a&&(e=d);e?this.buffers[e]={name:a,data:b,size:c,GL:!1}:this.buffers.push({name:a,data:b,size:c,GL:!1});return this},e.Mesh.prototype.tangentFromUV=function(a,b,c,d,f,g,h){var i=e.toUnitVec3,j=e.subVec3,k=e.scaleVec3,l=e.dotVec3,m=e.crossVec3;uv21=[f[0]-d[0],f[1]-d[1]],uv31=[g[0]-d[0],g[1]-d[1]],p21=e.subVec3(b,a),p31=e.subVec3(c,a);var n=uv21[0]*uv31[1]-uv31[0]*uv21[1];if(n!=0){n=1/n;var o=j(k(p21,uv31[1]*n),k(p31,uv21[1]*n)),p=j(k(p31,uv21[0]*n),k(p21,uv31[0]*n))}else o=[0,0,0],p=[0,0,0];e.dotVec3(e.crossVec3(p21,p31),h)>0&&(o=k(o,-1),p=k(p,-1));return[o,p]},e.Mesh.prototype.setFaces=function(a){this.faces={data:a,GL:!1},this.normals||this.calcNormals();for(var b=0;b<this.buffers.length;b++){if(this.buffers[b].name=="position")var c=this.buffers[b].data;if(this.buffers[b].name=="UV")var d=this.buffers[b].data;if(this.buffers[b].name=="normal")var f=this.buffers[b].data}if(c&&d){var g=[],h={},i;for(var b=0;b<c.length;b++)g[b]=0;for(var b=0;b<this.faces.data.length;b=b+3){var j=[c[parseInt(this.faces.data[b])*3],c[parseInt(this.faces.data[b])*3+1],c[parseInt(this.faces.data[b])*3+2]],k=[c[parseInt(this.faces.data[b+1])*3],c[parseInt(this.faces.data[b+1])*3+1],c[parseInt(this.faces.data[b+1])*3+2]],l=[c[parseInt(this.faces.data[b+2])*3],c[parseInt(this.faces.data[b+2])*3+1],c[parseInt(this.faces.data[b+2])*3+2]],m=[f[parseInt(this.faces.data[b])*3],f[parseInt(this.faces.data[b])*3+1],f[parseInt(this.faces.data[b])*3+2]],n=[f[parseInt(this.faces.data[b+1])*3],f[parseInt(this.faces.data[b+1])*3+1],f[parseInt(this.faces.data[b+1])*3+2]],o=[f[parseInt(this.faces.data[b+2])*3],f[parseInt(this.faces.data[b+2])*3+1],f[parseInt(this.faces.data[b+2])*3+2]],p=[d[parseInt(this.faces.data[b])*4],d[parseInt(this.faces.data[b])*4+1]],q=[d[parseInt(this.faces.data[b+1])*4],d[parseInt(this.faces.data[b+1])*4+1]],r=[d[parseInt(this.faces.data[b+2])*4],d[parseInt(this.faces.data[b+2])*4+1]],s=this.tangentFromUV(k,j,l,q,p,r,n);h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")]?(h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0][0]+=s[0][0],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0][1]+=s[0][1],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0][2]+=s[0][2],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1][0]+=s[1][0],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1][1]+=s[1][1],h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1][2]+=s[1][2]):h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")]=s,h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")]?(h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][0][0]+=s[0][0],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][0][1]+=s[0][1],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][0][2]+=s[0][2],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][1][0]+=s[1][0],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][1][1]+=s[1][1],h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")][1][2]+=s[1][2]):h[[k[0],k[1],k[2],q[0],q[1],n[0],n[1],n[2]].join(",")]=s,h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")]?(h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][0][0]+=s[0][0],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][0][1]+=s[0][1],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][0][2]+=s[0][2],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][1][0]+=s[1][0],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][1][1]+=s[1][1],h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")][1][2]+=s[1][2]):h[[l[0],l[1],l[2],r[0],r[1],o[0],o[1],o[2]].join(",")]=s}for(var b=0;b<c.length/3;b++){var j=[c[b*3],c[b*3+1],c[b*3+2]],m=[f[b*3],f[b*3+1],f[b*3+2]],p=[d[b*4],d[b*4+1]],t=e.toUnitVec3(h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][0]),u=e.toUnitVec3(h[[j[0],j[1],j[2],p[0],p[1],m[0],m[1],m[2]].join(",")][1]);t&&(g[b*3]=t[0],g[b*3+1]=t[1],g[b*3+2]=t[2])}this.setBuffer("tangent",g,3)}return this},e.Mesh.prototype.GLSetFaceBuffer=function(a){this.GLfaces||(this.GLfaces=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.faces.data),a.STATIC_DRAW),this.GLfaces.itemSize=1,this.GLfaces.numItems=this.faces.data.length},e.Mesh.prototype.GLSetBuffer=function(a,b,c,d){this.GLbuffers[b]||(this.GLbuffers[b]=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.GLbuffers[b]),a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW),this.GLbuffers[b].itemSize=d,this.GLbuffers[b].numItems=c.length/d},e.Mesh.prototype.calcNormals=function(){var a=[],b=this.positions,c=this.faces.data;if(!c){c=[];for(var d=0;d<b.length/3;d++)c[d]=d}for(var d=0;d<c.length;d=d+3){var f=[b[c[d]*3],b[c[d]*3+1],b[c[d]*3+2]],g=[b[c[d+1]*3],b[c[d+1]*3+1],b[c[d+1]*3+2]],h=[b[c[d+2]*3],b[c[d+2]*3+1],b[c[d+2]*3+2]],i=e.subVec3(g,f),j=e.subVec3(h,f),k=e.toUnitVec3(e.crossVec3(i,j));a[c[d]]==undefined&&(a[c[d]]=[]),a[c[d]].push(k),a[c[d+1]]==undefined&&(a[c[d+1]]=[]),a[c[d+1]].push(k),a[c[d+2]]==undefined&&(a[c[d+2]]=[]),a[c[d+2]].push(k)}var l=[];for(d=0;d<a.length;d++){var m=0,n=0,o=0;if(a[d]!=undefined){for(var p=0;p<a[d].length;p++)m+=a[d][p][0],n+=a[d][p][1],o+=a[d][p][2];m/=a[d].length,n/=a[d].length,o/=a[d].length,l[d*3]=m,l[d*3+1]=n,l[d*3+2]=o}}this.setNormals(l)},e.Mesh.prototype.GLAttributes=function(a,b){this.gl=a,this.normals||this.calcNormals();for(var c=0;c<8;c++)a.disableVertexAttribArray(c);!this.faces.GL&&this.faces.data&&this.faces.data.length>0&&(this.GLSetFaceBuffer(a),this.faces.GL=!0);for(c=0;c<this.buffers.length;c++)this.buffers[c].GL||(this.GLSetBuffer(a,this.buffers[c].name,this.buffers[c].data,this.buffers[c].size),this.buffers[c].GL=!0),attribslot=e.getAttribLocation(a,b,this.buffers[c].name),attribslot>-1&&(a.bindBuffer(a.ARRAY_BUFFER,this.GLbuffers[this.buffers[c].name]),a.enableVertexAttribArray(attribslot),a.vertexAttribPointer(attribslot,this.GLbuffers[this.buffers[c].name].itemSize,a.FLOAT,!1,0,0))},e.Light=function(a){e.Assets.registerAsset(this,a),this.color={r:1,g:1,b:1}},e.augment(e.Placeable,e.Light),e.augment(e.Animatable,e.Light),e.augment(e.QuickNotation,e.Light),e.augment(e.JSONLoader,e.Light),e.Light.prototype.className="Light",e.L_POINT=1,e.L_DIR=2,e.L_SPOT=3,e.Light.prototype.constantAttenuation=1,e.Light.prototype.linearAttenuation=.002,e.Light.prototype.quadraticAttenuation=8e-4,e.Light.prototype.spotCosCutOff=.95,e.Light.prototype.spotPMatrix=null,e.Light.prototype.spotExponent=10,e.Light.prototype.color=null,e.Light.prototype.diffuse=!0,e.Light.prototype.specular=!0,e.Light.prototype.samples=0,e.Light.prototype.softness=.01,e.Light.prototype.type=e.L_POINT,e.Light.prototype.frameBuffer=null,e.Light.prototype.renderBuffer=null,e.Light.prototype.texture=null,e.Light.prototype.bufferHeight=256,e.Light.prototype.bufferWidth=256,e.Light.prototype.shadowBias=2,e.Light.prototype.castShadows=!1,e.Light.prototype.getPMatrix=function(){if(!this.spotPMatrix){var a;this.scene&&this.scene.camera?a=this.scene.camera.far:a=1e3,this.spotPMatrix=e.makePerspective(Math.acos(this.spotCosCutOff)/3.14159*360,1,.1,a)}return this.spotPMatrix},e.Light.prototype.setDistance=function(a){this.distance=a;return this},e.Light.prototype.getDistance=function(){return this.distance},e.Light.prototype.setNegativeShadow=function(a){this.negativeShadow=a;return this},e.Light.prototype.getNegative=function(){return this.negativeShadow},e.Light.prototype.setCastShadows=function(a){this.castShadows=a;return this},e.Light.prototype.getCastShadows=function(){return this.castShadows},e.Light.prototype.setShadowBias=function(a){this.shadowBias=a;return this},e.Light.prototype.getShadowBias=function(){return this.shadowBias},e.Light.prototype.setShadowSamples=function(a){this.samples=a;return this},e.Light.prototype.getShadowSamples=function(){return this.samples},e.Light.prototype.setShadowSoftness=function(a){this.softness=a;return this},e.Light.prototype.getShadowSamples=function(){return this.softness},e.Light.prototype.setBufferWidth=function(a){this.bufferWidth=a;return this},e.Light.prototype.getBufferHeight=function(){return this.bufferHeight},e.Light.prototype.setBufferHeight=function(a){this.bufferHeight=a;return this},e.Light.prototype.getBufferWidth=function(){return this.bufferWidth},e.Light.prototype.setSpotCosCutOff=function(a){this.spotPMatrix=null,this.spotCosCutOff=a;return this},e.Light.prototype.getSpotCosCutOff=function(){return this.spotCosCutOff},e.Light.prototype.setSpotExponent=function(a){this.spotExponent=a;return this},e.Light.prototype.getSpotExponent=function(){return this.spotExponent},e.Light.prototype.getAttenuation=function(a,b,c){var d={};d.constant=this.constantAttenuation,d.linear=this.linearAttenuation,d.quadratic=this.quadraticAttenuation;return d},e.Light.prototype.setAttenuation=function(a,b,c){this.constantAttenuation=a,this.linearAttenuation=b,this.quadraticAttenuation=c;return this},e.Light.prototype.setAttenuationConstant=function(a){this.constantAttenuation=a;return this},e.Light.prototype.setAttenuationLinear=function(a){this.linearAttenuation=a;return this},e.Light.prototype.setAttenuationQuadratic=function(a){this.quadraticAttenuation=a;return this},e.Light.prototype.setColor=function(a){a=e.colorParse(a),this.color={r:a.r,g:a.g,b:a.b};return this},e.Light.prototype.setColorR=function(a){this.color.r=a;return this},e.Light.prototype.setColorG=function(a){this.color.g=a;return this},e.Light.prototype.setColorB=function(a){this.color.b=a;return this},e.Light.prototype.getColor=function(){return this.color},e.Light.prototype.getType=function(){return this.type},e.Light.prototype.setType=function(a){this.type=a;return this},e.Light.prototype.GLInit=function(a){this.gl=a,this.type==e.L_SPOT&&!this.texture&&this.createSpotBuffer(a)},e.Light.prototype.createSpotBuffer=function(a){this.frameBuffer=a.createFramebuffer(),this.renderBuffer=a.createRenderbuffer(),this.texture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.texture);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.bufferWidth,this.bufferHeight,0,a.RGBA,a.UNSIGNED_BYTE,null)}catch(b){var c=new Uint8Array(this.bufferWidth*this.bufferHeight*4);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,f(this.bufferWidth),f(this.bufferHeight),0,a.RGBA,a.UNSIGNED_BYTE,c)}a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.bindRenderbuffer(a.RENDERBUFFER,this.renderBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.bufferWidth,this.bufferHeight),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.texture,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this.renderBuffer),a.bindFramebuffer(a.FRAMEBUFFER,null)},e.C_PERSPECTIVE=1,e.C_ORTHO=2,e.Camera=function(a){e.Assets.registerAsset(this,a)},e.augment(e.Placeable,e.Camera),e.augment(e.Animatable,e.Camera),e.augment(e.QuickNotation,e.Camera),e.augment(e.JSONLoader,e.Camera),e.Camera.prototype.className="Camera",e.Camera.prototype.fovy=35,e.Camera.prototype.aspect=1,e.Camera.prototype.near=.1,e.Camera.prototype.far=1e3,e.Camera.prototype.orthoscale=5,e.Camera.prototype.type=e.C_PERSPECTIVE,e.Camera.prototype.pMatrix=null,e.Camera.prototype.getOrthoScale=function(){if(this.type==e.C_ORTHO)return this.orthoscale;e.error("You may only get a scale for a orthographic camera");return 1},e.Camera.prototype.setOrthoScale=function(a){this.type==e.C_ORTHO?(this.orthoscale=a,this.pMatrix=null):e.error("You may only set a scale for a orthographic camera");return this},e.Camera.prototype.getFar=function(){return this.far},e.Camera.prototype.setFar=function(a){this.far=a;return this},e.Camera.prototype.getNear=function(){return this.near},e.Camera.prototype.setNear=function(a){this.near=a;return this},e.Camera.prototype.getType=function(){return this.type},e.Camera.prototype.setType=function(a){a==e.C_PERSPECTIVE||a==e.C_ORTHO?(this.type=a,this.pMatrix=null):e.error("unsuported camera type");return this},e.Camera.prototype.getFovY=function(){if(this.type==e.C_PERSPECTIVE)return this.fovy;e.error("You may only get a yfov for a perspective camera");return 1},e.Camera.prototype.setFovY=function(a){this.type==e.C_PERSPECTIVE?(this.fovy=a,this.ymax=null,this.pMatrix=null):e.error("You may only set a yfov for a perspective camera");return this},e.Camera.prototype.getAspect=function(){if(this.type==e.C_PERSPECTIVE||this.type==e.C_ORTHO)return this.aspect;e.error("You may only set a aspect for a perspective or orthographic camera");return 1},e.Camera.prototype.setAspect=function(a){this.type==e.C_PERSPECTIVE||this.type==e.C_ORTHO?(this.aspect=a,this.pMatrix=null):e.error("You may only set a aspect for a perspective or orthographic camera");return this},e.Camera.prototype.getProjectionMatrix=function(){if(!this.pMatrix)switch(this.type){case e.C_PERSPECTIVE:this.pMatrix=e.makePerspective(this.fovy,this.aspect,this.near,this.far);break;case e.C_ORTHO:this.pMatrix=e.makeOrtho(-this.orthoscale*this.aspect,this.orthoscale*this.aspect,-this.orthoscale,this.orthoscale,this.near,this.far)}return this.pMatrix},e.Camera.prototype.setProjectionMatrix=function(a){this.pMatrix=a;return this},e.Camera.prototype.updateMatrix=function(){var a=this.getPosition(),b=e.translateMatrix(a.x,a.y,a.z);b=e.mulMat4(b,this.getRotMatrix()),this.parent&&(b=e.mulMat4(this.parent.getModelMatrix(),b)),this.matrix=e.inverseMat4(b)},e.Camera.prototype.getViewMatrix=function(){(!this.matrix||!this.rotmatrix)&&this.updateMatrix();return this.matrix},e.Camera.prototype.getViewProjection=function(){var a=this.getProjectionMatrix(),b=this.getViewMatrix();if(a!=this.vpProjectionMatrix||b!=this.vpViewMatrix)this.cameraViewProjection=e.mulMat4(a,b),this.vpProjectionMatrix=a,this.vpViewMatrix=b;return this.cameraViewProjection},e.FOG_NONE=1,e.FOG_LINEAR=2,e.FOG_QUADRATIC=3,e.Scene=function(a){e.Assets.registerAsset(this,a),this.children=[],this.camera=new e.Camera,this.backgroundColor={r:1,g:1,b:1,a:1},this.ambientColor={r:0,g:0,b:0},this.fogColor={r:.5,g:.5,b:.5},this.passes=[]},e.augment(e.Group,e.Scene),e.augment(e.QuickNotation,e.Scene),e.augment(e.JSONLoader,e.Scene),e.Scene.prototype.camera=null,e.Scene.prototype.className="Scene",e.Scene.prototype.renderer=null,e.Scene.prototype.backgroundColor=null,e.Scene.prototype.filter=null,e.Scene.prototype.fogColor=null,e.Scene.prototype.ambientColor=null,e.Scene.prototype.fogNear=10,e.Scene.prototype.fogFar=80,e.Scene.prototype.fogType=e.FOG_NONE,e.Scene.prototype.passes=null,e.Scene.prototype.culling=!0,e.Scene.prototype.getFogType=function(){return this.fogType},e.Scene.prototype.setFogType=function(a){this.fogType=a;return this},e.Scene.prototype.getFogFar=function(){return this.fogFar},e.Scene.prototype.setFogFar=function(a){this.fogFar=a;return this},e.Scene.prototype.getFogNear=function(){return this.fogNear},e.Scene.prototype.setFogNear=function(a){this.fogNear=a;return this},e.Scene.prototype.getFogColor=function(){return this.fogColor},e.Scene.prototype.setFogColor=function(a){a=e.colorParse(a),this.fogColor={r:a.r,g:a.g,b:a.b};return this},e.Scene.prototype.getBackgroundColor=function(){return this.backgroundColor},e.Scene.prototype.setBackgroundColor=function(a){a=e.colorParse(a),this.backgroundColor={r:a.r,g:a.g,b:a.b,a:a.a};return this},e.Scene.prototype.getAmbientColor=function(){return this.ambientColor},e.Scene.prototype.setAmbientColor=function(a){a=e.colorParse(a),this.ambientColor={r:a.r,g:a.g,b:a.b},this.renderer&&this.renderer.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1);return this},e.Scene.prototype.setAmbientColorR=function(a){this.ambientColor.r=a;return this},e.Scene.prototype.setAmbientColorG=function(a){this.ambientColor.g=a;return this},e.Scene.prototype.setAmbientColorB=function(a){this.ambientColor.b=a;return this},e.Scene.prototype.setCamera=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.camera=a;return this},e.Scene.prototype.getCamera=function(){return this.camera},e.Scene.prototype.setCull=function(a){this.culling=a;return this},e.Scene.prototype.getCull=function(){return this.culling},e.Scene.prototype.GLInit=function(a){this.gl=a,a.lights=this.getLights(),this.camera.setAspect(this.renderer.canvas.width/this.renderer.canvas.height),this.renderer.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1);for(var b=0;b<this.children;b++)this.children[b].GLInit&&children[b].GLInit(a)},e.Scene.prototype.GLDestroy=function(a){},e.Scene.sortFunc=function(a,b){return a.zdepth-b.zdepth},e.Scene.prototype.zSort=function(a,b){var c=a.scene.camera.getViewMatrix(),d;for(var f=0;f<b.length;f++){if(b[f].object.getBoundingVolume)var g=b[f].object.getBoundingVolume().getCenter();else var h=b[f].object.getModelMatrix(),g=[h[3],h[7],h[11]];b[f].zdepth=g[0]*c[8]+g[1]*c[9]+g[2]*c[10]+c[11]}b.sort(e.Scene.sortFunc);return b},e.Scene.prototype.setFilter2d=function(a){this.filter=a;return this},e.Scene.prototype.getFilter2d=function(a){return this.filter},e.Scene.prototype.getFrameBuffer=function(a){if(this.filter)return this.filter.getFrameBuffer(a);return null},e.Scene.prototype.objectsInViewFrustum=function(a,b){var c,d=[],f=e.cameraViewProjectionToPlanes(b);for(var g=0;g<a.length;g++){c=a[g];if(c.getBoundingVolume&&c.cull){var h=c.getBoundingVolume(),i=h.getCenter(),j=h.getSphereRadius();if(e.sphereInFrustumPlanes([i[0],i[1],i[2],j],f)){var k=h.getCornerPoints();e.pointsInFrustumPlanes(k,f)&&d.push(c)}}else d.push(c)}return d},e.Scene.prototype.unfoldRenderObject=function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c];if(d.getMultiMaterials){var e=d.getMultiMaterials();for(var f=0;f<e.length;f++){var g=e[f].getMaterial(),h=e[f].getMesh();g.meshIdx||(g.matIdx=f),g.meshIdx||(g.meshIdx=f),b.push({object:d,multiMaterial:f})}}else b.push({object:d,multiMaterial:0})}return b},e.Scene.prototype.stateSort=function(a,b){if(!a.object.GLShaderProgram)return 1;if(!b.object.GLShaderProgram)return-1;var c=a.object.GLShaderProgram.progIdx,d=b.object.GLShaderProgram.progIdx;if(c>d)return 1;if(c<d)return-1;if(!a.object.multimaterials||!b.object.multimaterials)return-1;var c=a.object.multimaterials[a.multiMaterial].getMaterial().matIdx,d=b.object.multimaterials[b.multiMaterial].getMaterial().matIdx;if(c>d)return 1;if(c<d)return-1;var e=a.object.multimaterials[a.multiMaterial].getMesh(),f=a.object.multimaterials[a.multiMaterial].getMesh();if(!e)return-1;if(!f)return 1;var c=e.meshIdx,d=f.meshIdx;return c>d?1:c<d?-1:0},e.Scene.prototype.render=function(a){this.camera.lookAt&&this.camera.Lookat(this.camera.lookAt),this.animate(),a.lights=this.getLights();var b=a.lights;a.scene=this,this.lastMaterial=null,a.disable(a.BLEND),this.framebuffer=this.getFrameBuffer(a);var c=this.getObjects(),d=this.camera.getViewProjection();if(this.culling){var d=this.camera.getViewProjection();c=this.objectsInViewFrustum(c,d)}c=this.unfoldRenderObject(c),c=c.sort(this.stateSort);for(var g=0;g<b.length;g++)if(b[g].castShadows){b[g].gl||b[g].GLInit(a);var h=this.camera.matrix,i=this.camera.getProjectionMatrix();b[g].s_cache||(b[g].s_cache={});if(b[g].s_cache.pmatrix!=b[g].getPMatrix()||b[g].s_cache.mvmatrix!=b[g].getModelMatrix())b[g].s_cache.pmatrix=b[g].getPMatrix(),b[g].s_cache.mvmatrix=b[g].getModelMatrix(),b[g].s_cache.imvmatrix=e.inverseMat4(b[g].getModelMatrix()),b[g].s_cache.smatrix=e.mulMat4(b[g].getPMatrix(),b[g].s_cache.imvmatrix),b[g].shadowRendered=!1;a.bindFramebuffer(a.FRAMEBUFFER,b[g].frameBuffer),a.viewport(0,0,f(b[g].bufferWidth),f(b[g].bufferHeight)),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.camera.setProjectionMatrix(b[g].s_cache.pmatrix),this.camera.matrix=b[g].s_cache.imvmatrix;for(var j=0;j<c.length;j++)c[j].object.GLRender(a,e.RENDER_SHADOW,j,c[j].multiMaterial,b[g].distance);a.flush(),this.camera.matrix=h,this.camera.setProjectionMatrix(i),a.bindTexture(a.TEXTURE_2D,b[g].texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_2D),a.bindFramebuffer(a.FRAMEBUFFER,null)}this.camera.animation&&this.camera.animate(),this.getPasses(a,c);var h=this.camera.matrix,i=this.camera.getProjectionMatrix();this.allowPasses=!1;while(this.passes.length>0){var k=this.passes.pop();a.bindFramebuffer(a.FRAMEBUFFER,k.frameBuffer),this.camera.matrix=k.cameraMatrix,this.camera.setProjectionMatrix(k.projectionMatrix),this.renderPass(a,c,0,0,k.width,k.height,e.RENDER_DEFAULT,k.self)}this.camera.matrix=h,this.camera.setProjectionMatrix(i),a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffer),this.renderPass(a,c,this.renderer.getViewportOffsetX(),this.renderer.getViewportOffsetY(),this.renderer.getViewportWidth(),this.renderer.getViewportHeight()),this.applyFilter(a,c,null),this.allowPasses=!0},e.Scene.prototype.getPasses=function(a,b){for(var c=0;c<b.length;c++)b[c].object.GLRender(a,e.RENDER_NULL,0,b[c].multiMaterial)},e.Scene.prototype.renderPass=function(a,b,c,d,f,g,h,i){a.clearDepth(1),a.depthFunc(a.LEQUAL),a.viewport(c,d,f,g),a.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),h?a.clear(a.DEPTH_BUFFER_BIT|a.COLOR_BUFFER_BIT|a.STENCIL_BUFFER_BIT):(a.scissor(c,d,f,g),a.enable(a.SCISSOR_TEST),this.renderer.GLClear(),a.disable(a.SCISSOR_TEST)),h||(h=e.RENDER_DEFAULT);var j=[];a.disable(a.BLEND);for(var k=0;k<b.length;k++)b[k].object.zTrans||b[k]==i?b[k]!=i&&j.push(b[k]):b[k].object.GLRender(a,h,0,b[k].multiMaterial);a.enable(a.BLEND),j=this.zSort(a,j);for(var k=0;k<j.length;k++)b[k]!=i&&j[k].object.GLRender(a,h,0,j[k].multiMaterial)},e.Scene.prototype.applyFilter=function(a,b,c){this.filter&&this.filter.renderDepth&&(a.clearDepth(1),a.depthFunc(a.LEQUAL),a.bindFramebuffer(a.FRAMEBUFFER,this.filter.getDepthBuffer(a)),this.renderPass(a,b,0,0,this.filter.getDepthBufferWidth(),this.filter.getDepthBufferHeight(),e.RENDER_SHADOW)),this.filter&&this.filter.renderNormal&&(a.clearDepth(1),a.depthFunc(a.LEQUAL),a.bindFramebuffer(a.FRAMEBUFFER,this.filter.getNormalBuffer(a)),this.renderPass(a,b,0,0,this.filter.getNormalBufferWidth(),this.filter.getNormalBufferHeight(),e.RENDER_NORMAL)),this.filter&&this.filter.GLRender(a,c)},e.Scene.prototype.addRenderPass=function(a,b,c,d,e,f){this.allowPasses&&this.passes.push({frameBuffer:a,cameraMatrix:b,projectionMatrix:c,height:e,width:d,self:f});return this},e.Scene.prototype.ray=function(a,b){var c=this.renderer.gl,d=this.camera.matrix,f=this.camera.pMatrix;this.camera.matrix=e.inverseMat4(e.Mat4([b[2],b[1],b[0],a[0],b[0],b[2],b[1],a[1],b[1],b[0],b[2],a[2],0,0,0,1])),this.pickPMatrix||(this.pickPMatrix=e.makeOrtho(-1e-4,1e-4,-1e-4,1e-4,this.camera.near,this.camera.far)),this.camera.pMatrix=this.pickPMatrix,c.viewport(0,0,8,1),c.clear(c.DEPTH_BUFFER_BIT),c.disable(c.BLEND),c.scene=this;var g=this.getObjects();for(var h=0;h<g.length;h++)g[h].pickable&&g[h].GLRender(c,e.RENDER_PICK,h+1);c.flush();var i=new Uint8Array(32);c.readPixels(0,0,8,1,c.RGBA,c.UNSIGNED_BYTE,i);var j=[i[4]/255,i[5]/255,i[6]/255],k=Math.sqrt(j[0]*j[0]+j[1]*j[1]+j[2]*j[2])*.5;j=[j[0]/k-1,j[1]/k-1,j[2]/k-1];var l=g[i[0]+i[1]*256+i[2]*65536-1],m=(i[10]/255+.00390625*i[9]/255+152587890625e-16*i[8]/255)*this.camera.far,n=[];n[0]=i[14]/255+.00390625*i[13]/255+152587890625e-16*i[12]/255,n[1]=i[18]/255+.00390625*i[17]/255+152587890625e-16*i[16]/255,c.bindFramebuffer(c.FRAMEBUFFER,null),c.viewport(0,0,this.renderer.canvas.width,this.renderer.canvas.height),this.camera.matrix=d,this.camera.pMatrix=f;if(l)return{object:l,distance:m,coord:[a[0]-b[0]*m,a[1]-b[1]*m,a[2]-b[2]*m],normal:j,texture:n};return null},e.Scene.prototype.pick=function(a,b){var c=this.makeRay(a,b);if(!c)return null;return this.ray(c.origin,c.coord)},e.Scene.prototype.makeRay=function(a,b){if(this.camera){if(this.camera.matrix&&this.camera.pMatrix){var c=this.renderer.getViewportHeight(),d=this.renderer.getViewportWidth(),f=this.renderer.getViewportOffsetX(),g=this.renderer.getViewportHeight()-this.renderer.canvas.height+this.renderer.getViewportOffsetY(),h=((a-f)/d-.5)*2,i=-((b+g)/c-.5)*2,j=e.mulMat4(e.inverseMat4(this.camera.matrix),e.inverseMat4(this.camera.pMatrix)),k=e.mulMat4Vec4(j,[h,i,-1,1]);k=[k[0]/k[3],k[1]/k[3],k[2]/k[3]];var l=e.mulMat4Vec4(j,[h,i,1,1]);l=[-(l[0]/l[3]-k[0]),-(l[1]/l[3]-k[1]),-(l[2]/l[3]-k[2])],l=e.toUnitVec3(l);return{origin:k,coord:l}}return null}e.error("No camera set for picking");return null},e.Renderer=function(a,b){this.viewport=[],this.canvas=a;try{this.gl=a.getContext("experimental-webgl",{alpha:!0,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!0})}catch(c){}if(!this.gl){console.log("GLGE err:",typeof globalNoWebGLError=="undefined");if(b||typeof globalNoWebGLError!="undefined"){b();throw"cannot create webgl context"}var d=document.createElement("div");d.setAttribute("style","position: absolute; top: 10px; left: 10px; font-family: sans-serif; font-size: 14px; padding: 10px;background-color: #fcffcb;color: #800; width: 200px; border:2px solid #f00"),d.innerHTML="Cannot detect webgl please download a compatible browser",document.getElementsByTagName("body")[0].appendChild(d);throw"cannot create webgl context"}try{this.gl.canvas=a}catch(c){}this.gl.getProgramParameter||(this.gl.getProgramParameter=this.gl.getProgrami),this.gl.getShaderParameter||(this.gl.getShaderParameter=this.gl.getShaderi),this.gl.uniformMatrix4fvX=this.gl.uniformMatrix4fv,this.gl.uniformMatrix4fv=function(a,b,c){b?(e.mat4gl(e.transposeMat4(c),c),this.uniformMatrix4fvX(a,!1,c)):this.uniformMatrix4fvX(a,!1,c)};var f=this.gl;this.gl.clearDepth(1),this.gl.clearStencil(0),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ZERO,this.gl.ONE)},e.augment(e.QuickNotation,e.Renderer),e.Renderer.prototype.gl=null,e.Renderer.prototype.scene=null,e.C_STENCIL=1,e.C_DEPTH=2,e.C_COLOR=4,e.C_ALL=7,e.Renderer.prototype.clearType=e.C_ALL,e.Renderer.prototype.setViewportWidth=function(a){this.viewport[0]=a;return this},e.Renderer.prototype.setViewportHeight=function(a){this.viewport[1]=a;return this},e.Renderer.prototype.setViewportOffsetX=function(a){this.viewport[2]=a;return this},e.Renderer.prototype.setViewportOffsetY=function(a){this.viewport[3]=a;return this},e.Renderer.prototype.clearViewport=function(){this.viewport=[]},e.Renderer.prototype.getViewportWidth=function(){return this.viewport.length>0?this.viewport[0]:this.canvas.width},e.Renderer.prototype.getViewportHeight=function(){return this.viewport.length>0?this.viewport[1]:this.canvas.height},e.Renderer.prototype.getViewportOffsetX=function(){return this.viewport.length>0?this.viewport[2]:0},e.Renderer.prototype.getViewportOffsetY=function(){return this.viewport.length>0?this.viewport[3]:0},e.Renderer.prototype.setClearType=function(a){this.clearType=a;return this},e.Renderer.prototype.getClearType=function(){return this.clearType},e.Renderer.prototype.GLClear=function(){var a=this.gl,b=this.clearType,c=0;b&e.C_COLOR==e.C_COLOR&&(c=c|a.COLOR_BUFFER_BIT),b&e.C_DEPTH==e.C_DEPTH&&(c=c|a.DEPTH_BUFFER_BIT),b&e.C_STENCIL==e.C_STENCIL&&(c=c|a.STENCIL_BUFFER_BIT),a.clear(c)},e.Renderer.prototype.getScene=function(){return this.scene},e.Renderer.prototype.setScene=function(a){a.renderer=this,this.scene=a,a.GLInit(this.gl),this.render(),a.camera.matrix=null;return this},e.Renderer.prototype.render=function(){this.cullFaces&&this.gl.enable(this.gl.CULL_FACE),this.scene&&this.scene.render(this.gl),!this.rendered&&this.scene&&(this.scene.render(this.gl),this.rendered=!0)},e.Texture=function(a){e.Assets.registerAsset(this,a)},e.augment(e.QuickNotation,e.Texture),e.augment(e.JSONLoader,e.Texture),e.Texture.prototype.className="Texture",e.Texture.prototype.image=null,e.Texture.prototype.glTexture=null,e.Texture.prototype.url=null,e.Texture.prototype.getSrc=function(){return this.url},e.Texture.prototype.setSrc=function(a){this.url=a,this.state=0,this.image=new Image;var b=this;this.image.onload=function(){b.state=1},this.image.src=a,this.glTexture&&this.gl&&(this.gl.deleteTexture(this.glTexture),this.glTexture=null);return this},e.Texture.prototype.doTexture=function(a){this.gl=a,this.glTexture||(this.glTexture=a.createTexture()),this.state==1&&(a.bindTexture(a.TEXTURE_2D,this.glTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.image),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),this.state=2),a.bindTexture(a.TEXTURE_2D,this.glTexture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT);return this.state==2?!0:!1},e.TextureCanvas=function(a){e.Assets.registerAsset(this,a),this.canvas=document.createElement("canvas")},e.augment(e.QuickNotation,e.TextureCanvas),e.augment(e.JSONLoader,e.TextureCanvas),e.TextureCanvas.prototype.className="TextureCanvas",e.TextureCanvas.prototype.glTexture=null,e.TextureCanvas.prototype.autoUpdate=!0,e.TextureCanvas.prototype.getAutoUpdate=function(){return this.autoUpdate},e.TextureCanvas.prototype.setAutoUpdate=function(a){this.autoUpdate=a;return this},e.TextureCanvas.prototype.getCanvas=function(){return this.canvas},e.TextureCanvas.prototype.setCanvas=function(a){this.canvas=a;return this},e.TextureCanvas.prototype.setHeight=function(a){this.canvas.height=a;return this},e.TextureCanvas.prototype.setWidth=function(a){this.canvas.width=a;return this},e.TextureCanvas.prototype.getHeight=function(){return this.canvas.height},e.TextureCanvas.prototype.getWidth=function(){return this.canvas.width},e.TextureCanvas.prototype.doTexture=function(a){this.gl=a,this.glTexture?(a.bindTexture(a.TEXTURE_2D,this.glTexture),(this.autoUpdate||this.doUpdate)&&this.updateCanvas(a)):(this.glTexture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.glTexture),this.updateCanvas(a)),this.doUpdate=!1;return!0},e.TextureCanvas.prototype.update=function(){this.doUpdate=!0},e.TextureCanvas.prototype.updateCanvas=function(a){var b=this.canvas;a.bindTexture(a.TEXTURE_2D,this.glTexture);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b)}catch(c){a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b,null)}a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_2D)},e.TextureVideo=function(a){e.Assets.registerAsset(this,a),this.video=document.createElement("video"),this.video.style.display="none",this.video.setAttribute("loop","loop"),this.video.autoplay=!0,this.video.addEventListener("ended",function(){this.play()},!0),document.getElementsByTagName("body")[0].appendChild(this.video),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")},e.augment(e.QuickNotation,e.TextureVideo),e.augment(e.JSONLoader,e.TextureVideo),e.TextureVideo.prototype.className="TextureVideo",e.TextureVideo.prototype.glTexture=null,e.TextureVideo.prototype.getVideo=function(){return this.video},e.TextureVideo.prototype.setVideo=function(a){this.video=a;return this},e.TextureVideo.prototype.setSrc=function(a){this.video.src=a;return this},e.TextureVideo.prototype.getSrc=function(a){return this.video.src},e.TextureVideo.prototype.doTexture=function(a){this.gl=a,this.glTexture?(a.bindTexture(a.TEXTURE_2D,this.glTexture),this.updateTexture(a)):(this.glTexture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.glTexture),this.updateTexture(a));return!0},e.TextureVideo.prototype.updateTexture=function(a){var b=this.video;a.bindTexture(a.TEXTURE_2D,this.glTexture);if(b.readyState>0){b.height<=0&&(b.style.display="",b.height=b.offsetHeight,b.width=b.offsetWidth,b.style.display="none"),this.canvas.height=b.height,this.canvas.width=b.width,this.ctx.drawImage(b,0,0);try{a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas)}catch(c){a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas,null)}a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_2D)}},e.TextureCamera=function(a){e.Assets.registerAsset(this,a)},e.augment(e.QuickNotation,e.TextureCamera),e.augment(e.JSONLoader,e.TextureCamera),e.TextureCamera.prototype.className="Texture",e.TextureCamera.prototype.texture=null,e.TextureCamera.prototype.glTexture=null,e.TextureCamera.prototype.object=null,e.TextureCamera.prototype.camera=null,e.TextureCamera.prototype.bufferHeight=0,e.TextureCamera.prototype.bufferWidth=0,e.TextureCamera.prototype.mirrorAxis=e.NONE,e.TextureCamera.prototype.clipAxis=e.NONE,e.TextureCamera.prototype.setBufferWidth=function(a){this.bufferWidth=a,this.update=!0;return this},e.TextureCamera.prototype.getBufferWidth=function(){return this.bufferWidth},e.TextureCamera.prototype.setBufferHeight=function(a){this.bufferHeight=a,this.update=!0;return this},e.TextureCamera.prototype.getBufferHeight=function(){return this.bufferHeight},e.TextureCamera.prototype.setClipAxis=function(a){this.clipAxis=a;return this},e.TextureCamera.prototype.getClipAxis=function(){return this.clipAxis},e.TextureCamera.prototype.setMirrorAxis=function(a){this.mirrorAxis=a;return this},e.TextureCamera.prototype.getMirrorAxis=function(){return this.mirrorAxis},e.TextureCamera.prototype.setCamera=function(a){this.camera=a;return this},e.TextureCamera.prototype.getCamera=function(){return this.camera},e.TextureCamera.prototype.doTexture=function(a,b){if(this.camera){this.gl=a;var c=b.getModelMatrix(),d=a.scene.camera.getProjectionMatrix(),f=this.camera.getViewMatrix(),g;if(this.mirrorAxis)switch(this.mirrorAxis){case e.XAXIS:g=e.mulMat4(e.mulMat4(e.mulMat4(f,c),e.scaleMatrix(-1,1,1)),e.inverseMat4(c));break;case e.YAXIS:g=e.mulMat4(e.mulMat4(e.mulMat4(f,c),e.scaleMatrix(1,-1,1)),e.inverseMat4(c));break;case e.ZAXIS:g=e.mulMat4(e.mulMat4(e.mulMat4(f,c),e.scaleMatrix(1,1,-1)),e.inverseMat4(c))}else g=f;if(this.clipAxis){var h;switch(this.clipAxis){case e.NEG_XAXIS:var i=e.toUnitVec3([-c[0],-c[4],-c[8]]);h=[i[0],i[1],i[2],-e.dotVec3([c[3],c[7],c[11]],i)];break;case e.POS_XAXIS:var i=e.toUnitVec3([c[0],c[4],c[8]]);h=[i[0],i[1],i[2],-e.dotVec3([c[3],c[7],c[11]],i)];break;case e.NEG_YAXIS:var i=e.toUnitVec3([-c[1],-c[5],-c[9]]);h=[i[0],i[1],i[2],-e.dotVec3([c[3],c[7],c[11]],i)];break;case e.POS_YAXIS:var i=e.toUnitVec3([c[1],c[5],c[9]]);h=[i[0],i[1],i[2],-e.dotVec3([c[3],c[7],c[11]],i)];break;case e.NEG_ZAXIS:var i=e.toUnitVec3([-c[2],-c[6],-c[10]]);h=[i[0],i[1],i[2],-e.dotVec3([c[3],c[7],c[11]],i)-.5];break;case e.POS_ZAXIS:var i=e.toUnitVec3([c[2],c[6],c[10]]);h=[i[0],i[1],i[2],-e.dotVec3([c[3],c[7],c[11]],i)-.5]}var j=e.transposeMat4(e.inverseMat4(e.mulMat4(d,g)));h=e.mulMat4Vec4(j,h),h=e.scaleVec4(h,d[10]),h[3]-=1,h[2]<0&&e.scaleVec4(h,-1);var k=[1,0,0,0,0,1,0,0,h[0],h[1],h[2],h[3],0,0,0,1];d=e.mulMat4(k,d)}var l=this.bufferHeight?this.bufferHeight:a.scene.renderer.canvas.height,m=this.bufferWidth?this.bufferWidth:a.scene.renderer.canvas.width;if(!this.glTexture||this.update){this.createFrameBuffer(a),a.scene.addRenderPass(this.frameBuffer,g,a.scene.camera.getProjectionMatrix(),m,l,b),a.bindTexture(a.TEXTURE_2D,this.glTexture),this.update=!1;return!1}a.bindTexture(a.TEXTURE_2D,this.glTexture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.scene.addRenderPass(this.frameBuffer,g,d,m,l,b);return!0}return!1},e.TextureCamera.prototype.registerPasses=e.TextureCamera.prototype.doTexture,e.TextureCamera.prototype.createFrameBuffer=function(a){var b=this.bufferHeight?this.bufferHeight:a.scene.renderer.canvas.height,c=this.bufferWidth?this.bufferWidth:a.scene.renderer.canvas.width;this.frameBuffer||(this.frameBuffer=a.createFramebuffer()),this.renderBuffer||(this.renderBuffer=a.createRenderbuffer()),this.glTexture||(this.glTexture=a.createTexture()),a.bindTexture(a.TEXTURE_2D,this.glTexture);var d=new Uint8Array(c*b*4);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,c,b,0,a.RGBA,a.UNSIGNED_BYTE,d),a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.bindRenderbuffer(a.RENDERBUFFER,this.renderBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,c,b),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this.renderBuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.glTexture,0),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null)},e.TextureCube=function(a){e.Assets.registerAsset(this,a)},e.augment(e.QuickNotation,e.TextureCube),e.augment(e.JSONLoader,e.TextureCube),e.TextureCube.prototype.className="TextureCube",e.TextureCube.prototype.posX=null,e.TextureCube.prototype.negX=null,e.TextureCube.prototype.posY=null,e.TextureCube.prototype.negY=null,e.TextureCube.prototype.posZ=null,e.TextureCube.prototype.negZ=null,e.TextureCube.prototype.texture=null,e.TextureCube.prototype.glTexture=null,e.TextureCube.prototype.loadState=0,e.TextureCube.prototype.setSrc=function(a,b,c){this.url=a,this.state=0,this[b]=new Image;var d=this;this[b].onload=function(){d.loadState+=c},this[b].src=a,this.glTexture&&this.gl&&(this.gl.deleteTexture(this.glTexture),this.glTexture=null);return this},e.TextureCube.prototype.setSrcPosX=function(a){this.setSrc(a,"posX",1);return this},e.TextureCube.prototype.setSrcNegX=function(a){this.setSrc(a,"negX",2);return this},e.TextureCube.prototype.setSrcPosY=function(a){this.setSrc(a,"posY",4);return this},e.TextureCube.prototype.setSrcNegY=function(a){typeof a!="string"?(this.negY=a,this.loadState+=8):this.setSrc(a,"negY",8);return this},e.TextureCube.prototype.setSrcPosZ=function(a){this.setSrc(a,"posZ",16);return this},e.TextureCube.prototype.setSrcNegZ=function(a){this.setSrc(a,"negZ",32);return this},e.TextureCube.prototype.doTexture=function(a,b){this.gl=a,this.glTexture||(this.glTexture=a.createTexture()),a.bindTexture(a.TEXTURE_CUBE_MAP,this.glTexture),this.loadState==63&&this.state==0&&(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.posX),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.negX),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.posY),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.negY),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.posZ),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.negZ),a.generateMipmap(a.TEXTURE_CUBE_MAP),a.bindTexture(a.TEXTURE_CUBE_MAP,null),this.state=1),a.bindTexture(a.TEXTURE_CUBE_MAP,this.glTexture);return this.state==1?!0:!1},e.MaterialLayer=function(a){e.Assets.registerAsset(this,a),this.blendMode=e.BL_MIX},e.augment(e.Animatable,e.MaterialLayer),e.augment(e.QuickNotation,e.MaterialLayer),e.augment(e.JSONLoader,e.MaterialLayer),e.augment(e.Events,e.MaterialLayer),e.MaterialLayer.prototype.className="MaterialLayer",e.MaterialLayer.prototype.texture=null,e.MaterialLayer.prototype.blendMode=null,e.MaterialLayer.prototype.mapto=e.M_COLOR,e.MaterialLayer.prototype.mapinput=e.UV1,e.MaterialLayer.prototype.scaleX=1,e.MaterialLayer.prototype.offsetX=0,e.MaterialLayer.prototype.rotX=0,e.MaterialLayer.prototype.scaleY=1,e.MaterialLayer.prototype.offsetY=0,e.MaterialLayer.prototype.rotY=0,e.MaterialLayer.prototype.scaleZ=1,e.MaterialLayer.prototype.offsetZ=0,e.MaterialLayer.prototype.rotZ=0,e.MaterialLayer.prototype.dScaleX=0,e.MaterialLayer.prototype.dOffsetX=0,e.MaterialLayer.prototype.dRotX=0,e.MaterialLayer.prototype.dScaleY=0,e.MaterialLayer.prototype.dOffsetY=0,e.MaterialLayer.prototype.dRotY=0,e.MaterialLayer.prototype.dScaleZ=0,e.MaterialLayer.prototype.dOffsetZ=0,e.MaterialLayer.prototype.dRotZ=0,e.MaterialLayer.prototype.alpha=1,e.MaterialLayer.prototype.height=.05,e.MaterialLayer.prototype.matrix=null,e.MaterialLayer.prototype.getMatrix=function(){if(!this.matrix){var a=this.getOffset(),b=this.getScale(),c=this.getRotation();this.matrix=e.mulMat4(e.mulMat4(e.translateMatrix(a.x,a.y,a.z),e.scaleMatrix(b.x,b.y,b.z)),e.rotateMatrix(c.x,c.y,c.z))}return this.matrix},e.MaterialLayer.prototype.setHeight=function(a){this.height=a;return this},e.MaterialLayer.prototype.getHeight=function(){return this.height},e.MaterialLayer.prototype.setAlpha=function(a){this.alpha=a;return this},e.MaterialLayer.prototype.getAlpha=function(){return this.alpha},e.MaterialLayer.prototype.setTexture=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.texture=a,this.fireEvent("shaderupdate",{});return this},e.MaterialLayer.prototype.getTexture=function(){return this.texture},e.MaterialLayer.prototype.setMapto=function(a){this.mapto=a,this.fireEvent("shaderupdate",{});return this},e.MaterialLayer.prototype.getMapto=function(){return this.mapto},e.MaterialLayer.prototype.setMapinput=function(a){this.mapinput=a,this.fireEvent("shaderupdate",{});return this},e.MaterialLayer.prototype.getMapinput=function(){return this.mapinput},e.MaterialLayer.prototype.getOffset=function(){var a={};a.x=parseFloat(this.getOffsetX())+parseFloat(this.getDOffsetX()),a.y=parseFloat(this.getOffsetY())+parseFloat(this.getDOffsetY()),a.z=parseFloat(this.getOffsetZ())+parseFloat(this.getDOffsetZ());return a},e.MaterialLayer.prototype.getRotation=function(){var a={};a.x=parseFloat(this.getRotX())+parseFloat(this.getDRotX()),a.y=parseFloat(this.getRotY())+parseFloat(this.getDRotY()),a.z=parseFloat(this.getRotZ())+parseFloat(this.getDRotZ());return a},e.MaterialLayer.prototype.getScale=function(){var a={};a.x=parseFloat(this.getScaleX())+parseFloat(this.getDScaleX()),a.y=parseFloat(this.getScaleY())+parseFloat(this.getDScaleY()),a.z=parseFloat(this.getScaleZ())+parseFloat(this.getDScaleZ());return a},e.MaterialLayer.prototype.setOffsetX=function(a){this.matrix=null,this.offsetX=a;return this},e.MaterialLayer.prototype.getOffsetX=function(){return this.offsetX},e.MaterialLayer.prototype.setOffsetY=function(a){this.matrix=null,this.offsetY=a;return this},e.MaterialLayer.prototype.getOffsetY=function(){return this.offsetY},e.MaterialLayer.prototype.setOffsetZ=function(a){this.matrix=null,this.offsetZ=a;return this},e.MaterialLayer.prototype.getOffsetZ=function(){return this.offsetZ},e.MaterialLayer.prototype.setDOffsetX=function(a){this.matrix=null,this.dOffsetX=a;return this},e.MaterialLayer.prototype.getDOffsetX=function(){return this.dOffsetX},e.MaterialLayer.prototype.setDOffsetY=function(a){this.matrix=null,this.dOffsetY=a;return this},e.MaterialLayer.prototype.getDOffsetY=function(){return this.dOffsetY},e.MaterialLayer.prototype.setDOffsetZ=function(a){this.matrix=null,this.dOffsetZ=a;return this},e.MaterialLayer.prototype.getDOffsetZ=function(){return this.dOffsetZ},e.MaterialLayer.prototype.setScaleX=function(a){this.matrix=null,this.scaleX=a;return this},e.MaterialLayer.prototype.getScaleX=function(){return this.scaleX},e.MaterialLayer.prototype.setScaleY=function(a){this.matrix=null,this.scaleY=a;return this},e.MaterialLayer.prototype.getScaleY=function(){return this.scaleY},e.MaterialLayer.prototype.setScaleZ=function(a){this.matrix=null,this.scaleZ=a;return this},e.MaterialLayer.prototype.getScaleZ=function(){return this.scaleZ},e.MaterialLayer.prototype.setDScaleX=function(a){this.matrix=null,this.dScaleX=a;return this},e.MaterialLayer.prototype.getDScaleX=function(){return this.dScaleX},e.MaterialLayer.prototype.setDScaleY=function(a){this.matrix=null,this.dScaleY=a;return this},e.MaterialLayer.prototype.getDScaleY=function(){return this.dScaleY},e.MaterialLayer.prototype.setDScaleZ=function(a){this.matrix=null,this.dScaleZ=a;return this},e.MaterialLayer.prototype.getDScaleZ=function(){return this.dScaleZ},e.MaterialLayer.prototype.setRotX=function(a){this.matrix=null,this.rotX=a;return this},e.MaterialLayer.prototype.getRotX=function(){return this.rotX},e.MaterialLayer.prototype.setRotY=function(a){this.matrix=null,this.rotY=a;return this},e.MaterialLayer.prototype.getRotY=function(){return this.rotY},e.MaterialLayer.prototype.setRotZ=function(a){this.matrix=null,this.rotZ=a;return this},e.MaterialLayer.prototype.getRotZ=function(){return this.rotZ},e.MaterialLayer.prototype.setDRotX=function(a){this.matrix=null,this.dRotX=a;return this},e.MaterialLayer.prototype.getDRotX=function(){return this.dRotX},e.MaterialLayer.prototype.setDRotY=function(a){this.matrix=null,this.dRotY=a;return this},e.MaterialLayer.prototype.getDRotY=function(){return this.dRotY},e.MaterialLayer.prototype.setDRotZ=function(a){this.matrix=null,this.dRotZ=a;return this},e.MaterialLayer.prototype.getDRotZ=function(){return this.dRotZ},e.MaterialLayer.prototype.setBlendMode=function(a){this.blendMode=a,this.fireEvent("shaderupdate",{});return this},e.MaterialLayer.prototype.getBlendMode=function(){return this.blendMode};var m=0;e.Material=function(a){e.Assets.registerAsset(this,a),this.layers=[],this.layerlisteners=[],this.textures=[],this.lights=[],this.color={r:1,g:1,b:1,a:1},this.specColor={r:1,g:1,b:1},this.reflect=.8,this.shine=10,this.specular=1,this.emit=0,this.alpha=1,this.materialIdx=m++},e.augment(e.Animatable,e.Material),e.augment(e.QuickNotation,e.Material),e.augment(e.JSONLoader,e.Material),e.augment(e.Events,e.Material),e.M_COLOR=1,e.M_NOR=2,e.M_ALPHA=4,e.M_SPECCOLOR=8,e.M_SPECULAR=16,e.M_SHINE=32,e.M_REFLECT=64,e.M_EMIT=128,e.M_ALPHA=256,e.M_MSKR=512,e.M_MSKG=1024,e.M_MSKB=2048,e.M_MSKA=4096,e.M_HEIGHT=8192,e.M_AMBIENT=16384,e.UV1=0,e.UV2=1,e.MAP_NORM=3,e.MAP_OBJ=4,e.MAP_REF=5,e.MAP_ENV=6,e.MAP_VIEW=7,e.BL_MIX=0,e.BL_MUL=1,e.Material.prototype.layers=null,e.Material.prototype.className="Material",e.Material.prototype.textures=null,e.Material.prototype.color=null,e.Material.prototype.specColor=null,e.Material.prototype.specular=null,e.Material.prototype.emit=null,e.Material.prototype.shine=null,e.Material.prototype.reflect=null,e.Material.prototype.lights=null,e.Material.prototype.alpha=null,e.Material.prototype.ambient=null,e.Material.prototype.shadow=!0,e.Material.prototype.setShadow=function(a){this.shadow=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getShadow=function(a){return this.shadow},e.Material.prototype.setColor=function(a){a.r||(a=e.colorParse(a)),this.color={r:a.r,g:a.g,b:a.b},this.fireEvent("shaderupdate",{});return this},e.Material.prototype.setColorR=function(a){this.color.r=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.setColorG=function(a){this.color.g=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.setColorB=function(a){this.color.b=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getColor=function(){return this.color},e.Material.prototype.setSpecularColor=function(a){a.r||(a=e.colorParse(a)),this.specColor={r:parseFloat(a.r),g:parseFloat(a.g),b:parseFloat(a.b)},this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getAmbient=function(){return this.ambient},e.Material.prototype.setAmbient=function(a){a.r||(a=e.colorParse(a)),this.ambient={r:parseFloat(a.r),g:parseFloat(a.g),b:parseFloat(a.b)},this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getSpecularColor=function(){return this.specColor},e.Material.prototype.setAlpha=function(a){this.alpha=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getAlpha=function(){return this.alpha},e.Material.prototype.setSpecular=function(a){this.specular=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getSpecular=function(){return this.specular},e.Material.prototype.setShininess=function(a){a<=0&&(a=.001),this.shine=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getShininess=function(){return this.shine},e.Material.prototype.setEmit=function(a){this.emit=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getEmit=function(){return this.emit},e.Material.prototype.setReflectivity=function(a){this.reflect=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getReflectivity=function(){return this.reflect},e.Material.prototype.setBinaryAlpha=function(a){this.binaryAlpha=a,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.getBinaryAlpha=function(){return this.binaryAlpha},e.Material.prototype.addMaterialLayer=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.layers.push(a);var b=this,c=function(a){b.fireEvent("shaderupdate",{})};this.layerlisteners.push(c),a.addEventListener("shaderupdate",c),this.fireEvent("shaderupdate",{});return this},e.Material.prototype.removeMaterialLayer=function(a){var b=this.layers.indexOf(a);b>=0&&(this.layers.splice(b,1),a.removeEventListener("shaderupdate",this.layerlisteners[b]),this.layerlisteners.splice(b,1),this.fireEvent("shaderupdate",{}));return this},e.Material.prototype.getLayers=function(){return this.layers},e.Material.prototype.getLayerCoords=function(){var a=[];a.push("vec4 texturePos;\n");for(i=0;i<this.layers.length;i++)a.push("textureCoords"+i+"=vec3(0.0,0.0,0.0);\n"),(this.layers[i].mapinput==e.UV1||this.layers[i].mapinput==e.UV2)&&a.push("texturePos=vec4(vec2(UVCoord["+this.layers[i].mapinput*2+"],(1.0-UVCoord["+(this.layers[i].mapinput*2+1)+"])),1.0,1.0);\n"),this.layers[i].mapinput==e.MAP_NORM&&a.push("texturePos=vec4(normalize(n.xyz),1.0);\n"),this.layers[i].mapinput==e.MAP_OBJ&&a.push("texturePos=vec4(normalize(OBJCoord.xyz),1.0);\n"),this.layers[i].mapinput==e.MAP_REF&&a.push("texturePos=vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n"),this.layers[i].mapinput==e.MAP_ENV&&a.push("texturePos=envMat * vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n"),a.push("textureCoords"+i+"=(layer"+i+"Matrix * texturePos).xyz;\n");return a.join("")},e.Material.prototype.getVertexVarying=function(){var a=[];for(i=0;i<this.layers.length;i++)a.push("uniform mat4 layer"+i+"Matrix;\n"),a.push("varying vec3 textureCoords"+i+";\n");return a.join("")},e.Material.prototype.registerPasses=function(a,b){for(var c=0;c<this.textures.length;c++)this.textures[c].registerPasses&&this.textures[c].registerPasses(a,b)},e.Material.prototype.getFragmentShader=function(a){var b="#ifdef GL_ES\nprecision highp float;\n#endif\n",c=!1;for(var d=0;d<a.length;d++)if(a[d].type==e.L_POINT||a[d].type==e.L_SPOT||a[d].type==e.L_DIR)b=b+"varying vec3 lightvec"+d+";\n",b=b+"varying vec3 lightpos"+d+";\n",b=b+"varying float lightdist"+d+";\n",b=b+"varying vec2 spotCoords"+d+";\n";b=b+"varying vec3 n;\n",b=b+"varying vec3 t;\n",b=b+"varying vec4 UVCoord;\n",b=b+"varying vec3 eyevec;\n",b=b+"varying vec3 OBJCoord;\n";for(var d=0;d<this.textures.length;d++)this.textures[d].className=="Texture"&&(b=b+"uniform sampler2D TEXTURE"+d+";\n"),this.textures[d].className=="TextureCanvas"&&(b=b+"uniform sampler2D TEXTURE"+d+";\n"),this.textures[d].className=="TextureVideo"&&(b=b+"uniform sampler2D TEXTURE"+d+";\n"),this.textures[d].className=="TextureCube"&&(b=b+"uniform samplerCube TEXTURE"+d+";\n");var f=0,g=[],h;for(var d=0;d<a.length;d++)b=b+"uniform vec3 lightcolor"+d+";\n",b=b+"uniform vec3 lightAttenuation"+d+";\n",b=b+"uniform float spotCosCutOff"+d+";\n",b=b+"uniform float spotExp"+d+";\n",b=b+"uniform vec3 lightdir"+d+";\n",b=b+"uniform mat4 lightmat"+d+";\n",b=b+"uniform float shadowbias"+d+";\n",b=b+"uniform int shadowsamples"+d+";\n",b=b+"uniform float shadowsoftness"+d+";\n",b=b+"uniform bool castshadows"+d+";\n",b=b+"varying vec4 spotcoord"+d+";\n",a[d].getCastShadows()&&this.shadow&&(h=this.textures.length+f++,b=b+"uniform sampler2D TEXTURE"+h+";\n",g[d]=h);for(d=0;d<this.layers.length;d++)b=b+"varying vec3 textureCoords"+d+";\n",b=b+"uniform float layeralpha"+d+";\n",(this.layers[d].mapto&e.M_HEIGHT)==e.M_HEIGHT&&(b=b+"uniform float layerheight"+d+";\n");b=b+"uniform vec4 baseColor;\n",b=b+"uniform vec3 specColor;\n",b=b+"uniform float shine;\n",b=b+"uniform float specular;\n",b=b+"uniform float reflective;\n",b=b+"uniform float emit;\n",b=b+"uniform float alpha;\n",b=b+"uniform vec3 amb;\n",b=b+"uniform float fognear;\n",b=b+"uniform float fogfar;\n",b=b+"uniform int fogtype;\n",b=b+"uniform vec3 fogcolor;\n",b=b+"uniform float far;\n",b=b+"uniform mat4 worldInverseTranspose;\n",b=b+"uniform mat4 projection;\n",b=b+"void main(void)\n",b=b+"{\n",b=b+"float att;\n",b=b+"int texture;\n",b=b+"float mask=1.0;\n",b=b+"float spec=specular;\n",b=b+"vec3 specC=specColor;\n",b=b+"vec4 view;\n",b=b+"vec3 textureCoords=vec3(0.0,0.0,0.0);\n",b=b+"float ref=reflective;\n",b=b+"float sh=shine;\n",b=b+"float em=emit;\n",b=b+"float al=alpha;\n",b=b+"vec3 amblight=amb;\n",b=b+"vec4 normalmap= vec4(n,0.0);\n",b=b+"vec4 color = baseColor;",b=b+"float pheight=0.0;\n",b=b+"vec3 textureHeight=vec3(0.0,0.0,0.0);\n",b=b+"vec3 normal = normalize(n);\n",b=b+"vec3 b = vec3(0.0,0.0,0.0);\n";for(d=0;d<this.layers.length;d++){b=b+"textureCoords=textureCoords"+d+"+textureHeight;\n",b=b+"mask=layeralpha"+d+"*mask;\n",this.layers[d].mapinput==e.MAP_VIEW&&(b=b+"view=projection * vec4(-eyevec,1.0);\n",b=b+"textureCoords=view.xyz/view.w*0.5+0.5;\n",b=b+"textureCoords=textureCoords+textureHeight;\n");if(this.layers[d].getTexture().className=="Texture"||this.layers[d].getTexture().className=="TextureCanvas"||this.layers[d].getTexture().className=="TextureVideo")var i="xy",j="2D";else var i="xyz",j="Cube";(this.layers[d].mapto&e.M_COLOR)==e.M_COLOR&&(this.layers[d].blendMode==e.BL_MUL?b=b+"color = color*(1.0-mask) + color*texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+")*mask;\n":b=b+"color = color*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+")*mask;\n"),(this.layers[d].mapto&e.M_HEIGHT)==e.M_HEIGHT&&(b=b+"pheight = texture2D(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").x;\n",b=b+"textureHeight =vec3((layerheight"+d+"* (pheight-0.5)  * normalize(teyevec).xy*vec2(1.0,-1.0)),0.0);\n"),(this.layers[d].mapto&e.M_SPECCOLOR)==e.M_SPECCOLOR&&(b=b+"specC = specC*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").rgb*mask;\n"),(this.layers[d].mapto&e.M_MSKR)==e.M_MSKR&&(b=b+"mask = texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").r;\n"),(this.layers[d].mapto&e.M_MSKG)==e.M_MSKG&&(b=b+"mask = texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").g;\n"),(this.layers[d].mapto&e.M_MSKB)==e.M_MSKB&&(b=b+"mask = texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").b;\n"),(this.layers[d].mapto&e.M_MSKA)==e.M_MSKA&&(b=b+"mask = texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").a;\n"),(this.layers[d].mapto&e.M_SPECULAR)==e.M_SPECULAR&&(b=b+"spec = spec*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").r*mask;\n"),(this.layers[d].mapto&e.M_REFLECT)==e.M_REFLECT&&(b=b+"ref = ref*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").g*mask;\n"),(this.layers[d].mapto&e.M_SHINE)==e.M_SHINE&&(b=b+"sh = sh*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").b*mask*255.0;\n"),(this.layers[d].mapto&e.M_EMIT)==e.M_EMIT&&(b=b+"em = em*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").r*mask;\n"),(this.layers[d].mapto&e.M_NOR)==e.M_NOR&&(b=b+"normalmap = normalmap*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+")*mask;\n",b=b+"normal = normalmap.rgb;\n",b=b+"normal = 2.0*(vec3(normal.r, -normal.g, normal.b) - vec3(0.5, -0.5, 0.5));",b=b+"b=normalize(cross(t.xyz,n));\n",b=b+"normal = normal.x*t + normal.y*b + normal.z*n;",b=b+"normal = normalize(normal);"),(this.layers[d].mapto&e.M_ALPHA)==e.M_ALPHA&&(b=b+"al = al*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").a*mask;\n"),(this.layers[d].mapto&e.M_AMBIENT)==e.M_AMBIENT&&(b=b+"amblight = amblight*(1.0-mask) + texture"+j+"(TEXTURE"+this.layers[d].texture.idx+", textureCoords."+i+").rgb*mask;\n")}b=b+"if(al<0.5) discard;\n",this.binaryAlpha&&(b=b+"al=1.0;\n"),b=b+"vec3 lightvalue=amblight;\n",b=b+"float dotN,spotEffect;",b=b+"vec3 lightvec=vec3(0.0,0.0,0.0);",b=b+"vec3 viewvec=vec3(0.0,0.0,0.0);",b=b+"vec3 specvalue=vec3(0.0,0.0,0.0);",b=b+"vec2 scoord=vec2(0.0,0.0);",b=b+"float spotmul=0.0;",b=b+"float rnd=0.0;",b=b+"float spotsampleX=0.0;",b=b+"float spotsampleY=0.0;",b=b+"float totalweight=0.0;",b=b+"int cnt=0;",b=b+"float specularSmoothStepValue=.125;\n",b=b+"vec2 spotoffset=vec2(0.0,0.0);",b=b+"float dp=0.0;",b=b+"if (normal.z<0.0) {normal.z=0.0;}\n",b=b+"normal/=length(normal);\n";for(var d=0;d<a.length;d++)b=b+"lightvec=lightvec"+d+";\n",b=b+"viewvec=eyevec;\n",a[d].type==e.L_POINT&&(b=b+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n",b=b+"att = 1.0 / (lightAttenuation"+d+"[0] + lightAttenuation"+d+"[1] * lightdist"+d+" + lightAttenuation"+d+"[2] * lightdist"+d+" * lightdist"+d+");\n",b=b+"if(dotN>0.0){\n",a[d].diffuse&&(b=b+"lightvalue += att * dotN * lightcolor"+d+";\n"),b=b+"}\n",a[d].specular&&(b=b+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN)*att * specC * lightcolor"+d+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3*sh);\n")),b=b+"spotEffect = 0.0;\n",a[d].type==e.L_SPOT&&(b=b+"spotEffect = dot(normalize(lightdir"+d+"), normalize(-lightvec"+d+"));",b=b+"if (spotEffect > spotCosCutOff"+d+") {\n",b=b+"spotEffect = pow(spotEffect, spotExp"+d+");",a[d].getCastShadows()&&this.shadow&&(b=b+"scoord=(((spotcoord"+d+".xy)/spotcoord"+d+".w)+1.0)/2.0;\n",b=b+"if(scoord.x>0.0 && scoord.x<1.0 && scoord.y>0.0 && scoord.y<1.0){\n",b=b+"vec4 dist=texture2D(TEXTURE"+g[d]+", scoord);\n",b=b+"float depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+a[d].distance+".0;\n",b=b+"spotmul=0.0;\n",b=b+"totalweight=0.0;\n",b=b+"if((depth+shadowbias"+d+"-length(lightvec"+d+"))<0.0) {spotmul=1.0; totalweight=1.0;}\n",a[d].samples>0&&(b=b+"for(int cnt=0; cnt<4; cnt++){;\n",b=b+"spotsampleX=-0.707106781;spotsampleY=-0.707106781;\n",b=b+"if(cnt==0 || cnt==3) spotsampleX=0.707106781;\n",b=b+"if(cnt==1 || cnt==3) spotsampleY=0.707106781;\n",b=b+"spotoffset=vec2(spotsampleX,spotsampleY)*0.5;\n",b=b+"dist=texture2D(TEXTURE"+g[d]+", scoord+spotoffset*shadowsoftness"+d+");\n",b=b+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+a[d].distance+".0;\n",b=b+"if((depth+shadowbias"+d+"-length(lightvec"+d+"))<0.0){\n",b=b+"spotmul+=length(spotoffset);\n",b=b+"}\n",b=b+"totalweight+=length(spotoffset);\n",b=b+"};\n",b=b+"if(totalweight!=spotmul){\n",b=b+"spotmul=0.0;\n",b=b+"totalweight=0.0;\n",b=b+"for(int cnt=0; cnt<"+a[d].samples+"; cnt++){;\n",b=b+"rnd=(fract(sin(dot(scoord,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;\n",b=b+"spotsampleX=cos(float(cnt)*"+(360/a[d].samples).toFixed(2)+"+rnd);\n",b=b+"spotsampleY=sin(float(cnt)*"+(360/a[d].samples).toFixed(2)+"+rnd);\n",b=b+"spotoffset=vec2(spotsampleX,spotsampleY)*0.5;\n",b=b+"dist=texture2D(TEXTURE"+g[d]+", scoord+spotoffset*shadowsoftness"+d+");\n",b=b+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+a[d].distance+".0;\n",b=b+"if((depth+shadowbias"+d+"-length(lightvec"+d+"))<0.0){\n",b=b+"spotmul+=length(spotoffset);\n",b=b+"}\n",b=b+"totalweight+=length(spotoffset);\n",b=b+"};\n",b=b+"}\n"),b=b+"if(totalweight>0.0) spotEffect=spotEffect*pow(1.0-spotmul/totalweight,3.0);\n",b=b+"}\n"),b=b+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n",a[d].negativeShadow?(b=b+"if(dotN>0.0){\n",a[d].diffuse&&(b=b+"lightvalue -= (1.0-spotEffect) / (lightAttenuation"+d+"[0] + lightAttenuation"+d+"[1] * lightdist"+d+" + lightAttenuation"+d+"[2] * lightdist"+d+" * lightdist"+d+");\n"),b=b+"}\n"):(b=b+"att = spotEffect / (lightAttenuation"+d+"[0] + lightAttenuation"+d+"[1] * lightdist"+d+" + lightAttenuation"+d+"[2] * lightdist"+d+" * lightdist"+d+");\n",b=b+"if(dotN>0.0){\n",a[d].diffuse&&(b=b+"lightvalue += att * dotN * lightcolor"+d+";\n"),b=b+"}\n",a[d].specular&&(b=b+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * att * specC * lightcolor"+d+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n")),b=b+"}\n"),a[d].type==e.L_DIR&&(b=b+"dotN=max(dot(normal,-normalize(lightvec)),0.0);\n",a[d].diffuse&&(b=b+"lightvalue += dotN * lightcolor"+d+";\n"),a[d].specular&&(b=b+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * specC * lightcolor"+d+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n"));b=b+"float fogfact=1.0;",b=b+"if(fogtype=="+e.FOG_QUADRATIC+") fogfact=clamp(pow(max((fogfar - length(eyevec)) / (fogfar - fognear),0.0),2.0),0.0,1.0);\n",b=b+"if(fogtype=="+e.FOG_LINEAR+") fogfact=clamp((fogfar - length(eyevec)) / (fogfar - fognear),0.0,1.0);\n",b=b+"lightvalue = (lightvalue)*ref;\n",b=b+"if(em>0.0){lightvalue=vec3(1.0,1.0,1.0);  fogfact=1.0;}\n",b=b+"gl_FragColor =vec4(specvalue.rgb+color.rgb*(em+1.0)*lightvalue.rgb,al)*fogfact+vec4(fogcolor,al)*(1.0-fogfact);\n",b=b+"}\n";return b},e.Material.prototype.textureUniforms=function(a,b,c,d){this.animation&&this.animate();var f=b.caches;f.baseColor!=this.color&&(this.ccache!=this.color&&(this.ccache=this.color,this.glColor=new Float32Array([this.color.r,this.color.g,this.color.b,this.color.a])),a.uniform4fv(e.getUniformLocation(a,b,"baseColor"),this.glColor),f.baseColor=this.color),f.specColor!=this.specColor&&(this.sccache!=this.specColor&&(this.sccache=this.specColor,this.glspecColor=new Float32Array([this.specColor.r,this.specColor.g,this.specColor.b])),a.uniform3fv(e.getUniformLocation(a,b,"specColor"),this.glspecColor),f.specColor=this.specColor),f.specular!=this.specular&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"specular"),this.specular),f.specular=this.specular),f.shine!=this.shine&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"shine"),this.shine),f.shine=this.shine),f.reflect!=this.reflect&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"reflective"),this.reflect),f.reflect=this.reflect),f.emit!=this.emit&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"emit"),this.emit),f.emit=this.emit),f.alpha!=this.alpha&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"alpha"),this.alpha),f.alpha=this.alpha);var g=0,h=0;f.lightcolor||(f.lightcolor=[],f.lightAttenuation=[],f.spotCosCutOff=[],f.spotExponent=[],f.shadowbias=[],f.castshadows=[],f.shadowsamples=[],f.shadowsoftness=[]);for(var i=0;i<c.length;i++)f.lightcolor[i]!=c[i].color&&(e.setUniform3(a,"3f",e.getUniformLocation(a,b,"lightcolor"+i),c[i].color.r,c[i].color.g,c[i].color.b),f.lightcolor[i]=c[i].color),f.lightAttenuation[i]!=c[i].constantAttenuation&&(e.setUniform3(a,"3f",e.getUniformLocation(a,b,"lightAttenuation"+i),c[i].constantAttenuation,c[i].linearAttenuation,c[i].quadraticAttenuation),f.lightAttenuation[i]=c[i].constantAttenuation),f.spotCosCutOff[i]!=c[i].spotCosCutOff&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"spotCosCutOff"+i),c[i].spotCosCutOff),f.spotCosCutOff[i]=c[i].spotCosCutOff),f.spotExponent[i]!=c[i].spotExponent&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"spotExp"+i),c[i].spotExponent),f.spotExponent[i]=c[i].spotExponent),f.shadowbias[i]!=c[i].shadowBias&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"shadowbias"+i),c[i].shadowBias),f.shadowbias[i]=c[i].shadowBias),f.shadowsoftness[i]!=c[i].softness&&(e.setUniform(a,"1f",e.getUniformLocation(a,b,"shadowsoftness"+i),c[i].softness),f.shadowsoftness[i]=c[i].softness),c[i].getCastShadows()&&this.shadow&&this.emit==0&&(h=this.textures.length+g++,a.activeTexture(a["TEXTURE"+h]),a.bindTexture(a.TEXTURE_2D,c[i].texture),e.setUniform(a,"1i",e.getUniformLocation(a,b,"TEXTURE"+h),h));b.glarrays.layermat||(b.glarrays.layermat=[]);var j,k;for(i=0;i<this.layers.length;i++){this.layers[i].animation&&this.layers[i].animate(),j=this.layers[i].getScale(),k=this.layers[i].getOffset(),b.glarrays.layermat[i]?e.mat4gl(this.layers[i].getMatrix(),b.glarrays.layermat[i]):b.glarrays.layermat[i]=new Float32Array(this.layers[i].getMatrix());try{e.setUniformMatrix(a,"Matrix4fv",e.getUniformLocation(a,b,"layer"+i+"Matrix"),!0,b.glarrays.layermat[i])}catch(l){}e.setUniform(a,"1f",e.getUniformLocation(a,b,"layeralpha"+i),this.layers[i].getAlpha()),e.setUniform(a,"1f",e.getUniformLocation(a,b,"layerheight"+i),this.layers[i].getHeight())}for(var i=0;i<this.textures.length;i++)a.activeTexture(a["TEXTURE"+i]),!this.textures[i].doTexture(a,d),e.setUniform(a,"1i",e.getUniformLocation(a,b,"TEXTURE"+i),i)},e.Material.prototype.addTexture=function(a){typeof a=="string"&&(a=e.Assets.get(a)),this.textures.push(a),a.idx=this.textures.length-1,this.fireEvent("shaderupdate",{});return this},e.Material.prototype.addTextureCube=e.Material.prototype.addTexture,e.Material.prototype.addTextureCamera=e.Material.prototype.addTexture,e.Material.prototype.addTextureCanvas=e.Material.prototype.addTexture,e.Material.prototype.addTextureVideo=e.Material.prototype.addTexture}(GLGE),function(a){a.ParticleSystem=function(a){this.startTime=(new Date).getTime(),this.texture={},this.startMaxVelocity={x:0,y:0,z:0},this.startMinVelocity={x:0,y:0,z:0},this.startMaxAcceleration={x:0,y:0,z:0},this.endMaxAcceleration={x:0,y:0,z:0},this.startMinAcceleration={x:0,y:0,z:0},this.endMinAcceleration={x:0,y:0,z:0},this.startColor={r:0,g:0,b:0,a:1},this.endColor={r:0,g:0,b:0,a:1}},a.augment(a.Placeable,a.ParticleSystem),a.augment(a.Animatable,a.ParticleSystem),a.ParticleSystem.prototype.setMaxVelX=function(a){this.startMaxVelocity.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxVelY=function(a){this.startMaxVelocity.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxVelZ=function(a){this.startMaxVelocity.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxVelocity=function(a,b,c){this.startMaxVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMinVelX=function(a){this.startMinVelocity.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinVelY=function(a){this.startMinVelocity.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinVelZ=function(a){this.startMinVelocity.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinVelocity=function(a,b,c){this.startMinVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setVelX=function(a){this.startMaxVelocity.x=parseFloat(a),this.startMinVelocity.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setVelY=function(a){this.startMaxVelocity.y=parseFloat(a),this.startMinVelocity.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setVelZ=function(a){this.startMaxVelocity.z=parseFloat(a),this.startMinVelocity.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setVelocity=function(a,b,c){this.startMaxVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.startMinVelocity={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccX=function(a){this.startMaxAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccY=function(a){this.startMaxAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccZ=function(a){this.startMaxAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxStartAccelertaion=function(a,b,c){this.startMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMinStartAccX=function(a){this.startMinAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinStartAccY=function(a){this.startMinAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinStartAccZ=function(a){this.startMinAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinStartAccelertaion=function(a,b,c){this.startMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setStartAccX=function(a){this.startMaxAcceleration.x=parseFloat(a),this.startMinAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setStartAccY=function(a){this.startMaxAcceleration.y=parseFloat(a),this.startMinAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setStartAccZ=function(a){this.startMaxAcceleration.z=parseFloat(a),this.startMinAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setStartAccelertaion=function(a,b,c){this.startMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.startMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccX=function(a){this.endMaxAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccY=function(a){this.endMaxAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccZ=function(a){this.endMaxAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxEndAccelertaion=function(a,b,c){this.endMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setMinEndAccX=function(a){this.endMinAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinEndAccY=function(a){this.endMinAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinEndAccZ=function(a){this.endMinAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinEndAccelertaion=function(a,b,c){this.endMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setEndAccX=function(a){this.endMinAcceleration.x=parseFloat(a),this.endMaxAcceleration.x=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndAccY=function(a){this.endMinAcceleration.y=parseFloat(a),this.endMaxAcceleration.y=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndAccZ=function(a){this.endMinAcceleration.z=parseFloat(a),this.endMaxAcceleration.z=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndAccelertaion=function(a,b,c){this.endMinAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.endMaxAcceleration={x:parseFloat(a),y:parseFloat(b),z:parseFloat(c)},this.attribute=null},a.ParticleSystem.prototype.setStartColor=function(b){var c=a.colorParse(b);this.startColor=c,this.attribute=null},a.ParticleSystem.prototype.setEndColor=function(b){var c=a.colorParse(b);this.endColor=c,this.attribute=null},a.ParticleSystem.prototype.setStartSize=function(a){this.startSize=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setEndSize=function(a){this.endSize=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setLifeTime=function(a){this.maxLifeTime=parseFloat(a),this.minLifeTime=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMaxLifeTime=function(a){this.maxLifeTime=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setMinLifeTime=function(a){this.minLifeTime=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.setNumParticles=function(a){this.numParticles=parseFloat(a),this.attribute=null},a.ParticleSystem.prototype.velocityFunction=function(a){return[(this.startMaxVelocity.x-this.startMinVelocity.x)*Math.random()+this.startMinVelocity.x,(this.startMaxVelocity.y-this.startMinVelocity.y)*Math.random()+this.startMinVelocity.y,(this.startMaxVelocity.z-this.startMinVelocity.z)*Math.random()+this.startMinVelocity.z]},a.ParticleSystem.prototype.accelerationFunction=function(a){return[[(this.startMaxAcceleration.x-this.startMinAcceleration.x)*Math.random()+this.startMinAcceleration.x,(this.startMaxAcceleration.y-this.startMinAcceleration.y)*Math.random()+this.startMinAcceleration.y,(this.startMaxAcceleration.z-this.startMinAcceleration.z)*Math.random()+this.startMinAcceleration.z],[(this.endMaxAcceleration.x-this.endMinAcceleration.x)*Math.random()+this.endMinAcceleration.x,(this.endMaxAcceleration.y-this.endMinAcceleration.y)*Math.random()+this.endMinAcceleration.y,(this.endMaxAcceleration.z-this.endMinAcceleration.z)*Math.random()+this.endMinAcceleration.z]]},a.ParticleSystem.prototype.colorFunction=function(a){return[[this.startColor.r,this.startColor.g,this.startColor.b,this.startColor.a],[this.endColor.r,this.endColor.g,this.endColor.b,this.endColor.a]]},a.ParticleSystem.prototype.positionFunction=function(a){return[0,0,0]},a.ParticleSystem.prototype.sizeFunction=function(a){return[this.startSize,this.endSize]},a.ParticleSystem.prototype.lifeTimeFunction=function(a){return(this.maxLifeTime-this.minLifeTime)*Math.random()+this.minLifeTime},a.ParticleSystem.prototype.minLifeTime=2e3,a.ParticleSystem.prototype.maxLifeTime=2e3,a.ParticleSystem.prototype.numParticles=200,a.ParticleSystem.prototype.startTime=0,a.ParticleSystem.prototype.startSize=0,a.ParticleSystem.prototype.endSize=1,a.ParticleSystem.prototype.toRender=!0,a.ParticleSystem.prototype.renderFirst=!0,a.ParticleSystem.prototype.className="ParticleSystem",a.ParticleSystem.prototype.zTrans=!0,a.ParticleSystem.prototype.velocity=null,a.ParticleSystem.prototype.loop=1,a.ParticleSystem.prototype.setVelocityFunction=function(a){this.vecoityFunction=a,this.particles=null},a.ParticleSystem.prototype.setAccelerationFunction=function(a){this.accelerationFunction=a,this.particles=null},a.ParticleSystem.prototype.setPositionFunction=function(a){this.colorFunction=a,this.particles=null},a.ParticleSystem.prototype.setColorFunction=function(a){this.positionFunction=a,this.particles=null},a.ParticleSystem.prototype.setSizeFunction=function(a){this.sizeFunction=a,this.particles=null},a.ParticleSystem.prototype.generateParticles=function(a){var b=this.numParticles;this.attribute={initPos:[],initAcc:[],endAcc:[],initVel:[],initColor:[],endColor:[],sizeAndOffset:[]},this.faces=[];for(var c=0;c<b;c++){var d=this.positionFunction(c),e=this.velocityFunction(c),f=this.accelerationFunction(c),g=this.colorFunction(c),h=this.sizeFunction(c),i=this.lifeTimeFunction(c),j=Math.floor(Math.random()*i);for(var k=-1;k<=1;k=k+2)for(var l=-1;l<=1;l=l+2)this.attribute.initPos.push(parseFloat(d[0])+l,parseFloat(d[1])+k,parseFloat(d[2])),this.attribute.initAcc.push(f[0][0],f[0][1],f[0][2]),this.attribute.endAcc.push(f[1][0],f[1][1],f[1][2]),this.attribute.initVel.push(e[0],e[1],e[2]),this.attribute.initColor.push(g[0][0],g[0][1],g[0][2],g[0][3]),this.attribute.endColor.push(g[1][0],g[1][1],g[1][2],g[1][3]),this.attribute.sizeAndOffset.push(h[0],h[1],j,i)}for(var c=0;c<b;c=c+4)this.faces.push(0+c,1+c,2+c),this.faces.push(1+c,2+c,3+c);this.facesGL=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.facesGL),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.faces),a.STATIC_DRAW),this.facesGL.num=this.faces.length,this.attribute.initPosGL=this.createBuffer(a,this.attribute.initPos),this.attribute.initAccGL=this.createBuffer(a,this.attribute.initAcc),this.attribute.endAccGL=this.createBuffer(a,this.attribute.endAcc),this.attribute.initVelGL=this.createBuffer(a,this.attribute.initVel),this.attribute.initColorGL=this.createBuffer(a,this.attribute.initColor),this.attribute.endColorGL=this.createBuffer(a,this.attribute.endColor),this.attribute.sizeAndOffsetGL=this.createBuffer(a,this.attribute.sizeAndOffset)},a.ParticleSystem.prototype.setLoop=function(a){this.loop=a},a.ParticleSystem.prototype.reset=function(){this.startTime=(new Date).getTime()},a.ParticleSystem.prototype.generateProgram=function(b){var c=["attribute vec3 position;","attribute vec3 initVel;","attribute vec3 initAcc;","attribute vec3 endAcc;","attribute vec4 initColor;","attribute vec4 endColor;","attribute vec4 sizeTimeLife;","uniform float time;","uniform bool loop;","uniform mat4 mvMatrix;","uniform mat4 pMatrix;","varying vec2 UV;","varying vec4 color;","void main(){","UV = (position.xy+1.0)/2.0;","if((time>sizeTimeLife[2] && (time-sizeTimeLife[2])<sizeTimeLife[3]) || loop){","float localTime = mod((time - sizeTimeLife[2]), sizeTimeLife[3]);","color = (endColor-initColor)/sizeTimeLife[3]*localTime+initColor;","float size = (sizeTimeLife[1]-sizeTimeLife[0])/sizeTimeLife[3]*localTime+sizeTimeLife[0];","vec3 pos = (endAcc-initAcc)*(localTime*log(localTime)-localTime)+0.5*initAcc*localTime*localTime+initVel*localTime;","pos = (mvMatrix*vec4(pos,1.0)).xyz;","vec3 positions = pos+(position*size);","gl_Position = pMatrix*vec4(positions,1.0);","}else{","gl_Position = vec4(0.0,0.0,0.0,1.0);","}","}"].join("");frgShader=["#ifdef GL_ES\nprecision mediump float;\n#endif\n","uniform sampler2D texture;","varying vec2 UV;","varying vec4 color;","void main(){","gl_FragColor=texture2D(texture,UV)*color;","}"].join("");var d=b.createShader(b.VERTEX_SHADER),e=b.createShader(b.FRAGMENT_SHADER);b.shaderSource(d,c),b.compileShader(d);if(b.getShaderParameter(d,b.COMPILE_STATUS)){b.shaderSource(e,frgShader),b.compileShader(e);if(!b.getShaderParameter(e,b.COMPILE_STATUS)){a.error(b.getShaderInfoLog(e));return}this.program&&b.deleteProgram(this.Program),this.program=b.createProgram(),b.attachShader(this.program,d),b.attachShader(this.program,e),b.linkProgram(this.program)}else a.error(b.getShaderInfoLog(d))},a.ParticleSystem.prototype.createBuffer=function(a,b){var c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW);return c},a.ParticleSystem.prototype.setUniforms=function(b){var c=this.program;c.glarrays||(c.glarrays={});var d=b.scene.camera.getViewMatrix(),e=this.getPosition(),f=a.mulMat4(d,[1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1]),g=a.getUniformLocation(b,c,"mvMatrix");c.glarrays.mvMatrix?a.mat4gl(f,c.glarrays.mvMatrix):c.glarrays.mvMatrix=new Float32Array(f),b.uniformMatrix4fv(g,!0,c.glarrays.mvMatrix);var h=a.getUniformLocation(b,c,"pMatrix");c.glarrays.pMatrix?a.mat4gl(b.scene.camera.getProjectionMatrix(),c.glarrays.pMatrix):c.glarrays.pMatrix=new Float32Array(b.scene.camera.getProjectionMatrix()),b.uniformMatrix4fv(h,!0,c.glarrays.pMatrix),b.uniform1f(a.getUniformLocation(b,c,"time"),(new Date).getTime()-this.startTime),b.uniform1i(a.getUniformLocation(b,c,"loop"),this.loop),b.activeTexture(b.TEXTURE0),this.glTexture||(this.glTexture=b.createTexture()),this.texture.state==1&&(b.bindTexture(b.TEXTURE_2D,this.glTexture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,this.texture.image),b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_LINEAR),b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null),this.texture.state=2,c.texture=!0),b.bindTexture(b.TEXTURE_2D,this.glTexture),c.texture&&b.uniform1i(a.getUniformLocation(b,c,"texture"),0)},a.ParticleSystem.prototype.setImage=function(a){var b=this.texture;b.image=new Image,b.image.onload=function(a){b.state=1},b.image.src=a},a.ParticleSystem.prototype.setAttributes=function(b){for(var c=0;c<8;c++)b.disableVertexAttribArray(c);var d=a.getAttribLocation(b,this.program,"position");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initPosGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"initAcc");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initAccGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"endAcc");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.endAccGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"initColor");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initColorGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,4,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"endColor");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.endColorGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,4,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"sizeTimeLife");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.sizeAndOffsetGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,4,b.FLOAT,!1,0,0));var d=a.getAttribLocation(b,this.program,"initVel");d>-1&&(b.bindBuffer(b.ARRAY_BUFFER,this.attribute.initVelGL),b.enableVertexAttribArray(d),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0))},a.ParticleSystem.prototype.GLRender=function(a){this.attribute||this.generateParticles(a),this.program||this.generateProgram(a),a.useProgram(this.program),this.setAttributes(a),this.setUniforms(a),a.colorMask(0,0,0,0),a.disable(a.BLEND),a.enable(a.STENCIL_TEST),a.stencilFunc(a.ALWAYS,1,1),a.stencilOp(a.KEEP,a.KEEP,a.REPLACE),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.facesGL),a.drawElements(a.TRIANGLES,this.facesGL.num,a.UNSIGNED_SHORT,0),a.stencilFunc(a.EQUAL,1,1),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.colorMask(1,1,1,1),a.disable(a.DEPTH_TEST),a.enable(a.BLEND),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.facesGL),a.drawElements(a.TRIANGLES,this.facesGL.num,a.UNSIGNED_SHORT,0),a.stencilOp(a.REPLACE,a.REPLACE,a.REPLACE),a.stencilFunc(a.ALWAYS,0,0),a.enable(a.DEPTH_TEST),a.scene.lastMaterail=null},a.Scene.prototype.addParticleSystem=a.Scene.prototype.addGroup,a.Group.prototype.addParticleSystem=a.Group.prototype.addGroup}(GLGE),window.GLGE||(window.GLGE={}),function(a){a.Filter2d=function(){},a.Filter2d.prototype.renderDepth=!0,a.Filter2d.prototype.renderNormal=!0,a.Filter2d.prototype.passes=null,a.Filter2d.prototype.textures=null,a.Filter2d.prototype.uniforms=null,a.Filter2d.prototype.buffers=null,a.Filter2d.prototype.depthBufferWidth=null,a.Filter2d.prototype.depthBufferHeight=null,a.Filter2d.prototype.normalBufferWidth=null,a.Filter2d.prototype.normalBufferHeight=null,a.Filter2d.prototype.addTexture=function(a){this.textures||(this.textures=[]),this.textures.push(a)},a.Filter2d.prototype.removeTexture=function(a){var b=this.textures.indexOf(a);b>-1&&this.textures.splice(b,1)},a.Filter2d.prototype.createBuffer=function(a,b,c){b||(b=a.canvas.width),c||(c=a.canvas.height);var d=a.createFramebuffer(),e=a.createRenderbuffer(),f=a.createTexture();a.bindTexture(a.TEXTURE_2D,f);var g=new Uint8Array(b*c*4);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,g),a.bindFramebuffer(a.FRAMEBUFFER,d),a.bindRenderbuffer(a.RENDERBUFFER,e),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b,c),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,e),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,f,0),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null);return[d,e,f]},a.Filter2d.prototype.getFrameBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.buffers||(this.buffers=this.createBuffer(a));return this.buffers[0]},a.Filter2d.prototype.getDepthBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.depthBuffers||(this.depthBuffers=this.createBuffer(a,this.setDepthBufferWidth(),this.setDepthBufferHeight()));return this.depthBuffers[0]},a.Filter2d.prototype.setDepthBufferWidth=function(a){this.depthBufferWidth=a,this.depthBuffers=null},a.Filter2d.prototype.getDepthBufferWidth=function(){return this.depthBufferWidth?this.depthBufferWidth:this.gl.canvas.width},a.Filter2d.prototype.setDepthBufferHeight=function(a){this.depthBufferHeight=a,this.depthBuffers=null},a.Filter2d.prototype.getDepthBufferHeight=function(){return this.depthBufferHeight?this.depthBufferHeight:this.gl.canvas.height},a.Filter2d.prototype.setNormalBufferWidth=function(a){this.normalBufferWidth=a,this.normalBuffers=null},a.Filter2d.prototype.getNormalBufferWidth=function(){return this.normalBufferWidth?this.normalBufferWidth:this.gl.canvas.width},a.Filter2d.prototype.setNormalBufferHeight=function(a){this.normalBufferHeight=a,this.normalBuffers=null},a.Filter2d.prototype.getNormalBufferHeight=function(){return this.normalBufferHeight?this.normalBufferHeight:this.gl.canvas.height},a.Filter2d.prototype.getNormalBuffer=function(a){if(!this.passes)return null;this.gl||(this.gl=a),this.normalBuffers||(this.normalBuffers=this.createBuffer(a,this.getNormalBufferWidth(),this.getNormalBufferHeight()));return this.normalBuffers[0]},a.Filter2d.prototype.setUniform=function(a,b,c){this.uniforms||(this.uniforms={}),this.uniforms[b]={type:a,value:c}},a.Filter2d.prototype.getUniform=function(a){this.uniforms||(this.uniforms={});return this.uniforms[a].value},a.Filter2d.prototype.getUniformType=function(a){this.uniforms||(this.uniforms={});return this.uniforms[a].type},a.Filter2d.prototype.addPassFile=function(a){var b=new XMLHttpRequest,c=this;b&&(b.open("GET",a,!1),b.send(""),c.addPass(b.responseText))},a.Filter2d.prototype.addPass=function(a,b,c){this.passes||(this.passes=[]),this.passes.push({GLSL:a,height:c,width:b})},a.Filter2d.prototype.GLRender=function(b,c){c||(c=null);if(this.passes)for(var d=0;d<this.passes.length;d++){this.passes.length-1==d?b.bindFramebuffer(b.FRAMEBUFFER,c):(this.passes[d].buffer||(this.passes[d].buffer=this.createBuffer(b,this.passes[d].width,this.passes[d].height)),b.bindFramebuffer(b.FRAMEBUFFER,this.passes[d].buffer[0]));var e=this.passes[d].width?this.passes[d].width:b.canvas.width,f=this.passes[d].height?this.passes[d].height:b.canvas.height;b.viewport(0,0,e,f),b.clearDepth(1),b.depthFunc(b.LEQUAL),b.clearColor(0,0,0,0),b.clear(b.DEPTH_BUFFER_BIT),this.passes[d].program||(this.passes[d].program=this.GLCreateShader(b,this.passes[d].GLSL)),b.useProgram(this.passes[d].program);for(var g=0;g<8;g++)b.disableVertexAttribArray(g);attribslot=a.getAttribLocation(b,this.passes[d].program,"position"),this.posBuffer||this.createPlane(b),b.bindBuffer(b.ARRAY_BUFFER,this.posBuffer),b.enableVertexAttribArray(attribslot),b.vertexAttribPointer(attribslot,this.posBuffer.itemSize,b.FLOAT,!1,0,0),this.GLSetUniforms(b,d),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.GLfaces),b.drawElements(b.TRIANGLES,this.GLfaces.numItems,b.UNSIGNED_SHORT,0)}},a.Filter2d.prototype.GLSetUniforms=function(b,c){for(key in this.uniforms){var d=this.uniforms[key];d.type=="Matrix4fv"?a.setUniformMatrix(b,"Matrix4fv",a.getUniformLocation(b,this.passes[c].program,key),!1,d.value):a.setUniform(b,d.type,a.getUniformLocation(b,this.passes[c].program,key),d.value)}var e=1;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.buffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_RENDER"),0),this.renderDepth&&(b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.depthBuffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_DEPTH"),e),e++),this.renderNormal&&(b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.normalBuffers[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_NORMAL"),e),e++);for(var f=0;f<c;f++)b.activeTexture(b["TEXTURE"+e]),b.bindTexture(b.TEXTURE_2D,this.passes[f].buffer[2]),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"GLGE_PASS"+f),e),e++;this.textures||(this.textures=[]);for(var f=0;f<this.textures.length;f++)b.activeTexture(b["TEXTURE"+(f+e)]),this.textures[f].doTexture(b,null),a.setUniform(b,"1i",a.getUniformLocation(b,this.passes[c].program,"TEXTURE"+f),f+e)},a.Filter2d.prototype.createPlane=function(a){this.posBuffer||(this.posBuffer=a.createBuffer()),a.bindBuffer(a.ARRAY_BUFFER,this.posBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,.5,-1,1,.5,-1,-1,.5,1,-1,.5]),a.STATIC_DRAW),this.posBuffer.itemSize=3,this.posBuffer.numItems=4,this.GLfaces||(this.GLfaces=a.createBuffer()),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.GLfaces),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),a.STATIC_DRAW),this.GLfaces.itemSize=1,this.GLfaces.numItems=6},a.Filter2d.prototype.GLCreateShader=function(b,c){var d=[];d.push("attribute vec3 position;\n"),d.push("varying vec2 texCoord;\n"),d.push("void main(void){\n"),d.push("texCoord=(position.xy+vec2(1.0,1.0))/2.0;\n"),d.push("gl_Position = vec4(position.xyz,1.0);\n"),d.push("}\n");var e=a.getGLShader(b,b.VERTEX_SHADER,d.join("")),f=a.getGLShader(b,b.FRAGMENT_SHADER,c);return a.getGLProgram(b,e,f)}}(GLGE),typeof GLGE=="undefined"&&(GLGE={}),function(a){function c(a,b){var d=null;if(a.getAttribute("id")==b)return a;for(var e=0;e<a.childNodes.length;e++)if(a.childNodes[e].nodeType==1){d=c(a.childNodes[e],b);if(d!=null)break}return d}a.ColladaDocuments=[],a.Collada=function(){this.children=[],this.actions={},this.boneIdx=0,this.actionsIdx=0},a.augment(a.Group,a.Collada),a.Collada.prototype.type=a.G_NODE,a.Collada.prototype.useLights=!1,a.Collada.prototype.getAbsolutePath=function(a,b){if(a.substr(0,7)=="http://"||a.substr(0,7)=="file://"||a.substr(0,7)=="https://")return a;b||(b=window.location.href);var c=b.split("/"),d=c[2],e=c[0],f=[];for(var g=3;g<c.length-1;g++)f.push(c[g]);a.substr(0,1)=="/"&&(f=[]);var h=a.split("/");for(g=0;g<h.length;g++)h[g]==".."?f.pop():h[g]!=""&&f.push(h[g]);return e+"//"+d+"/"+f.join("/")},a.Collada.prototype.getElementById=function(a){if(!this.idcache){var b=this.getElementsByTagName("*"),c;this.idcache={};for(var d=0;d<b.length;d++)c=b[d].getAttribute("id"),c!=""&&(this.idcache[c]=b[d])}return this.idcache[a]},a.Collada.prototype.parseArray=function(a){var b,c=a.firstChild,d="",e=[],f,g;while(c){f=(d+c.nodeValue).replace(/\s+/g," ").replace(/^\s+/g,"").split(" "),c=c.nextSibling,f[0]==""&&f.unshift(),c&&(d=f.pop());for(g=0;g<f.length;g++)f[g]!=""&&e.push(f[g])}return e},a.Collada.prototype.setUseLights=function(a){this.useLights=a;return this},a.Collada.prototype.getUseLights=function(a){return this.useLights},a.Collada.prototype.setDocument=function(b,c){this.url=b,b.indexOf("#")!=-1&&(this.rootId=b.substr(b.indexOf("#")+1),b=b.substr(0,b.indexOf("#"))),c&&(b=this.getAbsolutePath(b,c)),this.docURL=b;if(a.ColladaDocuments[b])this.xml=a.ColladaDocuments[b];else{var d=new XMLHttpRequest;if(d){d.overrideMimeType("text/xml");var e=b,f=this;d.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?(this.responseXML.getElementById=f.getElementById,f.loaded(e,this.responseXML)):a.error("Error loading Document: "+e+" status "+this.status))},d.open("GET",b,!0),d.send("")}}},a.Collada.prototype.getSource=function(a){var b=this.xml.getElementById(a);if(!b)return[];if(!b.jsArray||this.badAccessor){var c;if(b.tagName=="vertices"){c=[];var d=b.getElementsByTagName("input");for(var e=0;e<d.length;e++)c[e]=this.getSource(d[e].getAttribute("source").substr(1)),c[e].block=d[e].getAttribute("semantic")}else{var f=b.getElementsByTagName("technique_common")[0].getElementsByTagName("accessor")[0],g=this.xml.getElementById(f.getAttribute("source").substr(1)),h=g.tagName;c=this.parseArray(g),stride=parseInt(f.getAttribute("stride")),offset=parseInt(f.getAttribute("offset")),offset||(offset=0),stride||(stride=1),count=parseInt(f.getAttribute("count"));var i=f.getElementsByTagName("param"),j=[];for(var e=0;e<i.length;e++)i[e].hasAttribute("name")||this.exceptions.badAccessor||this.badAccessor?j.push({type:i[e].getAttribute("type"),name:i[e].getAttribute("name")}):j.push(!1);c={array:c,stride:stride,offset:offset,count:count,pmask:j,type:h}}b.jsArray=c}return b.jsArray};var b={};a.Collada.prototype.getMeshes=function(c,d){b[this.url]||(b[this.url]=[]);if(b[this.url][c])return b[this.url][c];var e,f,g,h,i,j,l,m,n,o,p,q=this.xml.getElementById(c);if(!q){a.error("Collada.getMeshes returning [], id: "+c);return[]}var r=q.getElementsByTagName("mesh");if(!r){a.error("Collada.getMeshes returning [], id: "+c);return[]}meshNode=null,r.length?meshNode=r[0]:a.error("Collada.getMeshes returning [], id: "+c);var s=[];if(!meshNode)return s;var t=meshNode.getElementsByTagName("polylist");for(e=0;e<t.length;e++){m=this.parseArray(t[e].getElementsByTagName("p")[0]),vcount=this.parseArray(t[e].getElementsByTagName("vcount")[0]);var u=t[e].getElementsByTagName("input"),v=0;for(f=0;f<u.length;f++)v=Math.max(v,u[f].getAttribute("offset"));var w=[],x=0;for(f=0;f<vcount.length;f++){for(U=0;U<vcount[f]-2;U++){for(k=0;k<=v;k++)w.push(m[x+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+1)+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+2)+k])}x=x+(v+1)*vcount[f]}t[e].getElementsByTagName("p")[0].data=w}var y=meshNode.getElementsByTagName("polygons");for(e=0;e<y.length;e++){var z=y[e].getElementsByTagName("p"),w=[];for(var A=0;A<z.length;A++){var m=this.parseArray(z[A]),u=y[e].getElementsByTagName("input"),v=0;for(f=0;f<u.length;f++)v=Math.max(v,u[f].getAttribute("offset"));var x=0;for(U=0;U<m.length/(v+1)-2;U++){for(k=0;k<=v;k++)w.push(m[x+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+1)+k]);for(k=0;k<=v;k++)w.push(m[x+(v+1)*(U+2)+k])}x=x+(v+1)*(m.length/(v+1))}z.length>0&&(y[e].getElementsByTagName("p")[0].data=w)}var B=[],w=meshNode.getElementsByTagName("triangles");for(e=0;e<t.length;e++)B.push(t[e]);for(e=0;e<y.length;e++)y[e].getElementsByTagName("p").length>0&&B.push(y[e]);for(e=0;e<w.length;e++)B.push(w[e]);for(e=0;e<B.length;e++){h=B[e].getElementsByTagName("input"),j=[],l=[],i=[],n={};for(f=0;f<h.length;f++){h[f].data=this.getSource(h[f].getAttribute("source").substr(1)),o=h[f].getAttribute("semantic"),o=="TEXCOORD"&&(p=h[f].getAttribute("set"),p||(p=0),o=o+p);if(o=="VERTEX")for(var A=0;A<h[f].data.length;A++)n[h[f].data[A].block]=[];h[f].block=o,h[f].offset=parseInt(h[f].getAttribute("offset")),n[o]=[],i.push(h[f])}B[e].getElementsByTagName("p")[0].data?m=B[e].getElementsByTagName("p")[0].data:m=this.parseArray(B[e].getElementsByTagName("p")[0]);for(var f=0;f<i.length;f++)i[f].block!="VERTEX"&&(i[f].data=[i[f].data],i[f].data[0].block=i[f].block);var v=0;for(f=0;f<i.length;f++)v=Math.max(i[f].offset+1,v);for(U=0;U<m.length;U=U+v)for(f=0;f<i.length;f++)for(var A=0;A<i[f].data.length;A++){var o=i[f].data[A].block,C=i[f].data[A].stride;for(k=0;k<i[f].data[A].stride;k++)i[f].data[A].pmask[k]&&n[o].push(i[f].data[A].array[m[U+i[f].offset]*i[f].data[A].stride+k+i[f].data[A].offset]);if(d&&o=="POSITION")for(k=0;k<d.count;k++)j.push(d.vertexJoints[m[U+i[f].offset]*d.count+k]),l.push(d.vertexWeight[m[U+i[f].offset]*d.count+k]);o=="POSITION"&&C==1&&(n[o].push(0),n[o].push(0)),o=="POSITION"&&C==2&&n[o].push(0),o=="TEXCOORD0"&&C==3&&n[o].pop(),o=="TEXCOORD1"&&C==3&&n[o].pop()}m=[];var D=a.Mesh.WINDING_ORDER_UNKNOWN;if(n.NORMAL){D=a.Mesh.WINDING_ORDER_CLOCKWISE;for(f=0;f<n.POSITION.length;f=f+9){var E=a.subVec3([n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]],[n.POSITION[f+3],n.POSITION[f+4],n.POSITION[f+5]]),F=a.subVec3([n.POSITION[f+6],n.POSITION[f+7],n.POSITION[f+8]],[n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]]),G=a.crossVec3(F,E),I=0;for(var J=0;J<9;J+=3)G[0]*n.NORMAL[f+J]+G[1]*n.NORMAL[f+J+1]+G[2]*n.NORMAL[f+J+2]<0?I-=1:I+=1;if(I<0){var H=n.POSITION.length/3;m.push(f/3),m.push(f/3+2),m.push(f/3+1)}else m.push(f/3),m.push(f/3+1),m.push(f/3+2)}}else{n.NORMAL=[];for(f=0;f<n.POSITION.length;f=f+9){var E=a.subVec3([n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]],[n.POSITION[f+3],n.POSITION[f+4],n.POSITION[f+5]]),F=a.subVec3([n.POSITION[f+6],n.POSITION[f+7],n.POSITION[f+8]],[n.POSITION[f],n.POSITION[f+1],n.POSITION[f+2]]),G=a.toUnitVec3(a.crossVec3(a.toUnitVec3(F),a.toUnitVec3(E)));n.NORMAL.push(G[0]),n.NORMAL.push(G[1]),n.NORMAL.push(G[2]),n.NORMAL.push(G[0]),n.NORMAL.push(G[1]),n.NORMAL.push(G[2]),n.NORMAL.push(G[0]),n.NORMAL.push(G[1]),n.NORMAL.push(G[2]),console.log("Autogenerating normals, do not knnow facings")}var H=n.POSITION.length/3;for(f=0;f<H;f++)m.push(f)}function K(a,b){return a>b?b:a}var L=21843;L*=3;var M=(m.length-m.length%L)/L+(m.length%L?1:0),N=[],O=3,P=3,Q=2;for(var R=0;R<M;++R)N.push(new a.Mesh(undefined,D)),N[R].setPositions(n.POSITION.slice(L*R*O,K(L*O*(R+1),n.POSITION.length))),N[R].setNormals(n.NORMAL.slice(L*R*P,K(L*(R+1)*P,n.POSITION.length))),n.TEXCOORD0&&N[R].setUV(n.TEXCOORD0.slice(L*R*Q,K(L*(R+1)*Q,n.TEXCOORD0.length))),!n.TEXCOORD0&&n.TEXCOORD1&&N[R].setUV(n.TEXCOORD1.slice(L*R*Q,K(L*(R+1)*Q,n.TEXCOORD1.length))),n.TEXCOORD1&&N[R].setUV2(n.TEXCOORD1.slice(L*R*Q,K(L*(R+1)*Q,n.TEXCOORD1.length)));if(d){if(d.count>8){var S=[],T=[];for(var U=0;U<l.length;U=U+d.count){var V=[];for(k=0;k<d.count;k++)V.push({weight:l[U+k],joint:j[U+k]});V.sort(function(a,b){return parseFloat(b.weight)-parseFloat(a.weight)});for(k=0;k<8;k++)S.push(V[k].joint),T.push(V[k].weight)}j=S,l=T,d.count=8}for(var R=0;R<M;++R){N[R].setJoints(d.joints),N[R].setInvBindMatrix(d.inverseBindMatrix);var W=K(L*(R+1)*d.count,j.length),X=L*R*d.count;N[R].setVertexJoints(j.slice(X,W),d.count),N[R].setVertexWeights(l.slice(X,W),d.count)}}for(var R=0;R<M;++R)N[R].setFaces(m.slice(0,K(L*(R+1),m.length)-L*R)),N[R].matName=B[e].getAttribute("material"),s.push(N[R])}b[this.url][c]=s;return s},a.Collada.prototype.getFloat4=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("float4")[0].firstChild.nodeValue;return null},a.Collada.prototype.getFloat=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("float")[0].firstChild.nodeValue;return null},a.Collada.prototype.getSampler=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("sampler2D")[0].getElementsByTagName("source")[0].firstChild.nodeValue;return null},a.Collada.prototype.getSurface=function(a,b){var c=a.getElementsByTagName("newparam");for(var d=0;d<c.length;d++)if(c[d].getAttribute("sid")==b)return c[d].getElementsByTagName("surface")[0].getElementsByTagName("init_from")[0].firstChild.nodeValue;return null},a.Collada.prototype.getImage=function(a){var b=this.xml.getElementById(a);if(b)return this.getAbsolutePath(b.getElementsByTagName("init_from")[0].firstChild.nodeValue,this.docURL)},a.Collada.prototype.createMaterialLayer=function(b,c,d,e,f){var g,h=this.getSurface(d,this.getSampler(d,b.getAttribute("texture")));h||(h=b.getAttribute("texture")),g=this.getImage(h);var i=new a.Texture;i.setSrc(g),c.addTexture(i);var j=new a.MaterialLayer;j.setTexture(i),j.setMapto(e),b.hasAttribute("texcoord")&&f[b.getAttribute("texcoord")]?f[b.getAttribute("texcoord")]==1?j.setMapinput(a.UV2):f[b.getAttribute("texcoord")]==0?j.setMapinput(a.UV1):(a.error("GLGE only supports 2 texture sets\n"),j.setMapinput(a.UV1)):(a.error("Collada material does not specify texture coordinates, but it may have them: defaulting to set 0\n"),j.setMapinput(a.UV1));if(b.getElementsByTagName("blend_mode")[0])var k=b.getElementsByTagName("blend_mode")[0].firstChild.nodeValue;k=="MULTIPLY"&&j.setBlendMode(a.BL_MUL),c.addMaterialLayer(j)};var d={};a.Collada.prototype.getMaterial=function(b,e){d[this.url]||(d[this.url]={});if(d[this.url][b])return d[this.url][b];var f=this.xml.getElementsByTagName("library_materials")[0],g=c(f,b);if(!g){var h=new a.Material;d[this.url][b]=h;return h}var i=g.getElementsByTagName("instance_effect")[0].getAttribute("url").substr(1),j=this.xml.getElementById(i),k=j.getElementsByTagName("profile_COMMON")[0],l=k.getElementsByTagName("technique")[0],h=new a.Material;h.setSpecular(0),d[this.url][b]=h;var m,n,o=l.getElementsByTagName("ambient");if(o.length>0){m=o[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" "),h.setAmbient({r:n[0],g:n[1],b:n[2]});break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" "),h.setAmbient({r:n[0],g:n[1],b:n[2]});break;case"texture":this.createMaterialLayer(m,h,k,a.M_AMBIENT,e)}while(m=m.nextSibling)}var p=l.getElementsByTagName("diffuse");if(p.length>0){m=p[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" "),h.setColor({r:n[0],g:n[1],b:n[2]});break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" "),h.setColor({r:n[0],g:n[1],b:n[2]});break;case"texture":this.createMaterialLayer(m,h,k,a.M_COLOR,e)}while(m=m.nextSibling)}var q=l.getElementsByTagName("bump");if(q.length>0){m=q[0].firstChild;do switch(m.tagName){case"texture":this.createMaterialLayer(m,h,k,a.M_NOR,e)}while(m=m.nextSibling)}var r=l.getElementsByTagName("shininess");if(r.length>0){h.setSpecular(1),m=l.getElementsByTagName("shininess")[0].firstChild;do switch(m.tagName){case"float":parseFloat(m.firstChild.nodeValue)>1?h.setShininess(parseFloat(m.firstChild.nodeValue)):h.setShininess(parseFloat(m.firstChild.nodeValue)*128);break;case"param":var s=parseFloat(this.getFloat(k,m.getAttribute("ref")));s>1?h.setShininess(s):h.setShininess(s*128);break;case"texture":this.createMaterialLayer(m,h,k,a.M_SHINE,e)}while(m=m.nextSibling)}var t=l.getElementsByTagName("specular");if(t.length>0){h.setSpecular(1),m=t[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" "),h.setSpecularColor({r:n[0],g:n[1],b:n[2]});break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" "),h.setSpecularColor({r:n[0],g:n[1],b:n[2]});break;case"texture":this.createMaterialLayer(m,h,k,a.M_SPECCOLOR,e)}while(m=m.nextSibling)}var u=l.getElementsByTagName("emission");if(u.length>0){m=u[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.split(" "),h.setEmit(n[0]);break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).split(" "),h.setEmit(n[0]);break;case"texture":this.createMaterialLayer(m,h,k,a.M_EMIT,e)}while(m=m.nextSibling)}var v=l.getElementsByTagName("reflective");if(v.length>0){m=v[0].firstChild;do switch(m.tagName){case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" ");break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" ");break;case"texture":this.createMaterialLayer(m,h,k,a.M_REFLECT,e)}while(m=m.nextSibling)}var w=l.getElementsByTagName("transparency");if(w.length>0){m=w[0].firstChild;do switch(m.tagName){case"float":break;case"param":}while(m=m.nextSibling)}var x=l.getElementsByTagName("transparent");if(x.length>0){var y=x[0].getAttribute("opaque");y||(y="A_ONE"),m=x[0].firstChild;do switch(m.tagName){case"float":var z=parseFloat(m.firstChild.nodeValue);z<1&&(h.setAlpha(parseFloat(m.firstChild.nodeValue)),h.trans=!0);break;case"color":n=m.firstChild.nodeValue.replace(/\s+/g," ").split(" ");var z=this.getMaterialAlpha(n,y,1);z<1&&(h.setAlpha(z),h.trans=!0);break;case"param":n=this.getFloat4(k,m.getAttribute("ref")).replace(/\s+/g," ").split(" ");var z=this.getMaterialAlpha(n,y,1);z<1&&(h.setAlpha(z),h.trans=!0);break;case"texture":this.createMaterialLayer(m,h,k,a.M_ALPHA,e),h.trans=!0}while(m=m.nextSibling)}return h},a.Collada.prototype.getMaterialAlpha=function(a,b,c){var d;switch(b){case"A_ONE":d=parseFloat(a[3])*c;break;case"A_ZERO":d=1-parseFloat(a[3])*c;break;case"RGB_ONE":var e=parseFloat(a[0])*.212671+parseFloat(a[1])*.71516+parseFloat(a[2])*.072169;d=e*c;break;case"RGB_ZERO":var e=parseFloat(a[0])*.212671+parseFloat(a[1])*.71516+parseFloat(a[2])*.072169;d=1-e*c}return d},a.Collada.prototype.setMaterialOntoMesh=function(b,c){var d=c.getElementsByTagName("instance_material"),e={};for(var f=0;f<d.length;f++){var g=d[f].getElementsByTagName("bind_vertex_input"),h={};for(var i=0;i<g.length;i++)if(g[i].hasAttribute("input_set"))h[g[i].getAttribute("semantic")]=g[i].getAttribute("input_set");else{function j(a){var b="";for(var c=a.length-1;c>=0;--c)a[c]>="0"&&a[c]<="9"&&(b=a[c]+b);if(b.length==0)return"0";return b}h[g[i].getAttribute("semantic")]=j(g[i].getAttribute("semantic"))}mat=this.getMaterial(d[f].getAttribute("target").substr(1),h),e[d[f].getAttribute("symbol")]=mat}var k=new a.Object;for(f=0;f<b.length;f++){e[b[f].matName]&&e[b[f].matName].trans&&(k.setZtransparent(!0),k.setPickable(!1));var l=new a.MultiMaterial;l.setMesh(b[f]),e[b[f].matName]||(e[b[f].matName]=new a.Material,e[b[f].matName].setColor("lightgrey")),l.setMaterial(e[b[f].matName]),k.addMultiMaterial(l)}k.setSkeleton(this),c.GLGEObj=k},a.Collada.prototype.getInstanceGeometry=function(b){if(b.GLGEObj&&!1){var c=new a.ObjectInstance;c.setObject(b.GLGEObj);return c}var d=this.getMeshes(b.getAttribute("url").substr(1));this.setMaterialOntoMesh(d,b);return b.GLGEObj},a.Collada.prototype.getAnimationSampler=function(b,c){var d=30,e=this.xml.getElementById(b).getElementsByTagName("input"),f={},g=[],h,i;for(var j=0;j<e.length;j++)h=this.getSource(e[j].getAttribute("source").substr(1)),i=e[j].getAttribute("semantic"),g.push({block:i,data:h});for(n=0;n<g.length;n++){i=g[n].block,f[i]={},f[i].data=[],f[i].names=[];for(k=0;k<g[n].data.array.length;k=k+g[n].data.stride){var l=0;for(j=0;j<g[n].data.pmask.length;j++)if(g[n].data.pmask[j]){f[i].names.push(g[n].data.pmask[j].name);if(g[n].data.pmask[j].type=="float4x4"){f[i].stride=16;for(p=0;p<16;p++)f[i].data.push(g[n].data.array[p+k+g[n].data.offset+j])}else l++,f[i].stride=l,f[i].data.push(g[n].data.array[k+g[n].data.offset+j])}}}var m,o=[];for(var j=0;j<f.OUTPUT.stride;j++)o.push(new a.AnimationCurve);for(var j=0;j<f.INPUT.data.length;j++)for(var p=0;p<f.OUTPUT.stride;p++){o[p].name=f.OUTPUT.names[p],f.INTERPOLATION&&f.INTERPOLATION.data[j]=="BEZIER"&&!f.IN_TANGENT&&(f.INTERPOLATION.data[j]="LINEAR");if(!f.INTERPOLATION||f.INTERPOLATION.data[j]=="LINEAR"){m=new a.LinearPoint,m.setX(f.INPUT.data[j]*d);var q=parseFloat(f.OUTPUT.data[j*f.OUTPUT.stride+p]);q==-180&&(q=-179.9),q==180&&(q=179.9),this.exceptions.flipangle&&c&&(o[p].lastval&&(Math.abs(o[p].lastval-(360+q))<Math.abs(o[p].lastval-q)?q=360+q:Math.abs(o[p].lastval-(q-360))<Math.abs(o[p].lastval-q)&&(q=q-360))),m.setY(q),o[p].lastval=q,o[p].addPoint(m)}f.INTERPOLATION&&f.INTERPOLATION.data[j]=="BEZIER"&&(m=new a.BezTriple,m.setX1(f.IN_TANGENT.data[(j*f.OUTPUT.stride+p)*2]*d),m.setY1(f.IN_TANGENT.data[(j*f.OUTPUT.stride+p)*2+1]),m.setX2(Math.round(f.INPUT.data[j]*d)),m.setY2(f.OUTPUT.data[j*f.OUTPUT.stride+p]),m.setX3(f.OUT_TANGENT.data[(j*f.OUTPUT.stride+p)*2]*d),m.setY3(f.OUT_TANGENT.data[(j*f.OUTPUT.stride+p)*2+1]),o[p].addPoint(m))}return o},a.Collada.prototype.getAnimationVector=function(b){var c=0,d=this.xml.getElementById(b[0].target[0]),e=d.firstChild,f=[],g={};do{switch(e.tagName){case"matrix":case"translate":case"rotate":case"scale":def={type:e.tagName,data:this.parseArray(e),animations:[]},e.hasAttribute("sid")&&(g[e.getAttribute("sid")]=def),f.push(def)}e=e.nextSibling}while(e);var h={};for(var i=0;i<b.length;i++){var j=b[i].target,k=this.getAnimationSampler(b[i].source,/ANGLE/i.test(j));for(n=0;n<k.length;n++)c=Math.max(c,k[n].keyFrames[k[n].keyFrames.length-1].x);if(j[1].indexOf(".")!=-1){var l=j[1].split(".");switch(l[1]){case"X":g[l[0]].animations[0]=k[0];break;case"Y":g[l[0]].animations[1]=k[0];break;case"Z":g[l[0]].animations[2]=k[0];break;case"ANGLE":g[l[0]].animations[3]=k[0]}}else if(j[1].indexOf("(")!=-1){var m=j[1].split("(");sidtarget=m.shift(),m.length>1?m=parseInt(m[0])+4*parseInt(m[1]):m=parseInt(m[0]),g[sidtarget].animations[m]=k[0]}else for(var n=0;n<k.length;n++)switch(k[n].name){case"X":g[j[1]].animations[0]=k[n];break;case"Y":g[j[1]].animations[1]=k[n];break;case"Z":g[j[1]].animations[2]=k[n];break;case"ANGLE":g[j[1]].animations[3]=k[n];break;default:g[j[1]].animations[n]=k[n]}}var o=new a.AnimationVector;o.setFrames(c);var p=new a.AnimationCurve;p.setChannel("QuatX");var q=new a.AnimationCurve;q.setChannel("QuatY");var r=new a.AnimationCurve;r.setChannel("QuatZ");var s=new a.AnimationCurve;s.setChannel("QuatW");var t=new a.AnimationCurve;t.setChannel("LocX");var u=new a.AnimationCurve;u.setChannel("LocY");var v=new a.AnimationCurve;v.setChannel("LocZ");var w=new a.AnimationCurve;w.setChannel("ScaleX");var x=new a.AnimationCurve;x.setChannel("ScaleY");var y=new a.AnimationCurve;y.setChannel("ScaleZ"),o.addAnimationCurve(p),o.addAnimationCurve(q),o.addAnimationCurve(r),o.addAnimationCurve(s),o.addAnimationCurve(t),o.addAnimationCurve(u),o.addAnimationCurve(v),o.addAnimationCurve(w),o.addAnimationCurve(x),o.addAnimationCurve(y);var z=null;for(var A=0;A<c;A++){var B=a.identMatrix();for(var i=0;i<f.length;i++)switch(f[i].type){case"matrix":var C=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2],f[i].animations[3]?f[i].animations[3].getValue(A):f[i].data[3],f[i].animations[4]?f[i].animations[4].getValue(A):f[i].data[4],f[i].animations[5]?f[i].animations[5].getValue(A):f[i].data[5],f[i].animations[6]?f[i].animations[6].getValue(A):f[i].data[6],f[i].animations[7]?f[i].animations[7].getValue(A):f[i].data[7],f[i].animations[8]?f[i].animations[8].getValue(A):f[i].data[8],f[i].animations[9]?f[i].animations[9].getValue(A):f[i].data[9],f[i].animations[10]?f[i].animations[10].getValue(A):f[i].data[10],f[i].animations[11]?f[i].animations[11].getValue(A):f[i].data[11],f[i].animations[12]?f[i].animations[12].getValue(A):f[i].data[12],f[i].animations[13]?f[i].animations[13].getValue(A):f[i].data[13],f[i].animations[14]?f[i].animations[14].getValue(A):f[i].data[14],f[i].animations[15]?f[i].animations[15].getValue(A):f[i].data[15]];B=a.mulMat4(B,a.Mat4(C));break;case"rotate":var D=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2],f[i].animations[3]?f[i].animations[3].getValue(A):f[i].data[3]];B=a.mulMat4(B,a.angleAxis(D[3]*.017453278,[D[0],D[1],D[2]]));break;case"translate":var E=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2]];B=a.mulMat4(B,a.translateMatrix(E[0],E[1],E[2]));break;case"scale":var F=[f[i].animations[0]?f[i].animations[0].getValue(A):f[i].data[0],f[i].animations[1]?f[i].animations[1].getValue(A):f[i].data[1],f[i].animations[2]?f[i].animations[2].getValue(A):f[i].data[2]];B=a.mulMat4(B,a.scaleMatrix(F[0],F[1],F[2]))}scale=a.matrix2Scale(B),B=a.mulMat4(B,a.scaleMatrix(1/scale[0],1/scale[1],1/scale[2])),quat=a.rotationMatrix2Quat(B),z&&(z[0]*quat[0]+z[1]*quat[1]+z[2]*quat[2]+z[3]*quat[3]<0&&(quat[0]=quat[0]*-1,quat[1]=quat[1]*-1,quat[2]=quat[2]*-1,quat[3]=quat[3]*-1)),z=quat,point=new a.LinearPoint,point.setX(A),point.setY(quat[0]),p.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(quat[1]),q.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(quat[2]),r.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(quat[3]),s.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(B[3]),t.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(B[7]),u.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(B[11]),v.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(scale[0].toFixed(4)),w.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(scale[1].toFixed(4)),x.addPoint(point),point=new a.LinearPoint,point.setX(A),point.setY(scale[2].toFixed(4)),y.addPoint(point)}return o};var e={};a.Collada.prototype.getAnimations=function(){if(e[this.url])this.actions=e[this.url];else{var b=this.xml.getElementsByTagName("animation_clip"),c=this.xml.getElementsByTagName("animation");if(b.length==0){c.name="default";var d=[c]}else{var d=[];for(var f=0;f<b.length;f++){var g=[],h=b[f].getElementsByTagName("instance_animation");for(var i=0;i<h.length;i++)g.push(this.xml.getElementById(h[i].getAttribute("url").substr(1)));g.name=b[f].getAttribute("id"),d.push(g)}}for(var j=0;j<d.length;j++){var c=d[j],k,l,m,o={};for(var f=0;f<c.length;f++){k=c[f].getElementsByTagName("channel");for(var i=0;i<k.length;i++){var l=k[i].getAttribute("target").split("/");m=k[i].getAttribute("source").substr(1),o[l[0]]||(o[l[0]]=[]),o[l[0]].push({source:m,target:l})}}var p=new a.Action;for(l in o){var q=this.getAnimationVector(o[l]),r=this.xml.getElementById(l);for(var f=0;f<r.GLGEObjects.length;f++){var s=new a.ActionChannel,t=r.GLGEObjects[f].getName();s.setTarget(t),s.setAnimation(q),p.addActionChannel(s)}}this.addColladaAction({name:c.name,action:p})}}e[this.url]=this.actions;for(n in this.actions){this.setAction(this.actions[n],0,!0);break}},a.Collada.prototype.addColladaAction=function(a){this.actions[a.name]=a.action},a.Collada.prototype.getColladaActions=function(){return this.actions},a.Collada.prototype.getInstanceController=function(b){var c=new a.Object,d=this.xml.getElementById(b.getAttribute("url").substr(1)),e=b.getElementsByTagName("skeleton"),f=d.getElementsByTagName("joints")[0],g=f.getElementsByTagName("input"),h;d.getElementsByTagName("bind_shape_matrix").length>0?h=this.parseArray(d.getElementsByTagName("bind_shape_matrix")[0]):h=a.identMatrix();var i=[h],j=new a.Group;this.addGroup(j);var f=[j],k;for(var l=0;l<g.length;l++)if(g[l].getAttribute("semantic")=="JOINT"){var m=this.getSource(g[l].getAttribute("source").substr(1));if(m.type=="IDREF_array")for(var n=0;n<m.array.length;n=n+m.stride){var o=this.getNode(this.xml.getElementById(m.array[n]),!0),p=o.getName();this.xml.getElementById(m.array[n])||(i=[h=a.identMatrix()]),f.push(p)}else if(m.type=="Name_array"){var q={},r,p;if(e.length==0){var s=this.xml.getElementsByTagName("node");for(n=0;n<s.length;n++)r=s[n].getAttribute("sid"),r&&(q[r]=s[n]),p=s[n].getAttribute("name"),p&&!q[p]&&(q[p]=s[n])}else for(var t=0;t<e.length;t++){var u=this.xml.getElementById(e[t].firstChild.nodeValue.substr(1));r=u.getAttribute("sid"),r&&(q[r]=u);var s=u.getElementsByTagName("*");for(n=0;n<s.length;n++)r=s[n].getAttribute("sid"),r&&(q[r]=s[n]),p=s[n].getAttribute("name"),p&&!q[p]&&(q[p]=s[n])}for(var n=0;n<m.array.length;n=n+m.stride)if(m.array[n]!=""){var p=this.getNode(q[m.array[n]],!0).getName();f.push(p)}}}for(var l=0;l<g.length;l++)if(g[l].getAttribute("semantic")=="INV_BIND_MATRIX"){var v=this.getSource(g[l].getAttribute("source").substr(1));for(var n=0;n<v.array.length;n=n+v.stride)k=v.array.slice(n,n+16),i.push(a.mulMat4(a.Mat4(k),a.Mat4(h.slice(0,16))))}var w=d.getElementsByTagName("vertex_weights")[0];g=w.getElementsByTagName("input");var x=[],y={};for(t=0;t<g.length;t++){D=g[t].getAttribute("semantic"),g[t].data=this.getSource(g[t].getAttribute("source").substr(1)),g[t].block=D,y[D]=[];var z=g[t].getAttribute("offset");x[z]||(x[z]=[]),x[z].push(g[t])}var A=this.parseArray(w.getElementsByTagName("vcount")[0]),B=this.parseArray(w.getElementsByTagName("v")[0]),C=0;for(var l=0;l<A.length;l++)A[l]&&(C=Math.max(C,parseInt(A[l])));vPointer=0;var D;for(var l=0;l<A.length;l++){for(var E=0;E<A[l];E++)for(var n=0;n<x.length;n++)for(var F=0;F<x[n].length;++F){D=x[n][F].block;for(t=0;t<x[n][F].data.stride;t++)x[n][F].data.pmask[t]&&(D!="JOINT"?y[D].push(x[n][F].data.array[parseInt(B[vPointer])+parseInt(x[n][F].data.offset)]):y[D].push(parseInt(B[vPointer])),vPointer++)}for(E=E;E<C;E++)for(var n=0;n<x.length;n++)for(var F=0;F<x[n].length;++F)D=x[n][F].block,y[D].push(0)}if(!this.badAccessor&&y.JOINT.length==0){this.badAccessor=!0;return this.getInstanceController(b)}for(var l=0;l<y.JOINT.length;l++)y.JOINT[l]++;if(this.exceptions.negjoints)for(var l=0;l<y.JOINT.length;l++)y.JOINT[l]==0&&(y.WEIGHT[l]=0);var G={vertexJoints:y.JOINT,vertexWeight:y.WEIGHT,joints:f,inverseBindMatrix:i,count:C},H=this.getMeshes(d.getElementsByTagName("skin")[0].getAttribute("source").substr(1),G);this.setMaterialOntoMesh(H,b);return b.GLGEObj},a.Collada.prototype.getInstanceLight=function(b){var c=b.getElementsByTagName("technique_common")[0].getElementsByTagName("*")[0],d=new a.Light,e=c.getElementsByTagName("color");if(e.length>0){var f=e[0].firstChild.nodeValue.split(" "),g="rgb("+(f[0]*255|0)+","+(f[1]*255|0)+","+(f[2]*255|0)+")";d.setColor(g)}switch(c.tagName){case"point":case"spot":d.setType(a.L_POINT);var h=c.getElementsByTagName("constant_attenuation");h.length>0&&d.setAttenuationConstant(parseFloat(h[0].firstChild.nodeValue));var i=c.getElementsByTagName("linear_attenuation");i.length>0&&d.setAttenuationLinear(parseFloat(i[0].firstChild.nodeValue));var j=c.getElementsByTagName("quadratic_attenuation");j.length>0&&d.setAttenuationQuadratic(parseFloat(j[0].firstChild.nodeValue));case"spot":d.setType(a.L_SPOT);var k=c.getElementsByTagName("falloff_exponent");if(k.length>0){var l=parseFloat(k[0].firstChild.nodeValue);l<1.0001&&(l*=128),d.setSpotExponent(l)}var m=c.getElementsByTagName("falloff_angle");m.length>0&&d.setSpotCosCutOff(Math.cos(parseFloat(m[0].firstChild.nodeValue)/180*Math.PI))}return d},a.Collada.prototype.getNode=function(b,c){if(!c&&b.GLGEObject){d=b.GLGEObject,delete this.GLGEObject;return d}if(c&&b&&b.GLGEObjects)return b.GLGEObjects[0];var d=new a.Group,e="bone"+ ++this.boneIdx;d.setName(e);if(!b)return d;b.GLGEObjects||(b.GLGEObjects=[]),b.GLGEObjects.push(d);var f=b.firstChild,g=a.identMatrix(),h;if(f)do switch(f.tagName){case"node":d.addGroup(this.getNode(f));break;case"instance_node":d.addGroup(this.getNode(this.xml.getElementById(f.getAttribute("url").substr(1))));break;case"instance_visual_scene":d.addGroup(this.getNode(this.xml.getElementById(f.getAttribute("url").substr(1))));break;case"instance_geometry":d.addObject(this.getInstanceGeometry(f));break;case"instance_controller":d.addObject(this.getInstanceController(f));break;case"instance_light":this.useLights&&d.addLight(this.getInstanceLight(this.xml.getElementById(f.getAttribute("url").substr(1))));break;case"matrix":g=this.parseArray(f);break;case"translate":h=this.parseArray(f),g=a.mulMat4(g,a.translateMatrix(h[0],h[1],h[2]));break;case"rotate":h=this.parseArray(f),g=a.mulMat4(g,a.angleAxis(h[3]*.017453278,[h[0],h[1],h[2]]));break;case"scale":h=this.parseArray(f),g=a.mulMat4(g,a.scaleMatrix(h[0],h[1],h[2]))}while(f=f.nextSibling);d.setLoc(g[3],g[7],g[11]);var i=a.Mat4([g[0],g[1],g[2],0,g[4],g[5],g[6],0,g[8],g[9],g[10],0,0,0,0,1]);d.setRotMatrix(i),c&&(b.GLGEObject=d);return d},a.Collada.prototype.initVisualScene=function(){if(this.rootId){var c=this.xml.getElementById(this.rootId);c?this.addGroup(this.getNode(c)):a.error("Asset "+this.rootId+" not found in document"+this.url)}else{var b=this.xml.getElementsByTagName("scene");b.length>0?this.addGroup(this.getNode(b[0])):a.error("Please indicate the asset to render in Collada Document"+this.url)}};var f={"default":{},"COLLADA Mixamo exporter":{badAccessor:!0},"Blender2.5":{flipangle:!0,negjoints:!0}};a.Collada.prototype.getExceptions=function(){if(this.xml.getElementsByTagName("authoring_tool").length>0&&this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue=="COLLADA Mixamo exporter")return f["COLLADA Mixamo exporter"];if(this.xml.getElementsByTagName("authoring_tool").length>0&&/Blender 2.5/.test(this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue))return f["Blender2.5"]},a.Collada.prototype.loaded=function(a,b){this.exceptions=f[b.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue],this.exceptions||(this.exceptions=f["default"]),this.xml=b,b.getElementsByTagName("authoring_tool").length>0&&(this.exceptions=f[b.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue]),this.exceptions=this.getExceptions(),this.exceptions||(this.exceptions=f["default"]),this.initVisualScene(),this.getAnimations(),this.fireEvent("loaded",{url:this.url})},a.Scene.prototype.addCollada=a.Scene.prototype.addGroup,a.Group.prototype.addCollada=a.Group.prototype.addGroup,a.Document&&(a.Document.prototype.getCollada=function(b){b.object||(b.object=new(a[this.classString(b.tagName)]),b.object.setDocument(b.getAttribute("document"),this.getAbsolutePath(this.rootURL,null)),b.removeAttribute("document"),this.setProperties(b));return b.object})}(GLGE);if(!GLGE)var GLGE={};(function(a){a.HeightMap=function(a,b,c,d,e,f,g,h,i){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=b,this.canvas.height=c,this.minX=d,this.maxX=e,this.minY=f,this.maxY=g,this.minZ=h,this.maxZ=i;var j=new Image;j.heightmap=this,j.onload=function(a){this.heightmap.context.drawImage(this,0,0),this.heightmap.data=this.heightmap.context.getImageData(0,0,this.heightmap.canvas.width,this.heightmap.canvas.height).data},j.src=a},a.HeightMap.prototype.canvas=null,a.HeightMap.prototype.context=null,a.HeightMap.prototype.minZ=null,a.HeightMap.prototype.maxZ=null,a.HeightMap.prototype.minY=null,a.HeightMap.prototype.maxY=null,a.HeightMap.prototype.minX=null,a.HeightMap.prototype.maxX=null,a.HeightMap.prototype.data=null,a.HeightMap.prototype.getPixelAt=function(a,b){return this.data?this.data[(this.canvas.width*b+a)*4]/255*(this.maxZ-this.minZ):0},a.HeightMap.prototype.getHeightAt=function(a,b){var c;if(this.lastx!=undefined&&a==this.lastx&&b==this.lasty)c=this.lastValue;else{var d=Math.round((a-this.minX)/(this.maxX-this.minX)*this.canvas.width),e=Math.round((b-this.minY)/(this.maxY-this.minY)*this.canvas.height);c=this.getPixelAt(d,e),this.lastValue=c}this.lastx=a,this.lasty=b;return c},a.KeyInput=function(){document.keyStates||(document.keyStates=[]),document.addEventListener("keydown",this.onKeyDown,!1),document.addEventListener("keyup",this.onKeyUp,!1)},a.KeyInput.prototype.isKeyPressed=function(a){return document.keyStates[a]?!0:!1};var b=null;a.KeyInput.prototype.onKeyDown=function(a){document.keyStates[a.keyCode]=!0},a.KeyInput.prototype.onKeyUp=function(a){document.keyStates[a.keyCode]=!1},a.MouseInput=function(a){this.element=a,this.element.mouseX=0,this.element.mouseY=0,this.element.buttonState||(this.element.buttonState=[]),a.addEventListener("mousemove",this.onMouseMove,!1),a.addEventListener("mousedown",this.onMouseDown,!1),a.addEventListener("mouseup",this.onMouseUp,!1)},a.MouseInput.prototype.element=null,a.MouseInput.prototype.onMouseMove=function(a){this.mouseX=a.clientX,this.mouseY=a.clientY},a.MouseInput.prototype.onMouseDown=function(a){this.buttonState[a.button]=!0},a.MouseInput.prototype.onMouseUp=function(a){this.buttonState[a.button]=!1},a.MouseInput.prototype.isButtonDown=function(a){return this.element.buttonState[a]?!0:!1},a.MouseInput.prototype.getMousePosition=function(){return{x:this.element.mouseX,y:this.element.mouseY}},a.MI_LEFT=0,a.MI_MIDDLE=1,a.MI_RIGHT=2,a.KI_BACKSPACE=8,a.KI_TAB=9,a.KI_ENTER=13,a.KI_SHIFT=16,a.KI_CTRL=17,a.KI_ALT=18,a.KI_PAUSE_BREAK=19,a.KI_CAPS_LOCK=20,a.KI_ESCAPE=27,a.KI_PAGE_UP=33,a.KI_PAGE_DOWN=34,a.KI_END=35,a.KI_HOME=36,a.KI_LEFT_ARROW=37,a.KI_UP_ARROW=38,a.KI_RIGHT_ARROW=39,a.KI_DOWN_ARROW=40,a.KI_INSERT=45,a.KI_DELETE=46,a.KI_0=48,a.KI_1=49,a.KI_2=50,a.KI_3=51,a.KI_4=52,a.KI_5=53,a.KI_6=54,a.KI_7=55,a.KI_8=56,a.KI_9=57,a.KI_A=65,a.KI_B=66,a.KI_C=67,a.KI_D=68,a.KI_E=69,a.KI_F=70,a.KI_G=71,a.KI_H=72,a.KI_I=73,a.KI_J=74,a.KI_K=75,a.KI_L=76,a.KI_M=77,a.KI_N=78,a.KI_O=79,a.KI_P=80,a.KI_Q=81,a.KI_R=82,a.KI_S=83,a.KI_T=84,a.KI_U=85,a.KI_V=86,a.KI_W=87,a.KI_X=88,a.KI_Y=89,a.KI_Z=90,a.KI_LEFT_WINDOW_KEY=91,a.KI_RIGHT_WINDOW_KEY=92,a.KI_SELECT_KEY=93,a.KI_NUMPAD_0=96,a.KI_NUMPAD_1=97,a.KI_NUMPAD_2=98,a.KI_NUMPAD_3=99,a.KI_NUMPAD_4=100,a.KI_NUMPAD_5=101,a.KI_NUMPAD_6=102,a.KI_NUMPAD_7=103,a.KI_NUMPAD_8=104,a.KI_NUMPAD_9=105,a.KI_MULTIPLY=106,a.KI_ADD=107,a.KI_SUBTRACT=109,a.KI_DECIMAL_POINT=110,a.KI_DIVIDE=111,a.KI_F1=112,a.KI_F2=113,a.KI_F3=114,a.KI_F4=115,a.KI_F5=116,a.KI_F6=117,a.KI_F7=118,a.KI_F8=119,a.KI_F9=120,a.KI_F10=121,a.KI_F11=122,a.KI_F12=123,a.KI_NUM_LOCK=144,a.KI_SCROLL_LOCK=145,a.KI_SEMI_COLON=186,a.KI_EQUAL_SIGN=187,a.KI_COMMA=188,a.KI_DASH=189,a.KI_PERIOD=190,a.KI_FORWARD_SLASH=191,a.KI_GRAVE_ACCENT=192,a.KI_OPEN_BRACKET=219,a.KI_BACK_SLASH=220,a.KI_CLOSE_BRAKET=221,a.KI_SINGLE_QUOTE=222,a.KI_SPACE=32})(GLGE),function(a){a.Wavefront=function(b){a.Assets.registerAsset(this,b),this.multimaterials=[],this.materials={},this.instances=[],this.queue=[]},a.augment(a.Object,a.Wavefront),a.Wavefront.prototype.getAbsolutePath=function(a,b){if(a.substr(0,7)=="http://"||a.substr(0,7)=="file://"||a.substr(0,7)=="https://")return a;b||(b=window.location.href);var c=b.split("/"),d=c[2],e=c[0],f=[];for(var g=3;g<c.length-1;g++)f.push(c[g]);a.substr(0,1)=="/"&&(f=[]);var h=a.split("/");for(g=0;g<h.length;g++)h[g]==".."?f.pop():h[g]!=""&&f.push(h[g]);return e+"//"+d+"/"+f.join("/")},a.Wavefront.prototype.loadMaterials=function(a){this.loading?this.queue.push(a):this.loadFile(a,null,function(a,b){this.parseMaterials(b.split("\n"));if(this.queue.length>0){var c=this.queue.pop();this.loadMaterial(c)}else this.parseMesh()})},a.Wavefront.prototype.parseMaterials=function(b){for(var c=0;c<b.length;c++){if(b[c].substr(0,6)=="newmtl"){var d=b[c].split(" "),e=new a.Material;this.materials[d[1]]=e,c++}var d=b[c].split(" ");if(d.length>1)switch(d[0]){case"Kd":e.setColorR(parseFloat(d[1])),e.setColorG(parseFloat(d[2])),e.setColorB(parseFloat(d[3]));break;case"Ks":e.setSpecularColor({r:parseFloat(d[1]),g:parseFloat(d[2]),b:parseFloat(d[3])});break;case"Ns":e.setShininess(parseFloat(d[1]));break;case"d":case"Tr":this.setZtransparent(!0),e.setAlpha(parseFloat(d[1]));break;case"map_Kd":var f=new a.MaterialLayer;f.setMapto(a.M_COLOR),f.setMapinput(a.UV1);var g=new a.Texture,h=1;while(d[h][0]=="-")h=h+2;g.setSrc(this.getAbsolutePath(d[h],this.relativeTo)),e.addTexture(g),f.setTexture(g),e.addMaterialLayer(f);case"map_Ks":case"map_spec":var f=new a.MaterialLayer;f.setMapto(a.M_SPECULAR),f.setMapinput(a.UV1);var g=new a.Texture,h=1;while(d[h][0]=="-")h=h+2;g.setSrc(this.getAbsolutePath(d[h],this.relativeTo)),e.addTexture(g),f.setTexture(g),e.addMaterialLayer(f);case"bump":case"map_bump":var f=new a.MaterialLayer;f.setMapto(a.M_NOR),f.setMapinput(a.UV1);var g=new a.Texture,h=1;while(d[h][0]=="-")h=h+2;g.setSrc(this.getAbsolutePath(d[h],this.relativeTo)),e.addTexture(g),f.setTexture(g),e.addMaterialLayer(f)}}},a.Wavefront.prototype.loadFile=function(b,c,d){this.relativeTo&&!c?c=this.relativeTo:this.relativeTo=b,this.loading=!0,d||(d=this.loaded),b=this.getAbsolutePath(b,c);var e=new XMLHttpRequest,f=this;e&&(e.overrideMimeType("text/plain"),e.onreadystatechange=function(){this.readyState==4&&(this.status==200||this.status==0?(f.loading=!1,d.call(f,b,this.responseText)):a.error("Error loading Document: "+b+" status "+this.status))},e.open("GET",b,!0),e.send(""))},a.Wavefront.prototype.setSrc=function(a,b){this.loadFile(a,b)},a.Wavefront.prototype.loaded=function(a,b){this.file=objArray=b.split("\n");var c=!1;for(var d=0;d<objArray.length;d++){var e=objArray[d].split(" ");e.length>1&&(e[0]=="mtllib"&&(c=!0,this.loadMaterials(e[1])))}c||this.parseMesh()},a.Wavefront.prototype.createMultiMaterial=function(b,c,d,e,f,g,h){var j=[],k=[],l=[],m=[],n=[];for(i=0;i<f.length;i++){var o=b[f[i]];n.indexOf(o)!=-1&&h?m.push(n.indexOf(o)):(n.push(o),m.push(n.length-1))}f=m;for(i=0;i<n.length;i++){var p=n[i].split("/");c[p[0]-1]||a.error(p[0]),j.push(c[p[0]-1][1]),j.push(c[p[0]-1][2]),j.push(c[p[0]-1][3]),p[1]&&(l.push(e[p[1]-1][1]),l.push(e[p[1]-1][2])),p[2]&&(k.push(d[p[2]-1][1]),k.push(d[p[2]-1][2]),k.push(d[p[2]-1][3]))}var q=new a.MultiMaterial,r=new a.Mesh;r.setPositions(j),l.length>0&&r.setUV(l),k.length>0&&r.setNormals(k),r.setFaces(f),q.setMesh(r),q.setMaterial(g),this.addMultiMaterial(q)},a.Wavefront.prototype.parseMesh=function(){objArray=this.file;var b=[],c=[],d=[],e=[],f=[],g=0,h=!0,i=new a.Material;for(var j=0;j<objArray.length;j++)if(objArray[j][0]!="#"){var k=objArray[j].split(" ");if(k.length>0)switch(k[0]){case"s":k[1]=="1"?h=!0:h=!1;case"o":e.length>0&&(this.createMultiMaterial(f,c,d,b,e,i,h),e=[],i=new a.Material);break;case"usemtl":e.length>0&&(this.createMultiMaterial(f,c,d,b,e,i,h),e=[]),i=this.materials[k[1]];break;case"v":c.push(k);break;case"vt":b.push(k);break;case"vn":d.push(k);break;case"f":var l=[];for(var m=1;m<k.length;m++){var n=f.indexOf(k[m]);if(n==-1||!h)f.push(k[m]),n=f.length-1;l.push(n)}for(m=0;m<l.length-2;m++)e.push(l[0]-g),e.push(l[1+m]-g),e.push(l[2+m]-g)}}this.createMultiMaterial(f,c,d,b,e,i,h)},a.Document.prototype.getWavefront=function(b){if(!b.object){var c=this.getAbsolutePath(this.rootURL,null);b.object=new(a[this.classString(b.tagName)]),b.object.setSrc(this.getAbsolutePath(b.getAttribute("src"),c)),b.removeAttribute("src"),this.setProperties(b)}return b.object}}(GLGE)